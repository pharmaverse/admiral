% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/derive_var_nfrlt.R
\name{derive_var_nfrlt}
\alias{derive_var_nfrlt}
\title{Derive Nominal Relative Time from First Dose (NFRLT)}
\usage{
derive_var_nfrlt(
  dataset,
  new_var = NFRLT,
  tpt_var = NULL,
  visit_day,
  first_dose_day = 1,
  treatment_duration = 0,
  range_method = "midpoint",
  set_values_to_na = NULL
)
}
\arguments{
\item{dataset}{Input dataset containing visit day variable and optionally
timepoint variable.

\describe{
\item{Permitted values}{A data frame or tibble}
\item{Default value}{none}
}}

\item{new_var}{Name of the new variable to create (unquoted). Default is
\code{NFRLT}.

\describe{
\item{Permitted values}{Unquoted variable name}
\item{Default value}{\code{NFRLT}}
}}

\item{tpt_var}{Timepoint variable containing descriptions like "Pre-dose",
"1H Post-dose", etc. (unquoted). If not provided or if the variable doesn't
exist in the dataset, only the visit day offset is calculated (timepoint
contribution is 0).

\describe{
\item{Permitted values}{Unquoted variable name (optional)}
\item{Default value}{\code{NULL}}
}}

\item{visit_day}{Visit day variable (unquoted). This should be the planned/
nominal visit day (e.g., \code{VISITDY}). Records with \code{NA} in this variable
will have NFRLT set to \code{NA}.

\describe{
\item{Permitted values}{Unquoted variable name}
\item{Default value}{none}
}}

\item{first_dose_day}{The day number considered as the first dose day.
Default is 1. For multiple-dose studies, this is typically Day 1.

\describe{
\item{Permitted values}{Numeric scalar (positive integer)}
\item{Default value}{\code{1}}
}}

\item{treatment_duration}{Duration of treatment in hours. Can be either:
\itemize{
\item A numeric scalar (used for all records), or
\item An unquoted variable name from the dataset (e.g., \code{EXDUR}) where each
record can have a different treatment duration
}

Passed to \code{convert_xxtpt_to_hours()}. Must be non-negative. Default is 0
hours (for instantaneous treatments like oral medications).

\describe{
\item{Permitted values}{Numeric scalar or unquoted variable name (non-negative)}
\item{Default value}{\code{0}}
}}

\item{range_method}{Method for converting time ranges to single values.
Options are "midpoint" (default), "start", or "end". Passed to
\code{convert_xxtpt_to_hours()}. For example, "0-6h" with midpoint returns 3,
with start returns 0, with end returns 6.

\describe{
\item{Permitted values}{Character scalar ("midpoint", "start", or "end")}
\item{Default value}{\code{"midpoint"}}
}}

\item{set_values_to_na}{An optional condition that marks derived NFRLT values
as \code{NA}. For example, \code{set_values_to_na = VISIT == "UNSCHEDULED"} will set
NFRLT to \code{NA} for all unscheduled visits. Can use any variables in the
dataset.

\describe{
\item{Permitted values}{Condition (optional)}
\item{Default value}{\code{NULL}}
}}
}
\value{
The input dataset with the new nominal relative time variable added.
}
\description{
Derives nominal/planned time from first dose in hours by combining visit day
information with timepoint descriptions. The function converts timepoint
strings to hours using \code{convert_xxtpt_to_hours()} and adds them to the
day-based offset.
}
\details{
The nominal relative time is calculated as:

\code{NFRLT = day_offset * 24 + timepoint_hours}

Where:
\itemize{
\item \code{day_offset} is calculated from \code{visit_day} and \code{first_dose_day}, accounting
for the absence of Day 0 in clinical trial convention
\item \code{timepoint_hours} is derived from the timepoint description using
\code{convert_xxtpt_to_hours()}, or 0 if \code{tpt_var} is not provided
}

\strong{Handling "No Day 0":}

In clinical trials, day numbering typically follows the convention:
..., Day -2, Day -1, Day 1, Day 2, ... (no Day 0). This function accounts
for this by adjusting the day offset when \code{visit_day} is negative and
\code{first_dose_day} is positive.

For example, with \code{first_dose_day = 1}:
\itemize{
\item Day -1 → -24 hours (1 day before Day 1, not 2 days)
\item Day -7 → -168 hours (7 days before Day 1)
\item Day 1 → 0 hours (first dose day)
\item Day 8 → 168 hours (7 days after Day 1)
}

With \code{first_dose_day = 7}:
\itemize{
\item Day -1 → -168 hours (7 days before Day 7, accounting for no Day 0)
\item Day 1 → -144 hours (6 days before Day 7)
\item Day 6 → -24 hours (1 day before Day 7)
\item Day 7 → 0 hours (first dose day)
}

\strong{Common Use Cases:}
\itemize{
\item \strong{Single dose study}: Day 1 only, with samples at various timepoints
(e.g., Pre-dose, 1H, 2H, 4H, 8H, 24H)
\item \strong{Multiple dose study}: Dosing on multiple days (e.g., Day 1, Day 8,
Day 15) with samples around each dose
\item \strong{Screening visits}: Negative visit days (e.g., Day -14, Day -7) before
first dose
\item \strong{Steady state study}: Multiple daily doses with sampling on specific
days
\item \strong{Oral medications}: Use default \code{treatment_duration = 0} for
instantaneous absorption
\item \strong{IV infusions}: Specify \code{treatment_duration} as infusion duration in
hours (scalar) or as a variable name containing duration per record
\item \strong{Exposure records (EX)}: Can be called without \code{tpt_var} to derive NFRLT
based only on visit day
\item \strong{Unscheduled visits}: Use \code{set_values_to_na} to set NFRLT to \code{NA} for
unscheduled or early discontinuation visits
\item \strong{Variable treatment durations}: Use a variable name (e.g., \code{EXDUR}) when
different subjects or visits have different treatment durations
}

\strong{Important Notes:}
\itemize{
\item The function assumes \code{visit_day} represents the nominal/planned day, not
the actual study day
\item Day numbering follows clinical trial convention with no Day 0
\item For timepoints that span multiple days (e.g., "24H Post-dose"), ensure
\code{visit_day} is set to the day when the sample was taken. For example, if
dosing occurs on Day 3, a "24H Post-dose" sample taken on Day 4 should
have \code{visit_day = 4}.
\item For crossover studies, consider deriving NFRLT separately per period
\item \code{NA} values in \code{visit_day} will automatically result in \code{NA} for NFRLT
(no need to use \code{set_values_to_na} for this case)
\item \code{NA} values in \code{tpt_var} will result in \code{NA} for NFRLT
\item \code{NA} values in the \code{treatment_duration} variable (if using a variable) will
result in \code{NA} for NFRLT for those records
\item Use \code{set_values_to_na} when you need to set NFRLT to \code{NA} based on other
variables (e.g., \code{VISIT == "UNSCHEDULED"}), especially when \code{visit_day}
is populated but should not be used for the NFRLT calculation
\item If \code{tpt_var} is not provided or doesn't exist in the dataset, timepoint
contribution is assumed to be 0 hours
}

\strong{Setting Special Values:}

If you need to set NFRLT to a specific value (e.g., 99999) for certain visits
instead of \code{NA}, use \code{set_values_to_na} first to set them to \code{NA}, then use
a subsequent \code{mutate()} call to replace those \code{NA} values:

\if{html}{\out{<div class="sourceCode r">}}\preformatted{dataset \%>\%
  derive_var_nfrlt(
    ...,
    set_values_to_na = VISIT == "UNSCHEDULED"
  ) \%>\%
  mutate(NFRLT = if_else(is.na(NFRLT) & VISIT == "UNSCHEDULED", 99999, NFRLT))
}\if{html}{\out{</div>}}
}
\seealso{
\code{\link[=convert_xxtpt_to_hours]{convert_xxtpt_to_hours()}}

BDS-Findings Functions that returns variable appended to dataset:
\code{\link{derive_basetype_records}()},
\code{\link{derive_var_analysis_ratio}()},
\code{\link{derive_var_anrind}()},
\code{\link{derive_var_atoxgr}()},
\code{\link{derive_var_atoxgr_dir}()},
\code{\link{derive_var_base}()},
\code{\link{derive_var_chg}()},
\code{\link{derive_var_ontrtfl}()},
\code{\link{derive_var_pchg}()},
\code{\link{derive_var_shift}()},
\code{\link{derive_vars_crit_flag}()}
}
\concept{der_bds_findings}
\keyword{der_bds_findings}
\keyword{experimental}
\section{Examples}{
\subsection{Single dose study}{

Day 1 only with oral medication

\if{html}{\out{<div class="sourceCode r">}}\preformatted{library(dplyr)
library(tibble)

adpc <- tribble(
  ~USUBJID, ~VISITDY, ~PCTPT,
  "001",    1,        "Pre-dose",
  "001",    1,        "1H Post-dose",
  "001",    1,        "2H Post-dose",
  "001",    1,        "4H Post-dose",
  "001",    1,        "24H Post-dose"
)

derive_var_nfrlt(
  adpc,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY
)
#> # A tibble: 5 × 4
#>   USUBJID VISITDY PCTPT         NFRLT
#>   <chr>     <dbl> <chr>         <dbl>
#> 1 001           1 Pre-dose          0
#> 2 001           1 1H Post-dose      1
#> 3 001           1 2H Post-dose      2
#> 4 001           1 4H Post-dose      4
#> 5 001           1 24H Post-dose    24}\if{html}{\out{</div>}}}
\subsection{Study with screening visits}{

Handling negative visit days (no Day 0 in clinical trials)

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_screen <- tribble(
  ~USUBJID, ~VISITDY, ~PCTPT,
  "001",    -14,      "Screening",
  "001",    -7,       "Pre-dose",
  "001",    -1,       "Pre-dose",
  "001",    1,        "Pre-dose",
  "001",    1,        "2H Post-dose"
)

derive_var_nfrlt(
  adpc_screen,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY
)
#> # A tibble: 5 × 4
#>   USUBJID VISITDY PCTPT        NFRLT
#>   <chr>     <dbl> <chr>        <dbl>
#> 1 001         -14 Screening     -336
#> 2 001          -7 Pre-dose      -168
#> 3 001          -1 Pre-dose       -24
#> 4 001           1 Pre-dose         0
#> 5 001           1 2H Post-dose     2}\if{html}{\out{</div>}}}
\subsection{Multiple dose study}{

Dosing on Days 1, 8, and 15

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_md <- tribble(
  ~USUBJID, ~VISITDY, ~PCTPT,
  "001",    1,        "Pre-dose",
  "001",    1,        "2H Post-dose",
  "001",    8,        "Pre-dose",
  "001",    8,        "2H Post-dose",
  "001",    15,       "Pre-dose",
  "001",    15,       "2H Post-dose"
)

derive_var_nfrlt(
  adpc_md,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY
)
#> # A tibble: 6 × 4
#>   USUBJID VISITDY PCTPT        NFRLT
#>   <chr>     <dbl> <chr>        <dbl>
#> 1 001           1 Pre-dose         0
#> 2 001           1 2H Post-dose     2
#> 3 001           8 Pre-dose       168
#> 4 001           8 2H Post-dose   170
#> 5 001          15 Pre-dose       336
#> 6 001          15 2H Post-dose   338}\if{html}{\out{</div>}}}
\subsection{Custom first dose day}{

First dose on Day 7 instead of Day 1

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_day7 <- tribble(
  ~USUBJID, ~VISITDY, ~PCTPT,
  "001",    -1,       "Pre-dose",
  "001",    1,        "Pre-dose",
  "001",    6,        "Pre-dose",
  "001",    7,        "Pre-dose",
  "001",    8,        "Pre-dose"
)

derive_var_nfrlt(
  adpc_day7,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY,
  first_dose_day = 7
)
#> # A tibble: 5 × 4
#>   USUBJID VISITDY PCTPT    NFRLT
#>   <chr>     <dbl> <chr>    <dbl>
#> 1 001          -1 Pre-dose  -168
#> 2 001           1 Pre-dose  -144
#> 3 001           6 Pre-dose   -24
#> 4 001           7 Pre-dose     0
#> 5 001           8 Pre-dose    24}\if{html}{\out{</div>}}}
\subsection{IV infusion with scalar treatment duration}{

2-hour infusion duration for all records

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_inf <- tribble(
  ~USUBJID, ~VISITDY, ~PCTPT,
  "001",    1,        "Pre-dose",
  "001",    1,        "EOI",
  "001",    1,        "1H Post EOI",
  "001",    1,        "10MIN PRE EOI"
)

derive_var_nfrlt(
  adpc_inf,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY,
  treatment_duration = 2
)
#> # A tibble: 4 × 4
#>   USUBJID VISITDY PCTPT         NFRLT
#>   <chr>     <dbl> <chr>         <dbl>
#> 1 001           1 Pre-dose       0   
#> 2 001           1 EOI            2   
#> 3 001           1 1H Post EOI    3   
#> 4 001           1 10MIN PRE EOI  1.83}\if{html}{\out{</div>}}}
\subsection{Variable treatment duration}{

Different treatment durations per subject using a variable

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_var_dur <- tribble(
  ~USUBJID, ~VISITDY, ~PCTPT,           ~EXDUR,
  "001",    1,        "Pre-dose",       1,
  "001",    1,        "EOI",            1,
  "001",    1,        "1H POST EOI",    1,
  "002",    1,        "Pre-dose",       2,
  "002",    1,        "EOI",            2,
  "002",    1,        "1H POST EOI",    2
)

derive_var_nfrlt(
  adpc_var_dur,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY,
  treatment_duration = EXDUR
)
#> # A tibble: 6 × 5
#>   USUBJID VISITDY PCTPT       EXDUR NFRLT
#>   <chr>     <dbl> <chr>       <dbl> <dbl>
#> 1 001           1 Pre-dose        1     0
#> 2 001           1 EOI             1     1
#> 3 001           1 1H POST EOI     1     2
#> 4 002           1 Pre-dose        2     0
#> 5 002           1 EOI             2     2
#> 6 002           1 1H POST EOI     2     3}\if{html}{\out{</div>}}}
\subsection{Exposure records without timepoint variable}{

Deriving NFRLT based only on visit day

\if{html}{\out{<div class="sourceCode r">}}\preformatted{ex <- tribble(
  ~USUBJID, ~VISITDY,
  "001",    1,
  "001",    8,
  "001",    15
)

derive_var_nfrlt(
  ex,
  new_var = NFRLT,
  visit_day = VISITDY
)
#> # A tibble: 3 × 3
#>   USUBJID VISITDY NFRLT
#>   <chr>     <dbl> <dbl>
#> 1 001           1     0
#> 2 001           8   168
#> 3 001          15   336}\if{html}{\out{</div>}}}
\subsection{Unscheduled visits}{

Setting NFRLT to NA for unscheduled visits

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_unsched <- tribble(
  ~USUBJID, ~VISITDY, ~VISIT,        ~PCTPT,
  "001",    1,        "VISIT 1",     "Pre-dose",
  "001",    1,        "VISIT 1",     "2H Post-dose",
  "001",    NA_real_, "UNSCHEDULED", "Pre-dose",
  "001",    NA_real_, "UNSCHEDULED", "2H Post-dose"
)

derive_var_nfrlt(
  adpc_unsched,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY,
  set_values_to_na = VISIT == "UNSCHEDULED"
)
#> # A tibble: 4 × 5
#>   USUBJID VISITDY VISIT       PCTPT        NFRLT
#>   <chr>     <dbl> <chr>       <chr>        <dbl>
#> 1 001           1 VISIT 1     Pre-dose         0
#> 2 001           1 VISIT 1     2H Post-dose     2
#> 3 001          NA UNSCHEDULED Pre-dose        NA
#> 4 001          NA UNSCHEDULED 2H Post-dose    NA}\if{html}{\out{</div>}}}
\subsection{Early discontinuation visits}{

Handling study drug early discontinuation

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_disc <- tribble(
  ~USUBJID, ~VISITDY, ~VISIT,                              ~PCTPT,
  "001",    1,        "VISIT 1",                           "Pre-dose",
  "001",    1,        "VISIT 1",                           "2H Post-dose",
  "001",    NA_real_, "STUDY DRUG EARLY DISCONTINUATION",  "Pre-dose"
)

derive_var_nfrlt(
  adpc_disc,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY,
  set_values_to_na = VISIT == "STUDY DRUG EARLY DISCONTINUATION"
)
#> # A tibble: 3 × 5
#>   USUBJID VISITDY VISIT                            PCTPT        NFRLT
#>   <chr>     <dbl> <chr>                            <chr>        <dbl>
#> 1 001           1 VISIT 1                          Pre-dose         0
#> 2 001           1 VISIT 1                          2H Post-dose     2
#> 3 001          NA STUDY DRUG EARLY DISCONTINUATION Pre-dose        NA}\if{html}{\out{</div>}}}
\subsection{Multiple exclusion criteria}{

Excluding multiple visit types

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_multi <- tribble(
  ~USUBJID, ~VISITDY, ~VISIT,                              ~PCTPT,
  "001",    1,        "VISIT 1",                           "Pre-dose",
  "001",    NA_real_, "UNSCHEDULED",                       "Pre-dose",
  "001",    NA_real_, "STUDY DRUG EARLY DISCONTINUATION",  "Pre-dose"
)

derive_var_nfrlt(
  adpc_multi,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY,
  set_values_to_na = VISIT \%in\% c("UNSCHEDULED", "STUDY DRUG EARLY DISCONTINUATION")
)
#> # A tibble: 3 × 5
#>   USUBJID VISITDY VISIT                            PCTPT    NFRLT
#>   <chr>     <dbl> <chr>                            <chr>    <dbl>
#> 1 001           1 VISIT 1                          Pre-dose     0
#> 2 001          NA UNSCHEDULED                      Pre-dose    NA
#> 3 001          NA STUDY DRUG EARLY DISCONTINUATION Pre-dose    NA}\if{html}{\out{</div>}}}
\subsection{Setting special values instead of NA}{

Using mutate to set NFRLT to 99999 for unscheduled visits

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_unsched_value <- tribble(
  ~USUBJID, ~VISITDY, ~VISIT,        ~PCTPT,
  "001",    1,        "VISIT 1",     "Pre-dose",
  "001",    1,        "VISIT 1",     "2H Post-dose",
  "001",    NA_real_, "UNSCHEDULED", "Pre-dose",
  "001",    NA_real_, "UNSCHEDULED", "2H Post-dose"
)

adpc_unsched_value \%>\%
  derive_var_nfrlt(
    new_var = NFRLT,
    tpt_var = PCTPT,
    visit_day = VISITDY,
    set_values_to_na = VISIT == "UNSCHEDULED"
  ) \%>\%
  mutate(
    NFRLT = if_else(is.na(NFRLT) & VISIT == "UNSCHEDULED", 99999, NFRLT)
  )
#> # A tibble: 4 × 5
#>   USUBJID VISITDY VISIT       PCTPT        NFRLT
#>   <chr>     <dbl> <chr>       <chr>        <dbl>
#> 1 001           1 VISIT 1     Pre-dose         0
#> 2 001           1 VISIT 1     2H Post-dose     2
#> 3 001          NA UNSCHEDULED Pre-dose     99999
#> 4 001          NA UNSCHEDULED 2H Post-dose 99999}\if{html}{\out{</div>}}}
\subsection{Custom range method}{

Using end of range instead of midpoint

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_range <- tribble(
  ~USUBJID, ~VISITDY, ~PCTPT,
  "001",    1,        "Pre-dose",
  "001",    1,        "0-6h Post-dose"
)

derive_var_nfrlt(
  adpc_range,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY,
  range_method = "end"
)
#> # A tibble: 2 × 4
#>   USUBJID VISITDY PCTPT          NFRLT
#>   <chr>     <dbl> <chr>          <dbl>
#> 1 001           1 Pre-dose           0
#> 2 001           1 0-6h Post-dose     6}\if{html}{\out{</div>}}}
\subsection{Alternative terminology}{

Using "Before" and "After" terminology

\if{html}{\out{<div class="sourceCode r">}}\preformatted{adpc_alt <- tribble(
  ~USUBJID, ~VISITDY, ~PCTPT,
  "001",    1,        "Before",
  "001",    1,        "1H After",
  "001",    1,        "2H After"
)

derive_var_nfrlt(
  adpc_alt,
  new_var = NFRLT,
  tpt_var = PCTPT,
  visit_day = VISITDY
)
#> # A tibble: 3 × 4
#>   USUBJID VISITDY PCTPT    NFRLT
#>   <chr>     <dbl> <chr>    <dbl>
#> 1 001           1 Before       0
#> 2 001           1 1H After     1
#> 3 001           1 2H After     2}\if{html}{\out{</div>}}}}

