<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Programming Concepts and Conventions • admiral</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Programming Concepts and Conventions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">admiral</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-get-started" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Get Started</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-get-started">
<li><a class="dropdown-item" href="../articles/admiral.html">Get Started</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/pharmaverse/admiral/blob/main/inst/cheatsheet/admiral_cheatsheet.pdf">Cheatsheet</a></li>
    <li><a class="dropdown-item" href="https://pharmaverse.github.io/admiraldiscovery/articles/presentation_archive.html">Presentation Archive</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-user-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">User Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-user-guides">
<li><h6 class="dropdown-header" data-toc-skip>General Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/concepts_conventions.html">Programming Concepts and Conventions</a></li>
    <li><a class="dropdown-item" href="../articles/generic.html">Generic Derivations</a></li>
    <li><a class="dropdown-item" href="../articles/higher_order.html">Higher Order Functions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>ADaM Script Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/adsl.html">Creating a Basic ADSL</a></li>
    <li><a class="dropdown-item" href="../articles/occds.html">Creating an OCCDS ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/bds_finding.html">Creating a BDS Findings ADAM</a></li>
    <li><a class="dropdown-item" href="../articles/bds_exposure.html">Creating a BDS Exposure ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/bds_tte.html">Creating a BDS Time-to-Event ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/questionnaires.html">Creating Questionnaire ADaMs</a></li>
    <li><a class="dropdown-item" href="../articles/pk_adnca.html">Creating a PK NCA or Population PK ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/hys_law.html">Hy's Law Implementation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Special Topics Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/imputation.html">Date and Time Imputation</a></li>
    <li><a class="dropdown-item" href="../articles/visits_periods.html">Visit and Period Variables</a></li>
    <li><a class="dropdown-item" href="../articles/queries_dataset.html">Queries Dataset Documentation</a></li>
    <li><a class="dropdown-item" href="../articles/lab_grading.html">Lab Grading</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/faq.html">FAQ</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="https://pharmaverse.github.io/admiraldiscovery/articles/reactable.html">🔎 Find my function</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://pharmaverse.slack.com/" aria-label="Slack"><span class="fa fa-slack"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/website-versions.html" aria-label="Previous Release Websites"><span class="fa fa-history"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pharmaverse/admiral/issues/new/choose" aria-label="New Issue"><span class="fa fa-bug"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pharmaverse/admiral/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Programming Concepts and Conventions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pharmaverse/admiral/blob/main/vignettes/concepts_conventions.Rmd" class="external-link"><code>vignettes/concepts_conventions.Rmd</code></a></small>
      <div class="d-none name"><code>concepts_conventions.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette aims to discuss some of the common programming concepts
and conventions that have been adopted within the <a href="https://pharmaverse.github.io/admiral/">admiral</a>
family of packages. It is intended to be a user-facing version of the <a href="https://pharmaverse.github.io/admiraldev/articles/programming_strategy.html">Programming
Strategy</a> vignette, but users can also read the latter after becoming
more familiar with the package to expand further on any topics of
interest. For some of common <a href="https://pharmaverse.github.io/admiral/">admiral</a> FAQ, visit the
corresponding FAQ page provided in the same drop down menu as this
vignette.</p>
</div>
<div class="section level2">
<h2 id="input-and-output">Input and Output<a class="anchor" aria-label="anchor" href="#input-and-output"></a>
</h2>
<p>It is expected that the input dataset is not grouped. Otherwise an
error is issued.</p>
<p>The output dataset is ungrouped. The observations are not ordered in
a dedicated way. In particular, the order of the observations of the
input dataset may not be preserved.</p>
</div>
<div class="section level2">
<h2 id="admiral-functions-and-options">
<code>{admiral}</code> Functions and Options<a class="anchor" aria-label="anchor" href="#admiral-functions-and-options"></a>
</h2>
<p>As a general principle, the behavior of the <a href="https://pharmaverse.github.io/admiral/">admiral</a>
functions is only determined by their input, not by any global object,
i.e. all inputs like datasets, variable names, options, etc. must be
provided to the function by arguments. Correspondingly, in general
functions do not have any side-effects like creating or modifying global
objects, printing, writing files, etc.</p>
<p>An exception to the above principle is found in our approach to
package options (see <code><a href="../reference/get_admiral_option.html">get_admiral_option()</a></code> and
<code><a href="../reference/set_admiral_options.html">set_admiral_options()</a></code>), which allow for user-defined
defaults on commonly used function arguments. For instance, the option
<code>subject_keys</code> is currently pre-defined as
<code>exprs(STUDYID, USUBJID)</code>, but can be modified using
<code>set_admiral_options(subject_keys = exprs(...))</code> at the top
of a script.</p>
<p>For a full discussion on admiral Inputs, Outputs and Options, see <a href="https://pharmaverse.github.io/admiraldev/articles/programming_strategy.html#input-output-and-side-effects">this
section</a> on our developer-facing Programming Strategy.</p>
</div>
<div class="section level2">
<h2 id="missing">Handling of Missing Values<a class="anchor" aria-label="anchor" href="#missing"></a>
</h2>
<p>When using the <a href="https://haven.tidyverse.org" class="external-link">haven</a> package to read SAS datasets into
R, SAS-style character missing values, i.e. <code>""</code>, are
<em>not</em> converted into proper R <code>NA</code> values. Rather they
are kept as is. This is problematic for any downstream data processing
as R handles <code>""</code> just as any other string. Thus, before any
data manipulation is being performed SAS blanks should be converted to R
<code>NA</code>s using <a href="https://pharmaverse.github.io/admiral/">admiral</a>’s
<code><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na()</a></code> function, e.g.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu">haven</span><span class="fu">::</span><span class="fu">read_sas</span><span class="op">(</span><span class="st">"dm.sas7bdat"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Note that any logical operator being applied to an <code>NA</code>
value <em>always</em> returns <code>NA</code> rather than
<code>TRUE</code> or <code>FALSE</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">visits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Baseline"</span>, <span class="cn">NA</span>, <span class="st">"Screening"</span>, <span class="st">"Week 1 Day 7"</span><span class="op">)</span></span>
<span><span class="va">visits</span> <span class="op">!=</span> <span class="st">"Baseline"</span></span>
<span><span class="co">#&gt; [1] FALSE    NA  TRUE  TRUE</span></span></code></pre></div>
<p>The only exception is <code><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na()</a></code> which returns
<code>TRUE</code> if the input is <code>NA</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">visits</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE  TRUE FALSE FALSE</span></span></code></pre></div>
<p>Thus, to filter all visits which are not <code>"Baseline"</code> the
following condition would need to be used.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">visits</span> <span class="op">!=</span> <span class="st">"Baseline"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">visits</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE  TRUE  TRUE  TRUE</span></span></code></pre></div>
<p>Also note that most aggregation functions, like <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>
or <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max()</a></code>, also return <code>NA</code> if any element of the
input vector is missing.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA</span></span></code></pre></div>
<p>To avoid this behavior one has to explicitly set
<code>na.rm = TRUE</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.5</span></span></code></pre></div>
<p>This is very important to keep in mind when using
<a href="https://pharmaverse.github.io/admiral/">admiral</a>’s aggregation functions such as
<code><a href="../reference/derive_summary_records.html">derive_summary_records()</a></code>.</p>
<p>For handling of <code>NA</code>s in sorting variables see <a href="generic.html#sort_order">Sort Order</a>.</p>
</div>
<div class="section level2">
<h2 id="exprs">Expressions in Scripts<a class="anchor" aria-label="anchor" href="#exprs"></a>
</h2>
<div class="section level3">
<h3 id="quoting-and-unquoting-introducing-expr-exprs-and">Quoting and Unquoting: Introducing <code>expr()</code>,
<code>exprs()</code>, <code>!!</code> and <code>!!!</code><a class="anchor" aria-label="anchor" href="#quoting-and-unquoting-introducing-expr-exprs-and"></a>
</h3>
<div class="section level4">
<h4 id="expr-and-exprs">
<code>expr()</code> and <code>exprs()</code><a class="anchor" aria-label="anchor" href="#expr-and-exprs"></a>
</h4>
<p><code><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr()</a></code> is a function from the <a href="https://rlang.r-lib.org" class="external-link">rlang</a>
package, which is used to create an <strong>expression</strong>. The
expression is not evaluated - rather, it is passed on to the derivation
function which evaluates it in its own environment. <code><a href="../reference/reexport-exprs.html">exprs()</a></code>
is the plural version of <code><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr()</a></code>, so it accepts multiple
comma-separated items and returns a list of expressions.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rlang.r-lib.org" class="external-link">rlang</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">adae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>USUBJID <span class="op">=</span> <span class="st">"XXX-1"</span>, AEDECOD <span class="op">=</span> <span class="st">"HEADACHE"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Return the adae object</span></span>
<span><span class="va">adae</span></span>
<span><span class="co">#&gt;   USUBJID  AEDECOD</span></span>
<span><span class="co">#&gt; 1   XXX-1 HEADACHE</span></span>
<span></span>
<span><span class="co"># Return an expression</span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="va">adae</span><span class="op">)</span></span>
<span><span class="co">#&gt; adae</span></span></code></pre></div>
<p>When used within the contest of an <a href="https://pharmaverse.github.io/admiral/">admiral</a> derivation
function, <code><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr()</a></code> and <code><a href="../reference/reexport-exprs.html">exprs()</a></code> allow the
function to evaluate the expressions in the context of the input
dataset. As an example, <code><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr()</a></code> and <code><a href="../reference/reexport-exprs.html">exprs()</a></code>
allow users to pass variable names of datasets to the function without
wrapping them in quotation marks.</p>
<p>The expressions framework is powerful because users are able to
intuitively “inject code” into <code>admiral</code> functions (through
the function parameters) using very similar syntax as if they were
writing open code, with the exception possibly being an outer
<code><a href="../reference/reexport-exprs.html">exprs()</a></code> wrapper. For instance, in the
<code><a href="../reference/derive_vars_merged.html">derive_vars_merged()</a></code> call below, the user is merging
<code>adsl</code> with <code>ex</code> and is able to filter
<code>ex</code> prior to the merge using an expression passed to the
<code>filter_add</code> parameter. Because <code>filter_add</code>
accepts expressions, the user has full power to filter their dataset as
they please. In the same vein, the user is able to create any new
variables they wish after the merge using the <code>new_vars</code>
argument, to which they pass a list of expressions containing “standard”
R code.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>  <span class="va">adsl</span>,</span>
<span>  dataset_add <span class="op">=</span> <span class="va">ex</span>,</span>
<span>  filter_add <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXENDTM</span><span class="op">)</span>,</span>
<span>  by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>  new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>    TRTEDTM <span class="op">=</span> <span class="va">EXENDTM</span>,</span>
<span>    TRTETMF <span class="op">=</span> <span class="va">EXENTMF</span>,</span>
<span>    COMPTRT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXENDTM</span><span class="op">)</span>, <span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">EXENDTM</span><span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"last"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="unquoting">Bang-Bang (<code>!!</code>) and Bang-Bang-Bang
(<code>!!!</code>)<a class="anchor" aria-label="anchor" href="#unquoting"></a>
</h4>
<p>Sometimes you may want to construct an expression using other,
pre-existing expressions. However, it’s not immediately clear how to
achieve this because expressions inherently pause evaluation of your
code before it’s executed:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="va">a</span> <span class="op">+</span> <span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; a + b</span></span>
<span><span class="co"># NOT 2 + 3</span></span></code></pre></div>
<p>This is where <code>!!</code> (bang-bang) comes in: provided again by
the <a href="https://rlang.r-lib.org" class="external-link">rlang</a> package, it allows you to inject the contents
of an expression into another expression, meaning that by using
<code>!!</code> you can modify the code inside an expression before R
evaluates it. By using <code>!!</code> you are
<strong>unquoting</strong> an expression, i.e. evaluating it before you
pass it onwards.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">a</span> <span class="op">+</span> <span class="op">!</span><span class="op">!</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2 + 3</span></span></code></pre></div>
<p>You can see an example of where <code>!!</code> comes in handy within
<a href="https://pharmaverse.github.io/admiral/">admiral</a> code in <a href="#pitfall1">Common Pitfall 1</a>,
where the contents of an expression is unquoted so that it can be passed
to <code><a href="../reference/derive_vars_merged.html">derive_vars_merged()</a></code>.</p>
<p><code>!!!</code> (bang-bang-bang) is the plural version of
<code>!!</code> and can be used to unquote a list of expressions:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>Within <a href="https://pharmaverse.github.io/admiral/">admiral</a>, this operator can be useful if we need
to unquote a list of variables (stored as expressions) to use them
inside of an <a href="https://pharmaverse.github.io/admiral/">admiral</a> or even <a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a> call.
One example is the <a href="https://pharmaverse.github.io/admiral/">admiral</a> subject keys:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_admiral_option.html">get_admiral_option</a></span><span class="op">(</span><span class="st">"subject_keys"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; STUDYID</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; USUBJID</span></span></code></pre></div>
<p>If we want to use the subject keys stored within this
<a href="https://pharmaverse.github.io/admiral/">admiral</a> option to subset a dataset, we need to use
<code>!!!</code> to unquote this list. Let’s construct a dummy example
to illustrate the point:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adcm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>STUDYID <span class="op">=</span> <span class="st">"XXX"</span>, USUBJID <span class="op">=</span> <span class="st">"XXX-1"</span>, CMTRT <span class="op">=</span> <span class="st">"ASPIRIN"</span><span class="op">)</span></span>
<span><span class="va">adcm</span></span>
<span><span class="co">#&gt;   STUDYID USUBJID   CMTRT</span></span>
<span><span class="co">#&gt; 1     XXX   XXX-1 ASPIRIN</span></span>
<span></span>
<span><span class="co"># This doesn't work as we are not unquoting the subject keys</span></span>
<span><span class="va">adcm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_admiral_option.html">get_admiral_option</a></span><span class="op">(</span><span class="st">"subject_keys"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `select()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't select columns with `get_admiral_option("subject_keys")`.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> `get_admiral_option("subject_keys")` must be numeric or character, not a list.</span></span>
<span></span>
<span><span class="co"># This works because we are unquoting the subject keys</span></span>
<span><span class="va">adcm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/get_admiral_option.html">get_admiral_option</a></span><span class="op">(</span><span class="st">"subject_keys"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   STUDYID USUBJID</span></span>
<span><span class="co">#&gt; 1     XXX   XXX-1</span></span></code></pre></div>
<p>You can see another example of <code>!!!</code> in action in <a href="https://github.com/pharmaverse/admiral/blob/c5dd8fb196c2cd3f27a6b02ec88fa1abd6b24d60/inst/templates/ad_adex.R#L162" class="external-link">this
line</a> of the <a href="https://pharmaverse.github.io/admiral/">admiral</a> <code>ADEX</code> template
script, where it is used to dynamically control the by variables passed
to an <a href="https://pharmaverse.github.io/admiral/">admiral</a> function.</p>
</div>
<div class="section level4">
<h4 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h4>
<p>In summary, although the expressions framework may seem slightly
clunky and mysterious to begin with, it allows for such power and
flexibility that it forms a key part of the <a href="https://pharmaverse.github.io/admiral/">admiral</a>
package. For a comprehensive treatment of expressions, see <a href="https://adv-r.hadley.nz/expressions.html" class="external-link">Chapter 18</a> and <a href="https://adv-r.hadley.nz/quasiquotation.html" class="external-link">Chapter 19</a> of the
Advanced R textbook. Chapter 19 specifically covers in much more detail
the concept of unquoting.</p>
</div>
</div>
<div class="section level3">
<h3 id="common-pitfalls">Common pitfalls<a class="anchor" aria-label="anchor" href="#common-pitfalls"></a>
</h3>
<p>Expressions are very powerful, but this can also lead to
misunderstandings about their functionality. Let’s set up some dummy
data to explore common issues that new (or experienced!) programmers may
encounter when dealing with expressions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/">admiral</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">USUBJID</span>, <span class="op">~</span><span class="va">VSTESTCD</span>, <span class="op">~</span><span class="va">VISIT</span>, <span class="op">~</span><span class="va">VSSTRESN</span>, <span class="op">~</span><span class="va">VSSTRESU</span>, <span class="op">~</span><span class="va">VSDTC</span>,</span>
<span>  <span class="st">"01-1301"</span>, <span class="st">"WEIGHT"</span>, <span class="st">"SCREENING"</span>, <span class="fl">82.1</span>, <span class="st">"kg"</span>, <span class="st">"2013-08-29"</span>,</span>
<span>  <span class="st">"01-1301"</span>, <span class="st">"WEIGHT"</span>, <span class="st">"WEEK 2"</span>, <span class="fl">81.19</span>, <span class="st">"kg"</span>, <span class="st">"2013-09-15"</span>,</span>
<span>  <span class="st">"01-1301"</span>, <span class="st">"WEIGHT"</span>, <span class="st">"WEEK 4"</span>, <span class="fl">82.56</span>, <span class="st">"kg"</span>, <span class="st">"2013-09-24"</span>,</span>
<span>  <span class="st">"01-1302"</span>, <span class="st">"BMI"</span>, <span class="st">"SCREENING"</span>, <span class="fl">20.1</span>, <span class="st">"kg/m2"</span>, <span class="st">"2013-08-29"</span>,</span>
<span>  <span class="st">"01-1302"</span>, <span class="st">"BMI"</span>, <span class="st">"WEEK 2"</span>, <span class="fl">20.2</span>, <span class="st">"kg/m2"</span>, <span class="st">"2013-09-15"</span>,</span>
<span>  <span class="st">"01-1302"</span>, <span class="st">"BMI"</span>, <span class="st">"WEEK 4"</span>, <span class="fl">19.9</span>, <span class="st">"kg/m2"</span>, <span class="st">"2013-09-24"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">USUBJID</span>, <span class="op">~</span><span class="va">AGE</span>,</span>
<span>  <span class="st">"01-1301"</span>, <span class="fl">18</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="pitfall1">1. Mistakenly passing something that isn’t an expression to an
argument<a class="anchor" aria-label="anchor" href="#pitfall1"></a>
</h4>
<p>When writing more complex <a href="https://pharmaverse.github.io/admiral/">admiral</a> code it can be easy
to mistakenly pass the wrong input to an argument that expects an
expression. For example, the code below fails because
<code>my_expression</code> is not an expression - it is the name of an
object in the global environment containing an expression.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_expression</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="va">VSTESTCD</span> <span class="op">==</span> <span class="st">"WEIGHT"</span> <span class="op">&amp;</span> <span class="va">VISIT</span> <span class="op">==</span> <span class="st">"SCREENING"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>  <span class="va">dm</span>,</span>
<span>  dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">vs</span>, <span class="va">USUBJID</span>, <span class="va">VSTESTCD</span>, <span class="va">VISIT</span><span class="op">)</span>,</span>
<span>  by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>  filter_add <span class="op">=</span> <span class="va">my_expression</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `derive_vars_merged()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Argument `filter_add` must be a filter condition, but is a symbol</span></span></code></pre></div>
<p>To fix this code, we need to <a href="#unquoting">unquote</a>
<code>my_expression</code> so that the expression that it is holding is
passed correctly to <code><a href="../reference/derive_vars_merged.html">derive_vars_merged()</a></code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>  <span class="va">dm</span>,</span>
<span>  dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">vs</span>, <span class="va">USUBJID</span>, <span class="va">VSTESTCD</span>, <span class="va">VISIT</span><span class="op">)</span>,</span>
<span>  by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>  filter_add <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">my_expression</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   USUBJID   AGE VSTESTCD VISIT    </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 01-1301    18 WEIGHT   SCREENING</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="forgetting-that-expressions-must-be-evaluable-in-the-dataset">2. Forgetting that expressions must be evaluable in the dataset<a class="anchor" aria-label="anchor" href="#forgetting-that-expressions-must-be-evaluable-in-the-dataset"></a>
</h4>
<p>In a similar vein to above, even if an actual expression <em>is</em>
passed as an argument, you must make sure that it can be evaluated
within the dataset of interest. This may seem trivial, but it is a
common pitfall because expressions delay evaluation of code and so can
delay the identification of issues. For instance, consider this
example:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter_vs_and_merge</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">my_expression</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    <span class="va">dm</span>,</span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">vs</span>, <span class="va">USUBJID</span>, <span class="va">VSTESTCD</span>, <span class="va">VISIT</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">my_expression</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># This works</span></span>
<span><span class="fu">filter_vs_and_merge</span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="va">VSTESTCD</span> <span class="op">==</span> <span class="st">"WEIGHT"</span> <span class="op">&amp;</span> <span class="va">VISIT</span> <span class="op">==</span> <span class="st">"SCREENING"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   USUBJID   AGE VSTESTCD VISIT    </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 01-1301    18 WEIGHT   SCREENING</span></span>
<span></span>
<span><span class="co"># This fails</span></span>
<span><span class="fu">filter_vs_and_merge</span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="va">VSTESTCD</span> <span class="op">==</span> <span class="st">"WEIGHT"</span> <span class="op">&amp;</span> <span class="va">VISIT</span> <span class="op">==</span> <span class="st">"SCREENING"</span> <span class="op">&amp;</span> <span class="va">VSTPT</span> <span class="op">==</span> <span class="st">"PREDOSE"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `filter()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In argument: `VSTESTCD == "WEIGHT" &amp; VISIT == "SCREENING" &amp; VSTPT ==</span></span>
<span><span class="co">#&gt;   "PREDOSE"`.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> object 'VSTPT' not found</span></span></code></pre></div>
<p>The second call fails because hidden within the expression is a
mention of <code>VSTPT</code>, which was dropped from <code>vs</code> in
<code>filter_vs_and_merge()</code>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
<ul>
<li><a href="https://pharmaverse.github.io/admiraldev/articles/programming_strategy.html">Programming
Strategy</a></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ben Straub, Stefan Bundfuss, Jeffrey Dickinson, Ross Farrugia, Fanny Gautier, Dinakar Kulkarni, Edoardo Mancini, Sadchla Mascary, Gordon Miller, Jim Rothstein, Sophie Shapcott, Eric Simms, Daniel Sjoberg, Stefan Thoma, Phillip Webster, Zelos Zhu, F. Hoffmann-La Roche AG, GlaxoSmithKline LLC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
