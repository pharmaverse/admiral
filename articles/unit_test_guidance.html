<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="admiral">
<title>Unit Test Guidance • admiral</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Unit Test Guidance">
<meta property="og:description" content="admiral">
<meta property="og:image" content="https://pharmaverse.github.io/admiral/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">admiral</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/admiral.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>User Guides</h6>
    <a class="dropdown-item" href="../articles/adsl.html">Creating ADSL</a>
    <a class="dropdown-item" href="../articles/occds.html">Creating an OCCDS ADaM</a>
    <a class="dropdown-item" href="../articles/bds_finding.html">Creating a BDS Finding ADaM</a>
    <a class="dropdown-item" href="../articles/bds_exposure.html">Creating a BDS Exposure ADaM</a>
    <a class="dropdown-item" href="../articles/bds_tte.html">Creating a BDS Time-to-Event ADaM</a>
    <a class="dropdown-item" href="../articles/imputation.html">Date and Time Imputation</a>
    <a class="dropdown-item" href="../articles/queries_dataset.html">Queries Dataset Documentation</a>
    <a class="dropdown-item" href="../articles/faq.html">FAQ</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Developer Guides</h6>
    <a class="dropdown-item" href="../articles/contribution_model.html">Contribution to {admiral}</a>
    <a class="dropdown-item" href="../articles/development_process.html">Development Process</a>
    <a class="dropdown-item" href="../articles/programming_strategy.html">Programming Strategy</a>
    <a class="dropdown-item" href="../articles/git_usage.html">Guidance for git and GitHub Usage</a>
    <a class="dropdown-item" href="../articles/writing_vignettes.html">Writing Vignettes</a>
    <a class="dropdown-item" href="../articles/pr_review_guidance.html">Pull Request Review Guidance</a>
    <a class="dropdown-item" href="../articles/unit_test_guidance.html">Unit Test Guidance</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/pharmaverse/admiral/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="unit_test_guidance_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Unit Test Guidance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pharmaverse/admiral/blob/main/vignettes/unit_test_guidance.Rmd" class="external-link"><code>vignettes/unit_test_guidance.Rmd</code></a></small>
      <div class="d-none name"><code>unit_test_guidance.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="why-write-unit-tests">Why Write Unit Tests?<a class="anchor" aria-label="anchor" href="#why-write-unit-tests"></a>
</h2>
<div class="section level3">
<h3 id="unit-tests-become-a-safety-net-for-developers">Unit Tests Become a Safety Net for Developers<a class="anchor" aria-label="anchor" href="#unit-tests-become-a-safety-net-for-developers"></a>
</h3>
<p>A comprehensive suite of unit tests can act as a safety net for developers. By frequently running the tests, they can assure their recent modifications to the code haven’t broken anything. In other words, unit tests help prevent regressions.</p>
</div>
<div class="section level3">
<h3 id="unit-tests-can-contribute-to-higher-code-quality">Unit Tests Can Contribute to Higher Code Quality<a class="anchor" aria-label="anchor" href="#unit-tests-can-contribute-to-higher-code-quality"></a>
</h3>
<p>Since unit tests act as a safety net, developers become more confident when changing the code. They can refactor the code without fear of breaking things, driving the general quality of the code base up.</p>
</div>
<div class="section level3">
<h3 id="unit-tests-can-contribute-to-better-application-architecture">Unit Tests Can Contribute to Better Application Architecture<a class="anchor" aria-label="anchor" href="#unit-tests-can-contribute-to-better-application-architecture"></a>
</h3>
<p>If you can add unit tests easily to a code base, that’s usually a good sign regarding the quality of the app’s architecture. So, the drive to write testable code can be an incentive for better architecture.</p>
</div>
<div class="section level3">
<h3 id="detects-code-smells-in-your-codebase">Detects Code Smells in your Codebase<a class="anchor" aria-label="anchor" href="#detects-code-smells-in-your-codebase"></a>
</h3>
<p>If ease of adding unit tests to a code base is a good sign, the opposite is also true. Having a hard time creating unit tests for a given piece of code might be a sign of code smells in the code—e.g. functions that are too complex.</p>
</div>
</div>
<div class="section level2">
<h2 id="writing-good-unit-tests">Writing Good Unit Tests<a class="anchor" aria-label="anchor" href="#writing-good-unit-tests"></a>
</h2>
<div class="section level3">
<h3 id="tests-should-be-fast">Tests Should Be Fast<a class="anchor" aria-label="anchor" href="#tests-should-be-fast"></a>
</h3>
<p>If they’re slow, developers won’t run them as often as they should. That defeats the whole purpose of having a suite of unit tests in the first place, which is to boost the developers’ confidence to make changes to the code. The tests can’t work as the safety net if they’re not run often.</p>
</div>
<div class="section level3">
<h3 id="tests-should-be-simple">Tests Should Be Simple<a class="anchor" aria-label="anchor" href="#tests-should-be-simple"></a>
</h3>
<p>There are several techniques we can apply to have a high degree of confidence in the correctness of our tests. One of those is to keep your tests with low cyclomatic complexity. Cyclomatic complexity is a code metric that indicates the number of possible execution paths a given method can follow. A piece of code with lower complexity is easier to understand and maintain, which means developers are less likely to introduce bugs when working on it. We can measure the cyclomatic complexity of your tests (using, for instance, a linter tool) and do your best to keep it low.</p>
</div>
<div class="section level3">
<h3 id="test-shouldnt-duplicate-implementation-logic">Test Shouldn’t Duplicate Implementation Logic<a class="anchor" aria-label="anchor" href="#test-shouldnt-duplicate-implementation-logic"></a>
</h3>
<p>If the same person wrote both the test and the implementation, it’s possible they made the same errors in both places. Since the tests mirror the implementation, they might still pass, and the implementation could be wrong, but the tests might fool you into thinking otherwise. Resist the urge to make your tests fancy, keep them simple, and your testing suite will be better for it.</p>
</div>
<div class="section level3">
<h3 id="tests-should-be-readable">Tests Should Be Readable<a class="anchor" aria-label="anchor" href="#tests-should-be-readable"></a>
</h3>
<p>This best practice overlaps a little bit with the one about keeping your tests simple. If tests are hard to read, developers are more likely to misunderstand them and introduce bugs. Test cases could be used as a form of documentation, so they obviously need to be readable.</p>
</div>
<div class="section level3">
<h3 id="running-unit-tests-part-of-the-build-process">Running Unit Tests Part of the Build Process<a class="anchor" aria-label="anchor" href="#running-unit-tests-part-of-the-build-process"></a>
</h3>
<p>Automate the whole process of running the unit tests and taking some action when they fail. Your build process should execute your unit tests and mark the build as broken when the tests fail.</p>
</div>
</div>
<div class="section level2">
<h2 id="writing-unit-tests-in-admiral">Writing Unit Tests in {admiral}<a class="anchor" aria-label="anchor" href="#writing-unit-tests-in-admiral"></a>
</h2>
<div class="section level3">
<h3 id="plan-your-unit-tests">Plan your Unit Tests<a class="anchor" aria-label="anchor" href="#plan-your-unit-tests"></a>
</h3>
<p>Start by considering the derivation rule you are testing and the possible arguments/flexibilities of your function code. Then plan which scenarios you will test. These can either involve generating different input test cases or feeding them into different calls of your function.</p>
</div>
<div class="section level3">
<h3 id="test-coverage">Test coverage<a class="anchor" aria-label="anchor" href="#test-coverage"></a>
</h3>
<p>Unit tests should cover the functionality of the function. If another function <code>g()</code> is called within a function <code>f()</code>, the unit tests of <code>f()</code> should not test the functionality of <code>g()</code>. This should be tested by the unit tests of <code>g()</code>, i.e. unit tests should be added at the lowest level.</p>
</div>
<div class="section level3">
<h3 id="tests-should-be-robust-to-cover-realistic-data-scenarios">Tests Should be Robust to Cover Realistic Data Scenarios<a class="anchor" aria-label="anchor" href="#tests-should-be-robust-to-cover-realistic-data-scenarios"></a>
</h3>
<p>For generating input test cases, it can be helpful to consider regular cases (expected common data scenarios), boundary cases (where data points are close or equal), and special cases (uncommon but valid data scenarios, e.g. missing or special characters). Although you will never cover every single eventuality of possible input data (no reliability testing method ever gives 100% certainty), you do need to give confidence that the code is robust enough to work across most data scenarios.</p>
</div>
<div class="section level3">
<h3 id="testing-should-cover-possible-arguments">Testing Should Cover Possible Arguments<a class="anchor" aria-label="anchor" href="#testing-should-cover-possible-arguments"></a>
</h3>
<p>For the different calls of your function, consider how the user might apply your function and test a variety of possible calls, whilst still remembering the tips above that tests should be fast and simple. This is only needed in cases where the complexity and level of flexibility of your function justifies it, e.g. see the test script: <a href="https://github.com/pharmaverse/admiral/blob/main/tests/testthat/test-derive_var_extreme_flag.R" class="external-link uri">https://github.com/pharmaverse/admiral/blob/main/tests/testthat/test-derive_var_extreme_flag.R</a>.</p>
</div>
<div class="section level3">
<h3 id="exported-functions">Exported Functions<a class="anchor" aria-label="anchor" href="#exported-functions"></a>
</h3>
<p>Don’t forget to add a unit test for each exported function.</p>
</div>
<div class="section level3">
<h3 id="set-up-the-test-script">Set up the Test Script<a class="anchor" aria-label="anchor" href="#set-up-the-test-script"></a>
</h3>
<p>Within {admiral} folder <a href="https://github.com/pharmaverse/admiral/tree/main/tests/testthat" class="external-link uri">https://github.com/pharmaverse/admiral/tree/main/tests/testthat</a>, add a script with the naming convention “test-&lt;script_containing_function&gt;.R”., the unit test script can be created from the console also, as follows:</p>
<pre><code><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_r.html" class="external-link">use_test</a></span><span class="op">(</span><span class="st">"&lt;script_containing_function&gt;"</span><span class="op">)</span></code></pre>
<p>the testing framework used is testthat and has the following format :</p>
<pre><code>test_that("&lt;function_name&gt; Test 1: &lt;Explanation of the test&gt;", {
  input &lt;- tibble::tribble(
    ~inputvar1, ~inputvar2, ...
    &lt;Add Test Data Scenarios&gt;
    ...
  )

  expected_output &lt;- mutate(input, outputvar = c(&lt;Add Expected Outputs&gt;))

  expect_dfs_equal(&lt;function name&gt;(input), expected_output)
  
})</code></pre>
<p>For example, if you are testing a function called my_new_func that is contained in script all_funcs.R then from console use:</p>
<pre><code><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_r.html" class="external-link">use_test</a></span><span class="op">(</span><span class="st">"all_funcs"</span><span class="op">)</span></code></pre>
<p>Open the newly created file “test-all_funcs.R” and use the following format:</p>
<pre><code>test_that("my_new_func Test 1: &lt;Explanation of the test&gt;", {
  input &lt;- tibble::tribble(
    ~inputvar1, ~inputvar2, ...
    &lt;Add Test Data Scenarios&gt;
    ...
  )

  expected_output &lt;- mutate(input, outputvar = c(&lt;Add Expected Outputs&gt;))

  expect_dfs_equal(&lt;function name&gt;(input), expected_output)
})</code></pre>
<p><strong>Note</strong>: When comparing datasets in {admiral} we use function <code><a href="../reference/expect_dfs_equal.html">expect_dfs_equal()</a></code>.</p>
<p>The input and expected output for the unit tests must follow the following rules:</p>
<ul>
<li>Input and output should be as simple as possible.</li>
<li>Values should be hard-coded whenever possible.</li>
<li>If values need to be derived, only unit tested functions can be used.</li>
</ul>
<p>If a dataset needs to be created for testing purpose, it should be done so using the function <code><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tibble::tribble()</a></code>. Make sure to align columns as well. This ensures quick code readability.</p>
<p>Ensure you give a meaningful explanation of the test in the testthat call, as these will be compiled in the package validation report. Having the name of the function and test ID included in title will also help with traceability.</p>
<p>Once you have tested your unit test program, you can run all unit tests from the console, as follows.</p>
<pre><code><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span><span class="op">)</span></code></pre>
</div>
<div class="section level3">
<h3 id="automation-of-unit-tests">Automation of Unit Tests<a class="anchor" aria-label="anchor" href="#automation-of-unit-tests"></a>
</h3>
<p>When a user actions a pull request in {admiral} GitHub repo, the unit tests are automatically run and pull request will be denied if any unit tests fail.</p>
</div>
<div class="section level3">
<h3 id="flow-chart">Flow Chart<a class="anchor" aria-label="anchor" href="#flow-chart"></a>
</h3>
<p><img src="unit_test_guidance.png" width="120%"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Thomas Neitmann, Stefan Bundfuss, Ben Straub, Samia Kabi, Gordon Miller, Teckla Akinyi, Andrew Smith, Konstantina Koukourikou, Ross Farrugia, Eric Simms, Annie Yang, Robin Koeger, Sophie Shapcott, Ojesh Upadhyay, Jack McGavigan, Kamila Duniec, Gayatri G, Alana Harris, Mahdi About, Pooja Kumari, Claudia Carlucci, Daniil Stefonishin, F. Hoffmann-La Roche AG, GlaxoSmithKline LLC.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
