<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Explore the admiral ADaM Templates â€¢ admiral</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="â€image/svg+xmlâ€" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Explore the admiral ADaM Templates">
<script async src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="2c7249cc-f1dc-4a63-8674-6ecbcb34d95c" data-project-name="admiral" data-project-color="#2c3e50" data-project-logo="https://pharmaverse.github.io/admiral/cran-release/logo.png" data-consent-required="true" data-user-analytics-cookie-enabled="true" data-consent-screen-title="Help us improve our AI assistant" data-consent-screen-disclaimer="By clicking 'Allow tracking', you consent to anonymous user tracking which helps us improve our service. We don't collect any personally identifiable information." data-consent-screen-accept-button-text="Allow tracking" data-consent-screen-reject-button-text="No, thanks" data-modal-example-questions="Tell me a little about the {admiral} package., What are some important {admiral} functions and what do they do?" data-modal-search-placeholder="Ask me a question about {admiral} or the {admiral} ecosystem..." data-modal-z-index="9999"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">admiral</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.1.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-get-started" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Get Started</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-get-started">
<li><a class="dropdown-item" href="../articles/admiral.html">Get Started</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/pharmaverse/admiral/blob/main/inst/cheatsheet/admiral_cheatsheet.pdf">Cheatsheet</a></li>
    <li><a class="dropdown-item" href="../articles/templates.html">Explore ADaM Templates ðŸ§­</a></li>
    <li><a class="external-link dropdown-item" href="https://pharmaverse.github.io/admiraldiscovery/articles/presentation_archive.html">Presentation Archive</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-user-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">User Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-user-guides">
<li><h6 class="dropdown-header" data-toc-skip>General Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/concepts_conventions.html">Programming Concepts and Conventions</a></li>
    <li><a class="dropdown-item" href="../articles/generic.html">Generic Derivations</a></li>
    <li><a class="dropdown-item" href="../articles/higher_order.html">Higher Order Functions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>ADaM Script Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/adsl.html">Creating a Basic ADSL</a></li>
    <li><a class="dropdown-item" href="../articles/occds.html">Creating an OCCDS ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/bds_finding.html">Creating a BDS Findings ADAM</a></li>
    <li><a class="dropdown-item" href="../articles/bds_exposure.html">Creating a BDS Exposure ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/bds_tte.html">Creating a BDS Time-to-Event ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/questionnaires.html">Creating Questionnaire ADaMs</a></li>
    <li><a class="dropdown-item" href="../articles/pk_adnca.html">Creating a PK NCA or Population PK ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/adab.html">Creating an Antidrug Antibody ADaM</a></li>
    <li><a class="dropdown-item" href="../articles/hys_law.html">Hy's Law Implementation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Special Topics Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/imputation.html">Date and Time Imputation</a></li>
    <li><a class="dropdown-item" href="../articles/visits_periods.html">Visit and Period Variables</a></li>
    <li><a class="dropdown-item" href="../articles/queries_dataset.html">Queries Dataset Documentation</a></li>
    <li><a class="dropdown-item" href="../articles/lab_grading.html">Lab Grading</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/faq.html">FAQ</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://pharmaverse.github.io/admiraldiscovery/articles/reactable.html">ðŸ”Ž Find my function</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://pharmaverse.slack.com/" aria-label="Slack"><span class="fa fa-slack"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pharmaverse/admiral/issues/new/choose" aria-label="New Issue"><span class="fa fa-bug"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pharmaverse/admiral/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Explore the admiral ADaM Templates</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pharmaverse/admiral/blob/main/vignettes/articles/templates.Rmd" class="external-link"><code>vignettes/articles/templates.Rmd</code></a></small>
      <div class="d-none name"><code>templates.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="intro">Introduction<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<p>This page is a catalog of the ADaM templates available through
<a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a>. These are lifted from our GitHub repository. The
intention is for this to be a reference for users, should they wish to
peruse the code of a specific template without visiting the
<a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> repository.</p>
<p>As a reminder, you can create a starter script from a template using
<code><a href="../reference/use_ad_template.html">admiral::use_ad_template()</a></code>, e.g.,</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/use_ad_template.html">use_ad_template</a></span><span class="op">(</span></span>
<span>  adam_name <span class="op">=</span> <span class="st">"adsl"</span>,</span>
<span>  save_path <span class="op">=</span> <span class="st">"./ad_adsl.R"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"admiral"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="templates">ADaM templates<a class="anchor" aria-label="anchor" href="#templates"></a>
</h2>
<details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adab.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADAB</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Anti-Drug Antibody Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Description: Experimental. Based on simulated data, create ADAB analysis dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: is_ada, ex, adsl</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project or simulated</span></span>
<span></span>
<span><span class="co"># ---- Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="co"># Load IS, EX and ADSL from pharmaversesdtm and admiral</span></span>
<span></span>
<span><span class="va">is</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/is_ada.html" class="external-link">is_ada</a></span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ex.html" class="external-link">ex</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">is</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">is</span><span class="op">)</span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">adsl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define values for records with overall values</span></span>
<span><span class="co"># Suggested are AVISIT=Overall, AVISITN=11111</span></span>
<span><span class="va">overall_avisit</span> <span class="op">&lt;-</span> <span class="st">"OVERALL"</span></span>
<span><span class="va">overall_avisitn</span> <span class="op">&lt;-</span> <span class="fl">11111</span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="va">is_dates</span> <span class="op">&lt;-</span> <span class="va">is</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Filter as needed (i.e. exclude ISSTAT has "NOT DONE")</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">ISSTAT</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NOT DONE"</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">ISBDAGNT</span><span class="op">)</span> <span class="op">==</span> <span class="st">"XANOMELINE"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Initial preparation and core variables</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># ADATYPE and ADAPARM are assigned values to serve BY analyte processing</span></span>
<span></span>
<span>    <span class="co"># Uncomment if Setting ADATYPE based on SDTM V1.x ISTESTCD</span></span>
<span>    <span class="co"># ADATYPE = case_when(</span></span>
<span>    <span class="co">#   toupper(ISTESTCD) == "ADATEST1" ~ "ADA_BAB",</span></span>
<span>    <span class="co">#   toupper(ISTESTCD) == "NABTEST1" ~ "ADA_NAB",</span></span>
<span>    <span class="co">#   TRUE ~ NA_character_</span></span>
<span>    <span class="co"># ),</span></span>
<span></span>
<span>    <span class="co"># Uncomment if Setting ADAPARM based on SDTM V1.x ISTESTCD</span></span>
<span>    <span class="co"># ADAPARM = ISTESTCD,</span></span>
<span></span>
<span>    <span class="co"># Setting ADATYPE based on SDTM V2.x ISTESTCD (assumed to have ADA_BAB, ADA_NAB)</span></span>
<span>    <span class="co"># Remove or comment out if not &gt;= SDTM V2.x</span></span>
<span>    ADATYPE <span class="op">=</span> <span class="va">ISTESTCD</span>,</span>
<span></span>
<span>    <span class="co"># Setting ADAPARM based on SDTM V2.x ISBDAGNT</span></span>
<span>    <span class="co"># Remove or comment out if not &gt;= SDTM V2.x</span></span>
<span>    ADAPARM <span class="op">=</span> <span class="va">ISBDAGNT</span>,</span>
<span></span>
<span>    <span class="co"># When SDTM V1.x, Setting ISBDAGNT from ISTESTCD to work with template</span></span>
<span>    <span class="co"># ISBDAGNT = ISTESTCD,</span></span>
<span></span>
<span>    <span class="co"># Map the analyte test to corresponding DRUG in on EX.EXTRT</span></span>
<span>    <span class="co"># This is especially critical when multiple analytes and EX.EXTRT instances</span></span>
<span>    DRUG <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">ADAPARM</span><span class="op">)</span> <span class="op">==</span> <span class="st">"XANOMELINE"</span> <span class="op">~</span> <span class="st">"XANOMELINE"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">ADAPARM</span><span class="op">)</span> <span class="op">==</span> <span class="st">"OTHER_DRUG"</span> <span class="op">~</span> <span class="st">"OTHER_DRUG"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Set AVISIT and AVISITN based on VISIT and VISITNUM</span></span>
<span>    AVISIT <span class="op">=</span> <span class="va">VISIT</span>,</span>
<span>    AVISITN <span class="op">=</span> <span class="va">VISITNUM</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Assign nominal time to NFRLT in DAYS</span></span>
<span>  <span class="co"># Special visits can be set to NA then can add more code to assign custom values</span></span>
<span>  <span class="co">#   (i.e. UNSCHEDULED to 99999, etc.)</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_nfrlt.html">derive_var_nfrlt</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">NFRLT</span>,</span>
<span>    new_var_unit <span class="op">=</span> <span class="va">FRLTU</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"DAYS"</span>,</span>
<span>    tpt_var <span class="op">=</span> <span class="va">ISTPT</span>,</span>
<span>    visit_day <span class="op">=</span> <span class="va">VISITDY</span>,</span>
<span>    treatment_duration <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    set_values_to_na <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span>, <span class="st">"UNSCHED"</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span>, <span class="st">"TREATMENT DISC"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    NFRLT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span>, <span class="st">"TREATMENT DISC"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">99997</span>,</span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span>, <span class="st">"UNSCHED"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">99999</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">NFRLT</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL with is (need TRTSDT for ADY derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive analysis date/time then compute ADY</span></span>
<span>  <span class="co"># Impute missing time to 00:00:00 or as desired.</span></span>
<span>  <span class="co"># Could replace this code with custom imputation code or function</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>    highest_imputation <span class="op">=</span> <span class="st">"s"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">ISDTC</span>,</span>
<span>    ignore_seconds_flag <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates and times from date/times</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="va">TRTSDT</span>, source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Get dosing information ----</span></span>
<span></span>
<span><span class="va">ex_dates</span> <span class="op">&lt;-</span> <span class="va">ex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Keep applicable desired records based on EXTRT and/or dose values (&gt;=0, &gt;0, etc.)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">EXTRT</span><span class="op">)</span>, <span class="st">"XANOMELINE"</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">EXTRT</span><span class="op">)</span>, <span class="st">"PLACEBO"</span><span class="op">)</span>,</span>
<span>    <span class="va">EXDOSE</span> <span class="op">&gt;=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># DRUG is a merge variable to map and merge ADA data with EX.EXTRT</span></span>
<span>    <span class="co"># This will be used to merge first dose into IS working data.</span></span>
<span>    <span class="co"># PLACEBO example is for if/when ADA was also collected on Placebo subjects</span></span>
<span>    <span class="co"># or treatments are scrambled prior to database lock.</span></span>
<span>    DRUG <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">EXTRT</span><span class="op">)</span>, <span class="st">"XANOMELINE"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"XANOMELINE"</span>,</span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">EXTRT</span><span class="op">)</span>, <span class="st">"PLACEBO"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"XANOMELINE"</span>,</span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">EXTRT</span><span class="op">)</span>, <span class="st">"OTHER_DRUG"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"OTHER_DRUG"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Assign nominal time to NFRLT in DAYS</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_nfrlt.html">derive_var_nfrlt</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">NFRLT</span>,</span>
<span>    new_var_unit <span class="op">=</span> <span class="va">FRLTU</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"DAYS"</span>,</span>
<span>    visit_day <span class="op">=</span> <span class="va">VISITDY</span>,</span>
<span>    treatment_duration <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Add analysis datetime variables and set missing end date to start date</span></span>
<span>  <span class="co"># Impute missing time to 00:00:00 or as desired.</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">EXSTDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AEN"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">EXENDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Set missing end dates to start date or as desired</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AENDTM <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AENDTM</span><span class="op">)</span>, <span class="va">ASTDTM</span>, <span class="va">AENDTM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates from date/times</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AENDTM</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Note: This template computes only AFRLT, see ADPC template if need EX dose expansion example.</span></span>
<span></span>
<span><span class="co"># Derive AFRLT in IS data</span></span>
<span><span class="va">is_afrlt</span> <span class="op">&lt;-</span> <span class="va">is_dates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_dates</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ASTDTM</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>FANLDTM <span class="op">=</span> <span class="va">ASTDTM</span>, FANLTMF <span class="op">=</span> <span class="va">ASTTMF</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span>, <span class="va">EXSEQ</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">FANLDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">FANLDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">AFRLT</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">FANLDTM</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">ADTM</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"DAYS"</span>,</span>
<span>    floor_in <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute or assign BASETYPE, APERIOD and APHASE ----------------------------------</span></span>
<span><span class="co"># Add study specific code as applicable using ADEX or ADSL APxx / PHw variables</span></span>
<span></span>
<span><span class="va">is_basetype</span> <span class="op">&lt;-</span> <span class="va">is_afrlt</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    APERIOD <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    APERIODC <span class="op">=</span> <span class="st">"Period 01"</span>,</span>
<span>    APHASE <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    APHASEN <span class="op">=</span> <span class="cn">NA_integer_</span>,</span>
<span>    BASETYPE <span class="op">=</span> <span class="st">"DOUBLE_BLINDED"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign AVAL, AVALC, AVALU and DTYPE for each ISTESTCD and ISBDAGNT</span></span>
<span></span>
<span><span class="va">is_aval</span> <span class="op">&lt;-</span> <span class="va">is_basetype</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    MRT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="va">ADAPARM</span> <span class="op">==</span> <span class="st">"XANOMELINE"</span> <span class="op">~</span> <span class="fl">1.4</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="va">ADAPARM</span> <span class="op">==</span> <span class="st">"OTHER_DRUG"</span> <span class="op">~</span> <span class="fl">9.9</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    DTL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="va">ADAPARM</span> <span class="op">==</span> <span class="st">"XANOMELINE"</span> <span class="op">~</span> <span class="fl">999</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="va">ADAPARM</span> <span class="op">==</span> <span class="st">"OTHER_DRUG"</span> <span class="op">~</span> <span class="fl">888</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    RESULTC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">ISSTRESC</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"NEGATIVE"</span>, <span class="st">"NEGATIVE SCREEN"</span>, <span class="st">"NEGATIVE IMMUNODEPLETION"</span>,</span>
<span>        <span class="st">"NEGATIVE CONFIRMATION"</span></span>
<span>      <span class="op">)</span> <span class="op">~</span> <span class="st">"NEGATIVE"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">ISSTRESC</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"NEGATIVE TITER"</span>, <span class="st">"&lt;1.70"</span>, <span class="st">"&lt; 1.70"</span>, <span class="st">"&lt;1.30"</span>, <span class="st">"&lt; 1.30"</span>, <span class="st">"&lt;1.40"</span>,</span>
<span>        <span class="st">"POSITIVE IMMUNODEPLETION"</span>, <span class="st">"POSITIVE CONFIRMATION"</span>, <span class="st">"POSITIVE"</span></span>
<span>      <span class="op">)</span> <span class="op">~</span> <span class="st">"POSITIVE"</span>,</span>
<span>      <span class="va">ISSTRESN</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"POSITIVE"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    RESULTN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">==</span> <span class="st">"NEGATIVE"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ISSTRESN</span><span class="op">)</span> <span class="op">~</span> <span class="va">ISSTRESN</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ISSTRESN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">MRT</span><span class="op">)</span> <span class="op">~</span> <span class="va">MRT</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="co"># NABSTAT gets ISSTRESC, Standard ADA is set to NA as AVAL are numeric original results</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">~</span> <span class="va">ISSTRESC</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">~</span> <span class="va">ISSTRESU</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ISSTRESN</span><span class="op">)</span> <span class="op">~</span> <span class="va">ISSTRESU</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ISSTRESN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">MRT</span><span class="op">)</span></span>
<span>      <span class="op">~</span> <span class="st">"titer"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    DTYPE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ISSTRESN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">MRT</span><span class="op">)</span> <span class="op">~</span> <span class="st">"MRT"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Begin computation of parameters -----------------------------------------</span></span>
<span></span>
<span><span class="co"># Identify Best Baseline for each analyte and parameter type</span></span>
<span><span class="co"># Baseline is NFRLT &lt;= 0 or Unscheduled AND the ADA Date is on or before the date of first dose.</span></span>
<span></span>
<span><span class="va">is_baseline</span> <span class="op">&lt;-</span> <span class="va">is_aval</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ABLFL. If more than one record for the 'order' and 'filter' will throw a duplicate</span></span>
<span>  <span class="co"># record warning, user can decide how to adjust the mode, order, filter or adjust in prior step.</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>      new_var <span class="op">=</span> <span class="va">ABLFL</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># flag baseline based on time not values due to ADA parameters can in some cases permit missing.</span></span>
<span>    <span class="co"># If special visits (i.e. &gt; 60000) are eligible as baselines, include those</span></span>
<span>    filter <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">NFRLT</span> <span class="op">&lt;=</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">NFRLT</span> <span class="op">&gt;</span> <span class="fl">60000</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">ADT</span> <span class="op">&lt;=</span> <span class="va">FANLDT</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">BASETYPE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># VALID flags for use later as applicable:</span></span>
<span>    <span class="co"># VALIDBASE flags non-missing values on baseline (by each ADATYPE and ADAPARM)</span></span>
<span>    <span class="co">#   Note: VALIDBASE is not used as this template allows a baseline to be valid as</span></span>
<span>    <span class="co">#        as long as its present (can be missing), adapt as needed.</span></span>
<span>    <span class="co"># VALIDPOST flags non-missing values on post-baseline (by each ADATYPE and ADAPARM)</span></span>
<span>    VALIDBASE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVALC</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVALC</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    VALIDPOST <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADTM</span> <span class="op">&gt;</span> <span class="va">FANLDTM</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">ADTM</span> <span class="op">&gt;</span> <span class="va">FANLDTM</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute BASE and CHG</span></span>
<span><span class="va">is_aval_change</span> <span class="op">&lt;-</span> <span class="va">is_baseline</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASE</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_chg</span>,</span>
<span>    filter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Interpreted Result Baseline</span></span>
<span><span class="va">is_result_change</span> <span class="op">&lt;-</span> <span class="va">is_aval_change</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">RESULTN</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASE_RESULT</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get base only data for use later</span></span>
<span><span class="va">base_data</span> <span class="op">&lt;-</span> <span class="va">is_result_change</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>, <span class="va">BASE_RESULT</span>, <span class="va">BASE</span>,</span>
<span>    <span class="va">ABLFL</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign and save ADABLPFL for later use</span></span>
<span><span class="va">adablpfl</span> <span class="op">&lt;-</span> <span class="va">is_result_change</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span>, <span class="va">BASETYPE</span>,</span>
<span>    <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    .keep_all <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>, <span class="va">ABLFL</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>ADABLPFL <span class="op">=</span> <span class="va">ABLFL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the By Visit parameters</span></span>
<span><span class="va">is_visit_flags</span> <span class="op">&lt;-</span> <span class="va">is_result_change</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    TFLAGV <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">VALIDPOST</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">BASE_RESULT</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">CHG</span> <span class="op">&gt;=</span> <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="va">VALIDPOST</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="va">BASE_RESULT</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span></span>
<span>        <span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="va">CHG</span> <span class="op">&lt;</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">RESULTN</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>      <span class="va">VALIDPOST</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="op">(</span><span class="va">BASE_RESULT</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">BASE_RESULT</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">RESULTN</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="va">VALIDPOST</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="op">(</span><span class="va">BASE_RESULT</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">BASE_RESULT</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">RESULTN</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    PBFLAGV <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">TFLAGV</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">TFLAGV</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">TFLAGV</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">TFLAGV</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ADASTATV <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PBFLAGV</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">PBFLAGV</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"ADA+"</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PBFLAGV</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">PBFLAGV</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"ADA-"</span>,</span>
<span>      <span class="va">VALIDPOST</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PBFLAGV</span><span class="op">)</span> <span class="op">~</span> <span class="st">"MISSING"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"MISSING"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># These next code segments create utility datasets that will</span></span>
<span><span class="co"># then get merged back into the main dataset (is_visit_flags)</span></span>
<span></span>
<span><span class="co"># Post baseline must be valid post data (result not missing)</span></span>
<span><span class="va">post_data</span> <span class="op">&lt;-</span> <span class="va">is_visit_flags</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">VALIDPOST</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>, <span class="va">RESULTN</span>,</span>
<span>    <span class="va">AVAL</span>, <span class="va">ADTM</span>, <span class="va">CHG</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>AVAL_P <span class="op">=</span> <span class="va">AVAL</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>RESULT_P <span class="op">=</span> <span class="va">RESULTN</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use "post_data" to make a ADPBLPFL flag data set to merge back later in the program</span></span>
<span><span class="co">#  Note:  "post_data" is if VALIDPOST="Y" (has a non missing post baseline result)</span></span>
<span><span class="va">adpblpfl</span> <span class="op">&lt;-</span> <span class="va">post_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>,</span>
<span>    <span class="va">ADAPARM</span>,</span>
<span>    .keep_all <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ADPBLPFL <span class="op">=</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute BFLAG, TFLAG, PBFLAG ----</span></span>
<span></span>
<span><span class="va">most_post_result</span> <span class="op">&lt;-</span> <span class="va">post_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>RESULT_P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">RESULT_P</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">most_post_aval</span> <span class="op">&lt;-</span> <span class="va">post_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL_P</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>AVAL_P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">AVAL_P</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">most_post_chg</span> <span class="op">&lt;-</span> <span class="va">post_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL_P</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>MAXCHG <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">CHG</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge the most_post_result, most_post_aval and most_post_chg into one utility data set</span></span>
<span><span class="va">most_post</span> <span class="op">&lt;-</span> <span class="va">most_post_result</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">most_post_aval</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">most_post_chg</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Use an outer Join to combine baseline with most post results create utility dataset with flag data</span></span>
<span><span class="va">flagdata_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">base_data</span>, <span class="va">most_post</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"DRUG"</span>, <span class="st">"STUDYID"</span>, <span class="st">"USUBJID"</span>, <span class="st">"BASETYPE"</span>,</span>
<span>  <span class="st">"ADATYPE"</span>, <span class="st">"ADAPARM"</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    BFLAG <span class="op">=</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">BASE_RESULT</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>        <span class="va">BASE_RESULT</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>      <span class="op">)</span>,</span>
<span>    TFLAG <span class="op">=</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="op">(</span><span class="va">BFLAG</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">BFLAG</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">RESULT_P</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>        <span class="op">(</span><span class="va">BFLAG</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">BFLAG</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">RESULT_P</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>        <span class="va">BFLAG</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">MAXCHG</span> <span class="op">&gt;=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>        <span class="va">BFLAG</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">MAXCHG</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">MAXCHG</span> <span class="op">&lt;</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>        <span class="va">BFLAG</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">MAXCHG</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">RESULT_P</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>      <span class="op">)</span>,</span>
<span>    PBFLAG <span class="op">=</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">TFLAG</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">TFLAG</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>        <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">TFLAG</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">TFLAG</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>        <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">&amp;</span> <span class="va">RESULT_P</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>        <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">&amp;</span> <span class="va">RESULT_P</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>      <span class="op">)</span>,</span>
<span>    ADASTAT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="va">PBFLAG</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="va">PBFLAG</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get overall ADASTAT status for computing NABSTAT</span></span>
<span><span class="va">flagdata_adastat</span> <span class="op">&lt;-</span> <span class="va">flagdata_init</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">flagdata_init</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>ADASTAT_MAIN <span class="op">=</span> <span class="va">ADASTAT</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute NABPOSTMISS onto flag_data for NABSTAT</span></span>
<span><span class="va">flagdata_nab</span> <span class="op">&lt;-</span> <span class="va">flagdata_adastat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_merged_exist_flag.html">derive_var_merged_exist_flag</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">is_visit_flags</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">NABPOSTMISS</span>,</span>
<span>    condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">VALIDPOST</span> <span class="op">==</span> <span class="st">"N"</span> <span class="op">&amp;</span> <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute NAB Stat using both methods</span></span>
<span><span class="co"># Note: Option 2 added as a placekeeper starter method, adjust as needed for</span></span>
<span><span class="co">#   study specific specs.</span></span>
<span><span class="va">flagdata_final</span> <span class="op">&lt;-</span> <span class="va">flagdata_nab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># For Option 1, if any post baseline NAB were blank without a Positive (NABPOSTMISS = Y),</span></span>
<span>    <span class="co"># NABSTAT = missing</span></span>
<span>    nabstat_opt1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="co"># Based on ADASTAT (EMERNEG/EMERPOS) and NAB results</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">&amp;</span> <span class="va">ADASTAT_MAIN</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">RESULT_P</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">&amp;</span> <span class="va">ADASTAT_MAIN</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">RESULT_P</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span></span>
<span>        <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">NABPOSTMISS</span><span class="op">)</span> <span class="op">|</span> <span class="va">NABPOSTMISS</span> <span class="op">==</span> <span class="st">"N"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    nabstat_opt2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="co"># Based on ADASTAT (EMERNEG/EMERPOS) Only.</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">&amp;</span> <span class="va">ADASTAT_MAIN</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">&amp;</span> <span class="va">ADASTAT_MAIN</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Drop variables no longer needed from flag_data before merging with main ADAB</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">BASE</span>, <span class="op">-</span><span class="va">BASE_RESULT</span>, <span class="op">-</span><span class="va">AVAL_P</span>, <span class="op">-</span><span class="va">RESULT_P</span>, <span class="op">-</span><span class="va">DRUG</span>, <span class="op">-</span><span class="va">ABLFL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Put TFLAG, BFLAG and PBFLAG and the nabstat_ variables onto the main</span></span>
<span><span class="co"># dataset (is_flagdata from is_visit_flags)</span></span>
<span><span class="va">is_flagdata</span> <span class="op">&lt;-</span> <span class="va">is_visit_flags</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># main_aab_flagdata</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">flagdata_final</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a utility data set to compute PERSADA, TRANADA, INDUCED, ENHANCED related parameters</span></span>
<span></span>
<span><span class="va">per_tran_pre</span> <span class="op">&lt;-</span> <span class="va">is_flagdata</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">VALIDPOST</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>, <span class="va">ADTM</span>, <span class="va">FANLDTM</span>, <span class="va">FANLDT</span>,</span>
<span>    <span class="va">TFLAGV</span>, <span class="va">ISSEQ</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    MaxADTM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    LFLAGPOS <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADTM</span> <span class="op">==</span> <span class="va">MaxADTM</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">TFLAGV</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ADTM</span> <span class="op">==</span> <span class="va">MaxADTM</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">TFLAGV</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Keep TFLAGV = 1 or TFLAGV = 2 (Any Treatment Emergent)</span></span>
<span><span class="co"># Regular Induced PERSADA and TRANADA will later be based on TFLAGV = 1</span></span>
<span><span class="co"># TFLAGV = 2 can use for separate PERSADA/TRANADA based on Enhanced</span></span>
<span><span class="va">per_tran_all</span> <span class="op">&lt;-</span> <span class="va">per_tran_pre</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">TFLAGV</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">TFLAGV</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">MaxADTM</span>, <span class="op">-</span><span class="va">ISSEQ</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    FPPDTM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    LPPDTM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">per_tran_inc_last</span> <span class="op">&lt;-</span> <span class="va">per_tran_all</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>COUNT_INC_LAST <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">per_tran_exc_last</span> <span class="op">&lt;-</span> <span class="va">per_tran_all</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LFLAGPOS</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>COUNT_EXC_LAST <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reduce "per_tran_all" to one record per by_vars using ADTM = LPPDTM to get best last records</span></span>
<span><span class="co">#   Then Merge in the Include Last and Exclude Last Flags</span></span>
<span><span class="va">per_tran_last</span> <span class="op">&lt;-</span> <span class="va">per_tran_all</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADTM</span> <span class="op">==</span> <span class="va">LPPDTM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">per_tran_inc_last</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">per_tran_exc_last</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute final parameters</span></span>
<span><span class="va">per_tran_final</span> <span class="op">&lt;-</span> <span class="va">per_tran_last</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    FPPDT <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="va">FPPDTM</span><span class="op">)</span>,</span>
<span>    LPPDT <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="va">LPPDTM</span><span class="op">)</span>,</span>
<span>    ADADUR <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">LPPDTM</span> <span class="op">-</span> <span class="va">FPPDTM</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LPPDTM</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FPPDTM</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">7</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LPPDTM</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FPPDTM</span><span class="op">)</span></span>
<span>      <span class="op">~</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">LPPDTM</span>, <span class="va">FPPDTM</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">60</span> <span class="op">*</span> <span class="fl">60</span> <span class="op">*</span> <span class="fl">24</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">7</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LPPDT</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FPPDT</span><span class="op">)</span></span>
<span>      <span class="op">~</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">LPPDT</span> <span class="op">-</span> <span class="va">FPPDT</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">7</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    TIMADA <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FPPDTM</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FANLDTM</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">FPPDTM</span>, <span class="va">FANLDTM</span>, units <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FPPDT</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FANLDT</span><span class="op">)</span> <span class="op">~</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">FPPDT</span> <span class="op">-</span> <span class="va">FANLDT</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">7</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    tdur <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LPPDTM</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FPPDTM</span><span class="op">)</span> <span class="op">~</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">LPPDTM</span>, <span class="va">FPPDTM</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">7</span> <span class="op">*</span> <span class="fl">3600</span> <span class="op">*</span> <span class="fl">24</span><span class="op">)</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LPPDT</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FPPDT</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">LPPDT</span> <span class="op">-</span> <span class="va">FPPDT</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">7</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Standard TRANADA and PERSADA based on TFLAGV = 1 (Induced)</span></span>
<span>    TRANADA <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAGV</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="op">(</span><span class="va">COUNT_EXC_LAST</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="op">(</span><span class="va">COUNT_INC_LAST</span> <span class="op">&gt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">tdur</span> <span class="op">&lt;</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LFLAGPOS</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    PERSADA <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAGV</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">COUNT_INC_LAST</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">COUNT_EXC_LAST</span> <span class="op">&lt;=</span> <span class="fl">0</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">COUNT_EXC_LAST</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span></span>
<span>        <span class="op">(</span><span class="va">COUNT_INC_LAST</span> <span class="op">&gt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">tdur</span> <span class="op">&gt;=</span> <span class="fl">16</span><span class="op">)</span> <span class="op">|</span> <span class="va">LFLAGPOS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># These TRANADAE and PERSADAE based on TFLAGV = 1 or TFLAGV=2 (Induced or Enhanced)</span></span>
<span>    TRANADAE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAGV</span> <span class="op">&gt;=</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="op">(</span><span class="va">COUNT_EXC_LAST</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="op">(</span><span class="va">COUNT_INC_LAST</span> <span class="op">&gt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">tdur</span> <span class="op">&lt;</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LFLAGPOS</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    PERSADAE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAGV</span> <span class="op">&gt;=</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">COUNT_INC_LAST</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">COUNT_EXC_LAST</span> <span class="op">&lt;=</span> <span class="fl">0</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">COUNT_EXC_LAST</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span></span>
<span>        <span class="op">(</span><span class="va">COUNT_INC_LAST</span> <span class="op">&gt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">tdur</span> <span class="op">&gt;=</span> <span class="fl">16</span><span class="op">)</span> <span class="op">|</span> <span class="va">LFLAGPOS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    INDUCED <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAGV</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"N"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ENHANCED <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAGV</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"N"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Drop temporary variables that do not need to be merged into main ADAB</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ADTM</span>, <span class="op">-</span><span class="va">TFLAGV</span>, <span class="op">-</span><span class="va">FANLDTM</span>, <span class="op">-</span><span class="va">FANLDT</span>, <span class="op">-</span><span class="va">LFLAGPOS</span>, <span class="op">-</span><span class="va">FPPDT</span>, <span class="op">-</span><span class="va">LPPDT</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Put PERSADA, TRANADA, INDUCED, ENHANCED, TDUR, ADADUR onto "is_flagdata" as "main_aab_pertran"</span></span>
<span><span class="co"># Note: signal_duplicate_records() error usually occurs when a subject has duplicate</span></span>
<span><span class="co"># records for a given BASETYPE, ADATYPE, ADAPARM and ISDTC. Investigate then add code</span></span>
<span><span class="co"># to filter it down to best one record per USUBJID, BASETYPE, ADATYPE and ADAPARM</span></span>
<span><span class="va">main_aab_pertran</span> <span class="op">&lt;-</span> <span class="va">is_flagdata</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">per_tran_final</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">main_aab_rtimes</span> <span class="op">&lt;-</span> <span class="va">main_aab_pertran</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ATPT <span class="op">=</span> <span class="va">ISTPT</span>,</span>
<span>    ADADUR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ADADUR</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>    TIMADA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">TIMADA</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>    PERSADA <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PERSADA</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PERSADA</span></span>
<span>    <span class="op">)</span>,</span>
<span>    PERSADAE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PERSADAE</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PERSADAE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    TRANADA <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">TRANADA</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">TRANADA</span></span>
<span>    <span class="op">)</span>,</span>
<span>    TRANADAE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">TRANADAE</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">TRANADAE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    NABSTAT <span class="op">=</span> <span class="va">nabstat_opt1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge ADABLPFL and ADPBFPFL onto main dataset.</span></span>
<span><span class="va">main_aab</span> <span class="op">&lt;-</span> <span class="va">main_aab_rtimes</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adablpfl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADABLPFL</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adpblpfl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADPBLPFL</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Begin Creation of each PARAM for the final ADAB format using main_aab --------</span></span>
<span></span>
<span><span class="co">#  First create "core_aab" with PARCAT1 to be the input for all the parameter sub-assemblies</span></span>
<span><span class="va">core_aab</span> <span class="op">&lt;-</span> <span class="va">main_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># SDTM V1.x: Assign PARAM from ISTEST or customize</span></span>
<span>    PARCAT1 <span class="op">=</span> <span class="va">ISTEST</span>,</span>
<span>    <span class="co"># SDTM V2.x: Assign PARAM using text values plus ADAPARM</span></span>
<span>    PARCAT1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Anti-"</span>, <span class="va">ADAPARM</span>, <span class="st">" Antibody"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>      <span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Anti-"</span>, <span class="va">ADAPARM</span>, <span class="st">" Neutralizing Antibody"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Initialize PARAMCD and PARAM</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="va">ADAPARM</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="va">PARCAT1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># By Visit Primary ADA ISTESTCD Titer Results</span></span>
<span><span class="va">adab_titer</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># For ADASTAT, append "Titer Units" to PARAM</span></span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">PARCAT1</span>, <span class="st">", Titer Units"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># By Visit NAB ISTESTCD Results</span></span>
<span><span class="va">adab_nabvis</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># These two flags, BASE and CHG are only kept on the primary ADA ISTESTCD test</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">BASE</span>, <span class="op">-</span><span class="va">CHG</span>, <span class="op">-</span><span class="va">ADABLPFL</span>, <span class="op">-</span><span class="va">ADPBLPFL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># By Visit Main ADA Titer Interpreted RESULT data</span></span>
<span><span class="va">adab_result</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"RESULTy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ADA interpreted per sample result,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVALC</span> <span class="op">==</span> <span class="st">"NEGATIVE"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="va">AVALC</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># DTYPE is only kept on the primary ISTESTCD parameter, drop then recompute final BASE and CHG</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">DTYPE</span>, <span class="op">-</span><span class="va">BASE</span>, <span class="op">-</span><span class="va">CHG</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive BASE and Calculate Change from Baseline on BAB RESULT records</span></span>
<span><span class="va">adab_result</span> <span class="op">&lt;-</span> <span class="va">adab_result</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASE</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_chg</span>,</span>
<span>    filter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># By Visit NAB Interpreted RESULT data</span></span>
<span><span class="va">adab_nabres</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"RESULTy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Nab interpreted per sample result,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">RESULTC</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVALC</span> <span class="op">==</span> <span class="st">"NEGATIVE"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="va">AVALC</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># These two flags are only kept on the primary ADA test, drop then recompute final BASE and CHG</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ADABLPFL</span>, <span class="op">-</span><span class="va">ADPBLPFL</span>, <span class="op">-</span><span class="va">BASE</span>, <span class="op">-</span><span class="va">CHG</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive BASE and Calculate Change from Baseline on NAB RESULT records</span></span>
<span><span class="va">adab_nabres</span> <span class="op">&lt;-</span> <span class="va">adab_nabres</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASE</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_chg</span>,</span>
<span>    filter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ABLFL</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># By Visit Titer TFLAGV data -----------------------</span></span>
<span></span>
<span><span class="co"># Note: By Visit parameters do not keep CHG, MRT and DTL variables</span></span>
<span><span class="va">adab_tflagv</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"TFLAGV"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Treatment related ADA by Visit,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">TFLAGV</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Drop BASE, CHG, MRT and DTL and the two --FL flags (are only kept on the primary ADA test)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">BASE</span>, <span class="op">-</span><span class="va">CHG</span>, <span class="op">-</span><span class="va">MRT</span>, <span class="op">-</span><span class="va">DTL</span>, <span class="op">-</span><span class="va">ADABLPFL</span>, <span class="op">-</span><span class="va">ADPBLPFL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># By Visit Titer PBFLAGV data ---------------------</span></span>
<span><span class="co"># Note: By Visit parameters do not keep CHG, MRT and DTL variables</span></span>
<span><span class="va">adab_pbflagv</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"PBFLAGV"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Post Baseline Pos/Neg by Visit,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PBFLAGV</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">PBFLAGV</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"POSITIVE"</span>,</span>
<span>      <span class="va">PBFLAGV</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">PBFLAGV</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"NEGATIVE"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"MISSING"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVALC</span> <span class="op">==</span> <span class="st">"POSITIVE"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">AVALC</span> <span class="op">==</span> <span class="st">"NEGATIVE"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Drop BASE, CHG, MRT and DTL and the two --FL flags (are only kept on the primary ADA test)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">BASE</span>, <span class="op">-</span><span class="va">CHG</span>, <span class="op">-</span><span class="va">MRT</span>, <span class="op">-</span><span class="va">DTL</span>, <span class="op">-</span><span class="va">ADABLPFL</span>, <span class="op">-</span><span class="va">ADPBLPFL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># By Visit Titer ADASTATV data</span></span>
<span><span class="co"># Note: By Visit parameters do not keep CHG, MRT and DTL variables</span></span>
<span><span class="va">adab_adastatv</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"ADASTATV"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ADA Status of a patient by Visit,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="va">ADASTATV</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVALC</span> <span class="op">==</span> <span class="st">"ADA+"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">AVALC</span> <span class="op">==</span> <span class="st">"ADA-"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Drop BASE, CHG, MRT and DTL and the two --FL flags (are only kept on the primary ADA test)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">BASE</span>, <span class="op">-</span><span class="va">CHG</span>, <span class="op">-</span><span class="va">MRT</span>, <span class="op">-</span><span class="va">DTL</span>, <span class="op">-</span><span class="va">ADABLPFL</span>, <span class="op">-</span><span class="va">ADPBLPFL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Next below are the individual params</span></span>
<span><span class="co"># assign the AVISIT and AVISITN for individual params</span></span>
<span></span>
<span><span class="va">core_aab</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AVISIT <span class="op">=</span> <span class="va">overall_avisit</span>,</span>
<span>    AVISITN <span class="op">=</span> <span class="va">overall_avisitn</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag BFLAG</span></span>
<span><span class="va">adab_bflag</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">BFLAG</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"BFLAGy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Baseline Pos/Neg,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">BFLAG</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag INDUCD</span></span>
<span><span class="va">adab_incucd</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">TFLAG</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"INDUCDy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Treatment induced ADA,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAG</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag ENHANC</span></span>
<span><span class="va">adab_enhanc</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">TFLAG</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"ENHANCy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Treatment enhanced ADA,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAG</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag EMERPOS</span></span>
<span><span class="va">adab_emerpos</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">PBFLAG</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"EMERPOSy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Treatment Emergent - Positive,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PBFLAG</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag TRUNAFF</span></span>
<span><span class="va">adab_trunaff</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">TFLAG</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"TRUNAFFy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Treatment unaffected,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TFLAG</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag EMERNEG</span></span>
<span><span class="va">adab_emerneg</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">PBFLAG</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"EMERNEGy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Treatment Emergent - Negative,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PBFLAG</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag NOTRREL</span></span>
<span><span class="va">adab_notrrel</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">PBFLAG</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"NOTRRELy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"No treatment related ADA,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PBFLAG</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag ADASTAT</span></span>
<span><span class="va">adab_adastat</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">ADASTAT</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"ADASTATy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ADA Status of a patient,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">ADASTAT</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"POSITIVE"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"NEGATIVE"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"MISSING"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag TIMADA</span></span>
<span><span class="va">adab_timada</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">TIMADA</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"TIMADAy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Time to onset of ADA (Weeks),"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">TIMADA</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span>, <span class="st">"WEEKS"</span>, <span class="cn">NA_character_</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag PERSADA</span></span>
<span><span class="va">adab_persada</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">PERSADA</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"PERSADAy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Persistent ADA,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">PERSADA</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag TRANADA</span></span>
<span><span class="va">adab_tranada</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">TRANADA</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"TRANADAy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Transient ADA,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">TRANADA</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"N"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag NABSTAT</span></span>
<span><span class="va">adab_nabstat</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">NABSTAT</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"NABSTATy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Nab Status,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">NABSTAT</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"POSITIVE"</span>,</span>
<span>      <span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"NEGATIVE"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"MISSING"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag ADADUR</span></span>
<span><span class="va">adab_adadur</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">ADADUR</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"ADADURy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ADA Duration (Weeks),"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">ADADUR</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span>, <span class="st">"WEEKS"</span>, <span class="cn">NA_character_</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag FPPDTM</span></span>
<span><span class="va">adab_fppdtm</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">FPPDTM</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"FPPDTMy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"First Post Dose Positive Datetime,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">FPPDTM</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FPPDTM</span><span class="op">)</span>, <span class="cn">NA_character_</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">FPPDTM</span>, <span class="st">"%d%b%Y:%H:%M:%S"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Get Patient flag LPPDTM</span></span>
<span><span class="va">adab_lppdtm</span> <span class="op">&lt;-</span> <span class="va">core_aab</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADATYPE</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span>, <span class="va">PARAM</span>, <span class="va">ADATYPE</span>, <span class="va">ADAPARM</span>,</span>
<span>    <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ISSPEC</span>, <span class="va">LPPDTM</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"LPPDTMy"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Last Post Dose Positive Datetime,"</span>, <span class="va">PARCAT1</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">LPPDTM</span><span class="op">)</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LPPDTM</span><span class="op">)</span>, <span class="cn">NA_character_</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">LPPDTM</span>, <span class="st">"%d%b%Y:%H:%M:%S"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Set all the standard PARAM components together -----------------------------------</span></span>
<span><span class="va">adab_paramcds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">adab_titer</span>, <span class="va">adab_nabvis</span>, <span class="va">adab_result</span>, <span class="va">adab_nabres</span>, <span class="va">adab_bflag</span>,</span>
<span>  <span class="va">adab_incucd</span>, <span class="va">adab_enhanc</span>, <span class="va">adab_emerpos</span>, <span class="va">adab_trunaff</span>, <span class="va">adab_emerneg</span>, <span class="va">adab_notrrel</span>,</span>
<span>  <span class="va">adab_adastat</span>, <span class="va">adab_timada</span>, <span class="va">adab_persada</span>, <span class="va">adab_tranada</span>, <span class="va">adab_nabstat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># In this sample, also have BY VISIT parameters,</span></span>
<span><span class="va">adab_visits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">adab_tflagv</span>, <span class="va">adab_pbflagv</span>, <span class="va">adab_adastatv</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the final parameterized dataset --------------------------------------------</span></span>
<span></span>
<span><span class="co"># To keep only standard parameters:</span></span>
<span><span class="co"># adab_study &lt;- adab_paramcds</span></span>
<span><span class="co"># To include BY VISIT parameters and/or others:</span></span>
<span><span class="va">adab_study</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">adab_paramcds</span>, <span class="va">adab_visits</span>, <span class="va">adab_adadur</span>, <span class="va">adab_fppdtm</span>, <span class="va">adab_lppdtm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Drop temporary variables and ADA Flag variables that are now parameterized, further below is a</span></span>
<span><span class="co"># final 'select' statement to to customize the final select.</span></span>
<span><span class="va">adab_study</span> <span class="op">&lt;-</span> <span class="va">adab_study</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="op">-</span><span class="va">TIMADA</span>, <span class="op">-</span><span class="va">ADADUR</span>, <span class="op">-</span><span class="va">TRANADA</span>, <span class="op">-</span><span class="va">PERSADA</span>, <span class="op">-</span><span class="va">TRANADAE</span>, <span class="op">-</span><span class="va">PERSADAE</span>, <span class="op">-</span><span class="va">INDUCED</span>, <span class="op">-</span><span class="va">ENHANCED</span>,</span>
<span>    <span class="op">-</span><span class="va">RESULTC</span>, <span class="op">-</span><span class="va">RESULTN</span>, <span class="op">-</span><span class="va">ADASTAT</span>, <span class="op">-</span><span class="va">BFLAG</span>, <span class="op">-</span><span class="va">TFLAG</span>, <span class="op">-</span><span class="va">PBFLAG</span>, <span class="op">-</span><span class="va">FPPDTM</span>, <span class="op">-</span><span class="va">LPPDTM</span>, <span class="op">-</span><span class="va">TFLAGV</span>, <span class="op">-</span><span class="va">PBFLAGV</span>,</span>
<span>    <span class="op">-</span><span class="va">ADASTATV</span>, <span class="op">-</span><span class="va">nabstat_opt1</span>, <span class="op">-</span><span class="va">nabstat_opt2</span>, <span class="op">-</span><span class="va">NABSTAT</span>, <span class="op">-</span><span class="va">MAXCHG</span>, <span class="op">-</span><span class="va">VALIDBASE</span>, <span class="op">-</span><span class="va">VALIDPOST</span>,</span>
<span>    <span class="op">-</span><span class="va">tdur</span>, <span class="op">-</span><span class="va">ADASTAT_MAIN</span>, <span class="op">-</span><span class="va">NABPOSTMISS</span>, <span class="op">-</span><span class="va">TRTSDT</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge in ADSL Values --------------------------------</span></span>
<span><span class="va">adab_adsl</span> <span class="op">&lt;-</span> <span class="va">adab_study</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute COHORT From ADSL, other source could be ADSUB</span></span>
<span><span class="va">adab_cohort</span> <span class="op">&lt;-</span> <span class="va">adab_adsl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>COHORT <span class="op">=</span> <span class="va">ARMCD</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute optional ADAFL</span></span>
<span><span class="co"># Method could be ADSL.SAFFL, ADAB.ADPBLPFL by ISTESTCD, etc.</span></span>
<span><span class="va">adab_adafl</span> <span class="op">&lt;-</span> <span class="va">adab_cohort</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>ADAFL <span class="op">=</span> <span class="va">SAFFL</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Study Specific Specs Post-Processing ------------------------------------</span></span>
<span></span>
<span><span class="co"># Create a Tibble to map above PARAMCD and PARAM to final study spec values</span></span>
<span><span class="co"># Multiple NAB and ADA analytes example usage:</span></span>
<span><span class="co"># If ISTESTCD is 'ADA_BAB' and ISBDAGNT is 'XANOMELINE', RESULT1, ADASTAT1, etc. PARAM_SUFFIX = '(1)'</span></span>
<span><span class="co"># If ISTESTCD is 'ADA_BAB' and ISBDAGNT is 'Y012345678', RESULT2, ADASTAT2, etc. PARAM_SUFFIX = '(2)'</span></span>
<span><span class="co"># If ISTESTCD is 'ADA_NAB' and ISBDAGNT is 'XANOMELINE', RESULT3, etc. PARAM_SUFFIX = '(3)'</span></span>
<span><span class="co"># If ISTESTCD is 'ADA_NAB' and ISBDAGNT is 'Y012345678', RESULT4, etc. PARAM_SUFFIX = '(4)'</span></span>
<span></span>
<span><span class="va">adab_param_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PARAMCD</span>, <span class="op">~</span><span class="va">ADATYPE</span>, <span class="op">~</span><span class="va">ADAPARM</span>, <span class="op">~</span><span class="va">PARAMCD_NEW</span>, <span class="op">~</span><span class="va">PARAM_SUFFIX</span>,</span>
<span>  <span class="st">"XANOMELINE"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"XANOMELINE"</span>, <span class="st">"ADA_NAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"RESULTy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"RESULT1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"RESULTy"</span>, <span class="st">"ADA_NAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"RESULT2"</span>, <span class="st">"(2)"</span>,</span>
<span>  <span class="st">"BFLAGy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"BFLAG1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"INDUCDy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"INDUCD1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"ENHANCy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"ENHANC1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"EMERPOSy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"EMERPOS1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"TRUNAFFy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"TRUNAFF1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"EMERNEGy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"EMERNEG1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"NOTRRELy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"NOTRREL1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"ADASTATy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"ADASTAT1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"TIMADAy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"TIMADA1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"PERSADAy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"PERSADA1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"TRANADAy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"TRANADA1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"NABSTATy"</span>, <span class="st">"ADA_NAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"NABSTAT1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"ADASTATV"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"ADASTTV1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"TFLAGV"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"TFLAGV1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"PBFLAGV"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"PBFLAGV1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"LPPDTMy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"LPPDTM1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"FPPDTMy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"FPPDTM1"</span>, <span class="st">"(1)"</span>,</span>
<span>  <span class="st">"ADADURy"</span>, <span class="st">"ADA_BAB"</span>, <span class="st">"XANOMELINE"</span>, <span class="st">"ADADUR1"</span>, <span class="st">"(1)"</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge the Parameter dataset into the main data</span></span>
<span><span class="va">adab_params</span> <span class="op">&lt;-</span> <span class="va">adab_adafl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adab_param_data</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="va">ADAPARM</span>, <span class="va">ADATYPE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># for the original data, assign PARAM</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PARAM_SUFFIX</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">PARAM</span>, <span class="va">PARAM_SUFFIX</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PARAM</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Example to assign PARAMCD based on ADAPARM assigned at program start (SDTM.IS &lt; v2.0)</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PARAMCD</span> <span class="op">==</span> <span class="va">ADAPARM</span> <span class="op">~</span> <span class="va">PARAMCD</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PARAMCD_NEW</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Example to assign PARAMCD based ISTESTCD type and last 5 chars of ISBDAGNT (SDTM.IS &gt;= v2.0)</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ISTESTCD</span> <span class="op">==</span> <span class="st">"ADA_BAB"</span> <span class="op">&amp;</span> <span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"XANOMELINE"</span> <span class="op">~</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"BAB"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">ISBDAGNT</span>, <span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>      <span class="va">ISTESTCD</span> <span class="op">==</span> <span class="st">"ADA_NAB"</span> <span class="op">&amp;</span> <span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"XANOMELINE"</span> <span class="op">~</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"NAB"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">ISBDAGNT</span>, <span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PARAMCD</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Sort by the key variables then compute ASEQ</span></span>
<span><span class="va">adab_prefinal</span> <span class="op">&lt;-</span> <span class="va">adab_params</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ASEQ</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_obs_number.html">derive_var_obs_number</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ASEQ</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARCAT1</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span>, <span class="va">NFRLT</span>, <span class="va">AFRLT</span>, <span class="va">ISSEQ</span><span class="op">)</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"error"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Choose final variables to keep</span></span>
<span><span class="co"># When SDTM V1.x, suggest remove ISBDAGNT</span></span>
<span><span class="va">adab</span> <span class="op">&lt;-</span> <span class="va">adab_prefinal</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">SUBJID</span>, <span class="va">SITEID</span>, <span class="va">ASEQ</span>,</span>
<span>    <span class="va">REGION1</span>, <span class="va">COUNTRY</span>, <span class="va">ETHNIC</span>,</span>
<span>    <span class="va">AGE</span>, <span class="va">AGEU</span>, <span class="va">SEX</span>, <span class="va">RACE</span>,</span>
<span>    <span class="va">SAFFL</span>, <span class="va">TRT01P</span>, <span class="va">TRT01A</span>,</span>
<span>    <span class="va">TRTSDTM</span>, <span class="va">TRTSDT</span>, <span class="va">TRTEDTM</span>, <span class="va">TRTEDT</span>,</span>
<span>    <span class="va">ISSEQ</span>, <span class="va">ISTESTCD</span>, <span class="va">ISTEST</span>, <span class="va">ISCAT</span>, <span class="va">ISBDAGNT</span>,</span>
<span>    <span class="va">ISSTRESC</span>, <span class="va">ISSTRESN</span>, <span class="va">ISSTRESU</span>,</span>
<span>    <span class="va">ISSTAT</span>, <span class="va">ISREASND</span>, <span class="va">ISSPEC</span>,</span>
<span>    <span class="va">DTL</span>, <span class="va">MRT</span>,</span>
<span>    <span class="va">VISITNUM</span>, <span class="va">VISIT</span>, <span class="va">VISITDY</span>,</span>
<span>    <span class="va">EPOCH</span>, <span class="va">ISDTC</span>, <span class="va">ISDY</span>, <span class="va">ISTPT</span>, <span class="va">ISTPTNUM</span>,</span>
<span>    <span class="va">PARAM</span>, <span class="va">PARAMCD</span>, <span class="va">PARCAT1</span>,</span>
<span>    <span class="va">AVAL</span>, <span class="va">AVALC</span>, <span class="va">AVALU</span>,</span>
<span>    <span class="va">BASETYPE</span>, <span class="va">BASE</span>, <span class="va">CHG</span>, <span class="va">DTYPE</span>,</span>
<span>    <span class="va">ADTM</span>, <span class="va">ADT</span>, <span class="va">ADY</span>, <span class="va">ATMF</span>,</span>
<span>    <span class="va">AVISIT</span>, <span class="va">AVISITN</span>, <span class="va">ATPT</span>,</span>
<span>    <span class="va">APHASE</span>, <span class="va">APHASEN</span>, <span class="va">APERIOD</span>, <span class="va">APERIODC</span>,</span>
<span>    <span class="va">FANLDTM</span>, <span class="va">FANLDT</span>, <span class="va">FANLTM</span>, <span class="va">FANLTMF</span>,</span>
<span>    <span class="va">NFRLT</span>, <span class="va">AFRLT</span>, <span class="va">FRLTU</span>,</span>
<span>    <span class="va">ABLFL</span>, <span class="va">ADABLPFL</span>, <span class="va">ADPBLPFL</span>, <span class="va">ADAFL</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Final Steps, Select final variables and Add labels</span></span>
<span><span class="co"># This process will be based on your metadata, no example given for this reason</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co"># ---- Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adab</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adab.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adae.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADAE</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Adverse Event Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: ae, adsl, ex_single</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="va">ae</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ae.html" class="external-link">ae</a></span></span>
<span><span class="va">suppae</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/suppae.html" class="external-link">suppae</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span><span class="va">ex_single</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/ex_single.html">ex_single</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">ae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ae</span><span class="op">)</span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ex_single</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">DTHDT</span>, <span class="va">EOSDT</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adae</span> <span class="op">&lt;-</span> <span class="va">ae</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># join adsl to ae</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis start time ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">AESTDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span>,</span>
<span>    highest_imputation <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>    min_dates <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis end time ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">AEENDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AEN"</span>,</span>
<span>    highest_imputation <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>    date_imputation <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    max_dates <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">DTHDT</span>, <span class="va">EOSDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis end/start date ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span>, <span class="va">AENDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis start relative day and  analysis end relative day ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span></span>
<span>    reference_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDT</span>, <span class="va">AENDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis duration (value and unit) ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ADURN</span>,</span>
<span>    new_var_unit <span class="op">=</span> <span class="va">ADURU</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">ASTDT</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">AENDT</span>,</span>
<span>    in_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    trunc_out <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ex_ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>  <span class="va">ex</span>,</span>
<span>  dtc <span class="op">=</span> <span class="va">EXSTDTC</span>,</span>
<span>  new_vars_prefix <span class="op">=</span> <span class="st">"EXST"</span>,</span>
<span>  flag_imputation <span class="op">=</span> <span class="st">"none"</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">EXENDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"EXEN"</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    flag_imputation <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">adae</span> <span class="op">&lt;-</span> <span class="va">adae</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive last dose date/time ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_ext</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>LDOSEDTM <span class="op">=</span> <span class="va">EXSTDTM</span><span class="op">)</span>,</span>
<span>    join_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">EXSTDTM</span><span class="op">)</span>,</span>
<span>    join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">EXSTDTM</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"PLACEBO"</span>, <span class="va">EXTRT</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXSTDTM</span><span class="op">)</span>,</span>
<span>    filter_join <span class="op">=</span> <span class="va">EXSTDTM</span> <span class="op">&lt;=</span> <span class="va">ASTDTM</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive treatment dose and unit ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_ext</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>DOSEON <span class="op">=</span> <span class="va">EXDOSE</span>, DOSEU <span class="op">=</span> <span class="va">EXDOSU</span><span class="op">)</span>,</span>
<span>    join_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">EXSTDTM</span>, <span class="va">EXENDTM</span><span class="op">)</span>,</span>
<span>    join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"PLACEBO"</span>, <span class="va">EXTRT</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXSTDTM</span><span class="op">)</span>,</span>
<span>    filter_join <span class="op">=</span> <span class="va">EXSTDTM</span> <span class="op">&lt;=</span> <span class="va">ASTDTM</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">ASTDTM</span> <span class="op">&lt;=</span> <span class="va">EXENDTM</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXENDTM</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive severity / causality / ... ----</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ASEV <span class="op">=</span> <span class="va">AESEV</span>,</span>
<span>    AREL <span class="op">=</span> <span class="va">AEREL</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive treatment emergent flag ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_trtemfl.html">derive_var_trtemfl</a></span><span class="op">(</span></span>
<span>    trt_start_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    trt_end_date <span class="op">=</span> <span class="va">TRTEDT</span>,</span>
<span>    end_window <span class="op">=</span> <span class="fl">30</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive occurrence flags: first occurrence of most severe AE ----</span></span>
<span>  <span class="co"># create numeric value ASEVN for severity</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ASEVN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ASEV</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MILD"</span>, <span class="st">"MODERATE"</span>, <span class="st">"SEVERE"</span>, <span class="st">"DEATH THREATENING"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-desc.html">desc</a></span><span class="op">(</span><span class="va">ASEVN</span><span class="op">)</span>, <span class="va">ASTDTM</span>, <span class="va">AESEQ</span><span class="op">)</span>,</span>
<span>      new_var <span class="op">=</span> <span class="va">AOCCIFL</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"first"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">TRTEMFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Join all ADSL with AE</span></span>
<span><span class="va">adae</span> <span class="op">&lt;-</span> <span class="va">adae</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adae</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adae.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adcm.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADCM</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Concomitant Medications Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: cm, adsl</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="va">cm</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/cm.html" class="external-link">cm</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">cm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">DTHDT</span>, <span class="va">EOSDT</span>, <span class="va">TRT01P</span>, <span class="va">TRT01A</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adcm</span> <span class="op">&lt;-</span> <span class="va">cm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL with CM (only ADSL vars required for derivations)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis start time ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">CMSTDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span>,</span>
<span>    highest_imputation <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>    min_dates <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis end time ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">CMENDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AEN"</span>,</span>
<span>    highest_imputation <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>    date_imputation <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    max_dates <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">DTHDT</span>, <span class="va">EOSDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis end/start date -----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span>, <span class="va">AENDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis start relative day and analysis end relative day ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span></span>
<span>    reference_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDT</span>, <span class="va">AENDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis duration (value and unit) ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ADURN</span>,</span>
<span>    new_var_unit <span class="op">=</span> <span class="va">ADURU</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">ASTDT</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">AENDT</span>,</span>
<span>    in_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    trunc_out <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive flags ----</span></span>
<span><span class="va">adcm</span> <span class="op">&lt;-</span> <span class="va">adcm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive On-Treatment flag</span></span>
<span>  <span class="co"># Set `span_period = TRUE` if you want occurrences that started prior to drug</span></span>
<span>  <span class="co"># intake and ongoing or ended after this time to be considered as on-treatment.</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_ontrtfl.html">derive_var_ontrtfl</a></span><span class="op">(</span></span>
<span>    start_date <span class="op">=</span> <span class="va">ASTDT</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">AENDT</span>,</span>
<span>    ref_start_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    ref_end_date <span class="op">=</span> <span class="va">TRTEDT</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Pre-Treatment flag</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>PREFL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">ASTDT</span> <span class="op">&lt;</span> <span class="va">TRTSDT</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Follow-Up flag</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>FUPFL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">ASTDT</span> <span class="op">&gt;</span> <span class="va">TRTEDT</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive ANL01FL</span></span>
<span>  <span class="co"># This variable is producer specific and may be used to indicate particular</span></span>
<span>  <span class="co"># records to be used in subsequent derivations or analysis.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ANL01FL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive 1st Occurrence of Preferred Term Flag</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      new_var <span class="op">=</span> <span class="va">AOCCPFL</span>,</span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">CMDECOD</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span>, <span class="va">CMSEQ</span><span class="op">)</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"first"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">ANL01FL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Derive APHASE and APHASEN Variable ----</span></span>
<span><span class="co"># Other timing variable can be derived similarly.</span></span>
<span><span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span><span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html)</span></span>
<span><span class="va">adcm</span> <span class="op">&lt;-</span> <span class="va">adcm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    APHASE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PREFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">~</span> <span class="st">"Pre-Treatment"</span>,</span>
<span>      <span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">~</span> <span class="st">"On-Treatment"</span>,</span>
<span>      <span class="va">FUPFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">~</span> <span class="st">"Follow-Up"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    APHASEN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PREFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="va">FUPFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Assign TRTP/TRTA</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    TRTP <span class="op">=</span> <span class="va">TRT01P</span>,</span>
<span>    TRTA <span class="op">=</span> <span class="va">TRT01A</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Join all ADSL with CM</span></span>
<span><span class="va">adcm</span> <span class="op">&lt;-</span> <span class="va">adcm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adcm</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adcm.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adeg.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADEG</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Electrocardiogram Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Description: Based on CDISC Pilot data, create ADEG analysis dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: adsl, eg</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. `haven::read_sas()` to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="va">eg</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/eg.html" class="external-link">eg</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">eg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">eg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lookup tables ----</span></span>
<span></span>
<span><span class="co"># Assign PARAMCD, PARAM, and PARAMN</span></span>
<span><span class="va">param_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">EGTESTCD</span>, <span class="op">~</span><span class="va">PARAMCD</span>,                                                  <span class="op">~</span><span class="va">PARAM</span>, <span class="op">~</span><span class="va">PARAMN</span>,</span>
<span>  <span class="st">"ECGINT"</span>,  <span class="st">"EGINTP"</span>,                                    <span class="st">"ECG Interpretation"</span>,       <span class="fl">1</span>,</span>
<span>  <span class="st">"HR"</span>,          <span class="st">"HR"</span>,                                <span class="st">"Heart Rate (beats/min)"</span>,       <span class="fl">2</span>,</span>
<span>  <span class="st">"RR"</span>,          <span class="st">"RR"</span>,                                      <span class="st">"RR Duration (ms)"</span>,       <span class="fl">3</span>,</span>
<span>  <span class="st">"RRR"</span>,        <span class="st">"RRR"</span>,                            <span class="st">"RR Duration Rederived (ms)"</span>,       <span class="fl">4</span>,</span>
<span>  <span class="st">"QT"</span>,          <span class="st">"QT"</span>,                                      <span class="st">"QT Duration (ms)"</span>,      <span class="fl">10</span>,</span>
<span>  <span class="st">"QTCBR"</span>,    <span class="st">"QTCBR"</span>,     <span class="st">"QTcB - Bazett's Correction Formula Rederived (ms)"</span>,      <span class="fl">11</span>,</span>
<span>  <span class="st">"QTCFR"</span>,    <span class="st">"QTCFR"</span>, <span class="st">"QTcF - Fridericia's Correction Formula Rederived (ms)"</span>,      <span class="fl">12</span>,</span>
<span>  <span class="st">"QTLCR"</span>,    <span class="st">"QTLCR"</span>,      <span class="st">"QTlc - Sagie's Correction Formula Rederived (ms)"</span>,      <span class="fl">13</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">range_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PARAMCD</span>, <span class="op">~</span><span class="va">ANRLO</span>, <span class="op">~</span><span class="va">ANRHI</span>,</span>
<span>  <span class="st">"EGINTP"</span>,     <span class="cn">NA</span>,     <span class="cn">NA</span>,</span>
<span>  <span class="st">"HR"</span>,         <span class="fl">40</span>,    <span class="fl">100</span>,</span>
<span>  <span class="st">"RR"</span>,        <span class="fl">600</span>,   <span class="fl">1500</span>,</span>
<span>  <span class="st">"QT"</span>,        <span class="fl">350</span>,    <span class="fl">450</span>,</span>
<span>  <span class="st">"RRR"</span>,       <span class="fl">600</span>,   <span class="fl">1500</span>,</span>
<span>  <span class="st">"QTCBR"</span>,     <span class="fl">350</span>,    <span class="fl">450</span>,</span>
<span>  <span class="st">"QTCFR"</span>,     <span class="fl">350</span>,    <span class="fl">450</span>,</span>
<span>  <span class="st">"QTLCR"</span>,     <span class="fl">350</span>,    <span class="fl">450</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign AVALCAx</span></span>
<span><span class="va">avalcax_lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">condition</span>,                                                <span class="op">~</span><span class="va">AVALCAT1</span>, <span class="op">~</span><span class="va">AVALCA1N</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="st">"QT"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">AVAL</span> <span class="op">&lt;=</span> <span class="fl">450</span>,                 <span class="st">"&lt;= 450 ms"</span>,         <span class="fl">1</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="st">"QT"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">AVAL</span> <span class="op">&gt;</span> <span class="fl">450</span> <span class="op">&amp;</span> <span class="va">AVAL</span> <span class="op">&lt;=</span> <span class="fl">480</span>, <span class="st">"&gt;450&lt;=480 ms"</span>,         <span class="fl">2</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="st">"QT"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">AVAL</span> <span class="op">&gt;</span> <span class="fl">480</span> <span class="op">&amp;</span> <span class="va">AVAL</span> <span class="op">&lt;=</span> <span class="fl">500</span>, <span class="st">"&gt;480&lt;=500 ms"</span>,         <span class="fl">3</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="st">"QT"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">AVAL</span> <span class="op">&gt;</span> <span class="fl">500</span>,                    <span class="st">"&gt;500 ms"</span>,         <span class="fl">4</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Assign CHGCAx</span></span>
<span><span class="va">chgcax_lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">condition</span>,                                           <span class="op">~</span><span class="va">CHGCAT1</span>, <span class="op">~</span><span class="va">CHGCAT1N</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="st">"QT"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">CHG</span> <span class="op">&lt;=</span> <span class="fl">30</span>,              <span class="st">"&lt;= 30 ms"</span>,         <span class="fl">1</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="st">"QT"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">CHG</span> <span class="op">&gt;</span> <span class="fl">30</span> <span class="op">&amp;</span> <span class="va">CHG</span> <span class="op">&lt;=</span> <span class="fl">60</span>, <span class="st">"&gt;30&lt;=60 ms"</span>,         <span class="fl">2</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="st">"QT"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">CHG</span> <span class="op">&gt;</span> <span class="fl">60</span>,                 <span class="st">"&gt;60 ms"</span>,         <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">TRT01A</span>, <span class="va">TRT01P</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">eg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL &amp; EG (need TRTSDT for ADY derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ADTM, ADY ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">EGDTC</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="va">TRTSDT</span>, source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Add PARAMCD only (add PARAM, etc later) ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged_lookup.html">derive_vars_merged_lookup</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">param_lookup</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">EGTESTCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate AVAL and AVALC ----</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AVAL <span class="op">=</span> <span class="va">EGSTRESN</span>,</span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EGSTRESN</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">EGSTRESN</span><span class="op">)</span> <span class="op">!=</span> <span class="va">EGSTRESC</span>,</span>
<span>      <span class="va">EGSTRESC</span>,</span>
<span>      <span class="cn">NA</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive new parameters based on existing records ----</span></span>
<span>  <span class="co"># Note that, for the following four `derive_param_*()` functions, only the</span></span>
<span>  <span class="co"># variables specified in `by_vars` will be populated in the newly created</span></span>
<span>  <span class="co"># records.</span></span>
<span></span>
<span>  <span class="co"># Derive RRR</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_rr.html">derive_param_rr</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">EGTPT</span>, <span class="va">EGTPTNUM</span>, <span class="va">ADTM</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"RRR"</span><span class="op">)</span>,</span>
<span>    hr_code <span class="op">=</span> <span class="st">"HR"</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">EGSTRESU</span><span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">EGSTAT</span> <span class="op">!=</span> <span class="st">"NOT DONE"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EGSTAT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive QTCBR</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_qtc.html">derive_param_qtc</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">EGTPT</span>, <span class="va">EGTPTNUM</span>, <span class="va">ADTM</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"Bazett"</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"QTCBR"</span><span class="op">)</span>,</span>
<span>    qt_code <span class="op">=</span> <span class="st">"QT"</span>,</span>
<span>    rr_code <span class="op">=</span> <span class="st">"RR"</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="va">EGSTRESU</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">EGSTAT</span> <span class="op">!=</span> <span class="st">"NOT DONE"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EGSTAT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive QTCFR</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_qtc.html">derive_param_qtc</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">EGTPT</span>, <span class="va">EGTPTNUM</span>, <span class="va">ADTM</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"Fridericia"</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"QTCFR"</span><span class="op">)</span>,</span>
<span>    qt_code <span class="op">=</span> <span class="st">"QT"</span>,</span>
<span>    rr_code <span class="op">=</span> <span class="st">"RR"</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="va">EGSTRESU</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">EGSTAT</span> <span class="op">!=</span> <span class="st">"NOT DONE"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EGSTAT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive QTLCR</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_qtc.html">derive_param_qtc</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">EGTPT</span>, <span class="va">EGTPTNUM</span>, <span class="va">ADTM</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"Sagie"</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"QTLCR"</span><span class="op">)</span>,</span>
<span>    qt_code <span class="op">=</span> <span class="st">"QT"</span>,</span>
<span>    rr_code <span class="op">=</span> <span class="st">"RR"</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="va">EGSTRESU</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">EGSTAT</span> <span class="op">!=</span> <span class="st">"NOT DONE"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EGSTAT</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Get visit info ----</span></span>
<span><span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span><span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#visits)</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Timing</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ADT <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/date.html" class="external-link">date</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    ATPTN <span class="op">=</span> <span class="va">EGTPTNUM</span>,</span>
<span>    ATPT <span class="op">=</span> <span class="va">EGTPT</span>,</span>
<span>    AVISIT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">VISIT</span>, <span class="st">"SCREEN|UNSCHED|RETRIEVAL|AMBUL"</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA_character_</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html" class="external-link">str_to_title</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVISITN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">AVISIT</span> <span class="op">==</span> <span class="st">"Baseline"</span> <span class="op">~</span> <span class="st">"0"</span>,</span>
<span>        <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">VISIT</span>, <span class="st">"WEEK"</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_trim</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace</a></span><span class="op">(</span><span class="va">VISIT</span>, <span class="st">"WEEK"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive a summary records representing the mean of the triplicates at each visit ----</span></span>
<span><span class="co"># (if least 2 records available) for all parameter except EGINTP</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_summary_records.html">derive_summary_records</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adeg</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">PARAMCD</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ADT</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">PARAMCD</span> <span class="op">!=</span> <span class="st">"EGINTP"</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"AVERAGE"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ONTRTFL: from trt start up to 30 days after trt ends ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_ontrtfl.html">derive_var_ontrtfl</a></span><span class="op">(</span></span>
<span>    start_date <span class="op">=</span> <span class="va">ADT</span>,</span>
<span>    ref_start_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    ref_end_date <span class="op">=</span> <span class="va">TRTEDT</span>,</span>
<span>    ref_end_window <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    filter_pre_timepoint <span class="op">=</span> <span class="va">AVISIT</span> <span class="op">==</span> <span class="st">"Baseline"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Calculate ANRIND: requires the reference ranges ANRLO, ANRHI ----</span></span>
<span><span class="co"># Also accommodates the ranges A1LO, A1HI</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">range_lookup</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ANRIND</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_anrind.html">derive_var_anrind</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive baseline flags ----</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASETYPE</span></span>
<span>  <span class="fu"><a href="../reference/derive_basetype_records.html">derive_basetype_records</a></span><span class="op">(</span></span>
<span>    basetypes <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      <span class="st">"BASELINE DAY 1"</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ABLFL</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">PARAMCD</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">VISITNUM</span>, <span class="va">EGSEQ</span><span class="op">)</span>,</span>
<span>      new_var <span class="op">=</span> <span class="va">ABLFL</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVALC</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>      <span class="va">ADT</span> <span class="op">&lt;=</span> <span class="va">TRTSDT</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">BASETYPE</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">DTYPE</span> <span class="op">==</span> <span class="st">"AVERAGE"</span> <span class="op">&amp;</span></span>
<span>      <span class="va">PARAMCD</span> <span class="op">!=</span> <span class="st">"EGINTP"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive baseline information ----</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASE</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASEC</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVALC</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASEC</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BNRIND</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">ANRIND</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BNRIND</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate CHG for post-baseline records</span></span>
<span>  <span class="co"># The decision on how to populate pre-baseline and baseline values of CHG is left to producer choice</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_chg</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">AVISITN</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate PCHG for post-baseline records</span></span>
<span>  <span class="co"># The decision on how to populate pre-baseline and baseline values of PCHG is left to producer choice</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_pchg</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">AVISITN</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## ANL01FL: Flag last result within an AVISIT and ATPT for post-baseline records ----</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">AVISIT</span>, <span class="va">ATPT</span>, <span class="va">DTYPE</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">AVAL</span><span class="op">)</span>,</span>
<span>      new_var <span class="op">=</span> <span class="va">ANL01FL</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVISITN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">|</span> <span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">DTYPE</span> <span class="op">==</span> <span class="st">"AVERAGE"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Get treatment information ----</span></span>
<span><span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span><span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#treatment_bds)</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Assign TRTA, TRTP</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>TRTP <span class="op">=</span> <span class="va">TRT01P</span>, TRTA <span class="op">=</span> <span class="va">TRT01A</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Get ASEQ and AVALCAT1/CHGCAT1 and add PARAM/PARAMN ----</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ASEQ</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_obs_number.html">derive_var_obs_number</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ASEQ</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="va">ADT</span>, <span class="va">AVISITN</span>, <span class="va">VISITNUM</span>, <span class="va">ATPTN</span>, <span class="va">DTYPE</span><span class="op">)</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"error"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive AVALCA1N and AVALCAT1</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_cat.html">derive_vars_cat</a></span><span class="op">(</span></span>
<span>    definition <span class="op">=</span> <span class="va">avalcax_lookup</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive CHGCAT1N and CHGCAT1</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_cat.html">derive_vars_cat</a></span><span class="op">(</span></span>
<span>    definition <span class="op">=</span> <span class="va">chgcax_lookup</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive PARAM and PARAMN</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">param_lookup</span>, <span class="op">-</span><span class="va">EGTESTCD</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Add all ADSL variables</span></span>
<span><span class="va">adeg</span> <span class="op">&lt;-</span> <span class="va">adeg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adeg</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adeg.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adex.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADEX</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Exposure Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: adsl, ex</span></span>
<span><span class="co">#</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co">#  as needed and assign to the variables below.</span></span>
<span><span class="co"># The CDISC pilot datasets are used for demonstration purpose.</span></span>
<span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ex.html" class="external-link">ex</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The CDISC pilot data does not contain EXADJ,nor a SUPPEX dataset</span></span>
<span><span class="co"># add a fake EXADJ to demonstrate the derivation for Dose adjustment flag</span></span>
<span><span class="co"># add SUPPEX.EXPLDOS to demonstrate the derivation for dose intensity</span></span>
<span><span class="co"># The CDISC pilot EX datasets, contains exposure data for daily dosing. Care should be taken when</span></span>
<span><span class="co"># the dosing frequency is different.</span></span>
<span></span>
<span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="va">ex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    EXADJ <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">USUBJID</span> <span class="op">==</span> <span class="st">"01-701-1034"</span> <span class="op">&amp;</span> <span class="va">VISIT</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WEEK 2"</span>, <span class="st">"WEEK 24"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"ADVERSE EVENT"</span>,</span>
<span>      <span class="va">USUBJID</span> <span class="op">==</span> <span class="st">"01-701-1148"</span> <span class="op">&amp;</span> <span class="va">VISIT</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WEEK 24"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"MEDICATION ERROR"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    EXDOSE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">USUBJID</span> <span class="op">==</span> <span class="st">"01-701-1034"</span> <span class="op">&amp;</span> <span class="va">VISIT</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WEEK 2"</span>, <span class="st">"WEEK 24"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="va">USUBJID</span> <span class="op">==</span> <span class="st">"01-701-1148"</span> <span class="op">&amp;</span> <span class="va">VISIT</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WEEK 24"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">EXDOSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># add SUPPEX.EXPLDOS to test for dose intensity</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>EXPLDOS <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">EXTRT</span> <span class="op">==</span> <span class="st">"PLACEBO"</span>, <span class="fl">0</span>, <span class="fl">54</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTSDTM</span>, <span class="va">TRTEDTM</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Part 1</span></span>
<span><span class="co"># Join ADSL with ex and derive required dates, variables</span></span>
<span><span class="va">adex0</span> <span class="op">&lt;-</span> <span class="va">ex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL with EX (only ADSL vars required for derivations)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ASTDTM, AENDTM using `derive_vars_dtm()` ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">EXSTDTC</span>,</span>
<span>    highest_imputation <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">EXENDTC</span>,</span>
<span>    highest_imputation <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>    date_imputation <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AEN"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ASTDY, AENDY ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span></span>
<span>    reference_date <span class="op">=</span> <span class="va">TRTSDTM</span>,</span>
<span>    source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span>, <span class="va">AENDTM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Add EXDUR, the duration of trt for each record ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">EXDURD</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">ASTDTM</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">AENDTM</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis end/start date ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span>, <span class="va">AENDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Compute the cumulative dose</span></span>
<span>    DOSEO <span class="op">=</span> <span class="va">EXDOSE</span> <span class="op">*</span> <span class="va">EXDURD</span>,</span>
<span>    PDOSEO <span class="op">=</span> <span class="va">EXPLDOS</span> <span class="op">*</span> <span class="va">EXDURD</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Part 2: 1:1 mapping ----</span></span>
<span></span>
<span><span class="va">adex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">adex0</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"DURD"</span>, AVAL <span class="op">=</span> <span class="va">EXDURD</span><span class="op">)</span>,</span>
<span>  <span class="va">adex0</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"DOSE"</span>, AVAL <span class="op">=</span> <span class="va">DOSEO</span><span class="op">)</span>,</span>
<span>  <span class="va">adex0</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"PLDOSE"</span>, AVAL <span class="op">=</span> <span class="va">PDOSEO</span><span class="op">)</span>,</span>
<span>  <span class="va">adex0</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"ADJ"</span>, AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXADJ</span><span class="op">)</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">adex0</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"ADJAE"</span>, AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">EXADJ</span> <span class="op">==</span> <span class="st">"ADVERSE EVENT"</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>PARCAT1 <span class="op">=</span> <span class="st">"INDIVIDUAL"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Part 3: Derive summary parameters ----</span></span>
<span><span class="co"># Note that, for the functions `derive_param_exposure()`,</span></span>
<span><span class="co"># `derive_param_doseint()` and `derive_param_computed()`, only the variables</span></span>
<span><span class="co"># specified in `by_vars` will be populated in the newly created records.</span></span>
<span></span>
<span><span class="va">adex</span> <span class="op">&lt;-</span> <span class="va">adex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Overall exposure</span></span>
<span>  <span class="fu"><a href="../reference/call_derivation.html">call_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_param_exposure</span>,</span>
<span>    variable_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"TDOSE"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"OVERALL"</span>,</span>
<span>          AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"DOSE"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"TPDOSE"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"OVERALL"</span>,</span>
<span>          AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"PLDOSE"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"TDURD"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"OVERALL"</span>,</span>
<span>          AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"DURD"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"TADJ"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"OVERALL"</span>,</span>
<span>          AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVALC</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"ADJ"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"TADJAE"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"OVERALL"</span>,</span>
<span>          AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVALC</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"ADJAE"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    dataset_add <span class="op">=</span> <span class="va">adex</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># W2-W24 exposure</span></span>
<span>  <span class="fu"><a href="../reference/call_derivation.html">call_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_param_exposure</span>,</span>
<span>    variable_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"PDOSE"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"WEEK 2-24"</span>,</span>
<span>          AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"DOSE"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"PPDOSE"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"WEEK 2-24"</span>,</span>
<span>          AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"PLDOSE"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"PDURD"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"WEEK 2-24"</span>,</span>
<span>          AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"DURD"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"PADJ"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"WEEK 2-24"</span>,</span>
<span>          AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVALC</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"ADJ"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"PADJAE"</span>,</span>
<span>          PARCAT1 <span class="op">=</span> <span class="st">"WEEK 2-24"</span>,</span>
<span>          AVALC <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVALC</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        input_code <span class="op">=</span> <span class="st">"ADJAE"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    dataset_add <span class="op">=</span> <span class="va">adex</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">VISIT</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WEEK 2"</span>, <span class="st">"WEEK 24"</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Overall Dose intensity and W2-24 dose intensity</span></span>
<span>  <span class="fu"><a href="../reference/call_derivation.html">call_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_param_doseint</span>,</span>
<span>    variable_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"TDOSINT"</span><span class="op">)</span>,</span>
<span>        tadm_code <span class="op">=</span> <span class="st">"TDOSE"</span>,</span>
<span>        tpadm_code <span class="op">=</span> <span class="st">"TPDOSE"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"PDOSINT"</span><span class="op">)</span>,</span>
<span>        tadm_code <span class="op">=</span> <span class="st">"PDOSE"</span>,</span>
<span>        tpadm_code <span class="op">=</span> <span class="st">"PPDOSE"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">PARCAT1</span>, <span class="va">ASTDTM</span>, <span class="va">ASTDT</span>, <span class="va">AENDTM</span>, <span class="va">AENDT</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Overall/W2-24 Average daily dose</span></span>
<span>  <span class="fu"><a href="../reference/call_derivation.html">call_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_param_computed</span>,</span>
<span>    variable_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TDOSE"</span>, <span class="st">"TDURD"</span><span class="op">)</span>,</span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          AVAL <span class="op">=</span> <span class="op">(</span><span class="va">AVAL.TDOSE</span> <span class="op">/</span> <span class="va">AVAL.TDURD</span><span class="op">)</span>,</span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"AVDDSE"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PDOSE"</span>, <span class="st">"PDURD"</span><span class="op">)</span>,</span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          AVAL <span class="op">=</span> <span class="op">(</span><span class="va">AVAL.PDOSE</span> <span class="op">/</span> <span class="va">AVAL.PDURD</span><span class="op">)</span>,</span>
<span>          PARAMCD <span class="op">=</span> <span class="st">"PAVDDSE"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">PARCAT1</span>, <span class="va">ASTDTM</span>, <span class="va">ASTDT</span>, <span class="va">AENDTM</span>, <span class="va">AENDT</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Part 4: Derive/Assign the last required variables ----</span></span>
<span></span>
<span><span class="co"># Assign PARAMCD, PARAM, and PARAMN</span></span>
<span><span class="co"># ---- Lookup tables ----</span></span>
<span><span class="va">param_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PARAMCD</span>,                                                     <span class="op">~</span><span class="va">PARAM</span>, <span class="op">~</span><span class="va">PARAMN</span>,</span>
<span>  <span class="st">"DURD"</span>, <span class="st">"Study drug duration during constant dosing interval (days)"</span>,       <span class="fl">1</span>,</span>
<span>  <span class="st">"DOSE"</span>,     <span class="st">"Dose administered during constant dosing interval (mg)"</span>,       <span class="fl">2</span>,</span>
<span>  <span class="st">"PLDOSE"</span>,        <span class="st">"Planned dose during constant dosing interval (mg)"</span>,       <span class="fl">3</span>,</span>
<span>  <span class="st">"ADJ"</span>,               <span class="st">"Dose adjusted during constant dosing interval"</span>,       <span class="fl">4</span>,</span>
<span>  <span class="st">"ADJAE"</span>,  <span class="st">"Dose adjusted  due to AE during constant dosing interval"</span>,       <span class="fl">5</span>,</span>
<span>  <span class="st">"TDURD"</span>,                                   <span class="st">"Overall duration (days)"</span>,       <span class="fl">7</span>,</span>
<span>  <span class="st">"TDOSE"</span>,                              <span class="st">"Total dose administered (mg)"</span>,       <span class="fl">8</span>,</span>
<span>  <span class="st">"AVDDSE"</span>,                  <span class="st">"Average daily dose administered (mg/mg)"</span>,      <span class="fl">10</span>,</span>
<span>  <span class="st">"TPDOSE"</span>,                                  <span class="st">"Total planned dose (mg)"</span>,      <span class="fl">11</span>,</span>
<span>  <span class="st">"TADJ"</span>,                                 <span class="st">"Dose adjusted during study"</span>,      <span class="fl">13</span>,</span>
<span>  <span class="st">"TADJAE"</span>,                     <span class="st">"Dose adjusted during study due to AE"</span>,      <span class="fl">14</span>,</span>
<span>  <span class="st">"PDURD"</span>,                         <span class="st">"Overall duration in W2-W24 (days)"</span>,      <span class="fl">19</span>,</span>
<span>  <span class="st">"PDOSE"</span>,                    <span class="st">"Total dose administered in W2-W2 (mg)4"</span>,      <span class="fl">20</span>,</span>
<span>  <span class="st">"PPDOSE"</span>,                        <span class="st">"Total planned dose in W2-W24 (mg)"</span>,      <span class="fl">21</span>,</span>
<span>  <span class="st">"PAVDDSE"</span>,          <span class="st">"Average daily dose administered in W2-W24 (mg)"</span>,      <span class="fl">23</span>,</span>
<span>  <span class="st">"PADJ"</span>,                                <span class="st">"Dose adjusted during W2-W24"</span>,      <span class="fl">24</span>,</span>
<span>  <span class="st">"PADJAE"</span>,                       <span class="st">"Dose adjusted  in W2-W24 due to AE"</span>,      <span class="fl">25</span>,</span>
<span>  <span class="st">"TDOSINT"</span>,                              <span class="st">"Overall dose intensity (%)"</span>,      <span class="fl">90</span>,</span>
<span>  <span class="st">"PDOSINT"</span>,                                <span class="st">"W2-24 dose intensity (%)"</span>,      <span class="fl">91</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign AVALCATx</span></span>
<span><span class="va">avalcax_lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PARAMCD</span>,            <span class="op">~</span><span class="va">condition</span>,             <span class="op">~</span><span class="va">AVALCAT1</span>,</span>
<span>  <span class="st">"TDURD"</span>,             <span class="va">AVAL</span> <span class="op">&gt;=</span> <span class="fl">90</span>,          <span class="st">"&gt;= 90 days"</span>,</span>
<span>  <span class="st">"TDURD"</span>, <span class="va">AVAL</span> <span class="op">&gt;=</span> <span class="fl">30</span> <span class="op">&amp;</span> <span class="va">AVAL</span> <span class="op">&lt;</span> <span class="fl">90</span>, <span class="st">"&gt;= 30 and &lt; 90 days"</span>,</span>
<span>  <span class="st">"TDURD"</span>,              <span class="va">AVAL</span> <span class="op">&lt;</span> <span class="fl">30</span>,           <span class="st">"&lt; 30 days"</span>,</span>
<span>  <span class="st">"PDURD"</span>,             <span class="va">AVAL</span> <span class="op">&gt;=</span> <span class="fl">90</span>,          <span class="st">"&gt;= 90 days"</span>,</span>
<span>  <span class="st">"PDURD"</span>, <span class="va">AVAL</span> <span class="op">&gt;=</span> <span class="fl">30</span> <span class="op">&amp;</span> <span class="va">AVAL</span> <span class="op">&lt;</span> <span class="fl">90</span>, <span class="st">"&gt;= 30 and &lt; 90 days"</span>,</span>
<span>  <span class="st">"PDURD"</span>,              <span class="va">AVAL</span> <span class="op">&lt;</span> <span class="fl">30</span>,           <span class="st">"&lt; 30 days"</span>,</span>
<span>  <span class="st">"TDOSE"</span>,             <span class="va">AVAL</span> <span class="op">&lt;</span> <span class="fl">100</span>,            <span class="st">"&lt; 100 mg"</span>,</span>
<span>  <span class="st">"TDOSE"</span>,            <span class="va">AVAL</span> <span class="op">&gt;=</span> <span class="fl">100</span>,           <span class="st">"&gt;= 100 mg"</span>,</span>
<span>  <span class="st">"PDOSE"</span>,             <span class="va">AVAL</span> <span class="op">&lt;</span> <span class="fl">100</span>,            <span class="st">"&lt; 100 mg"</span>,</span>
<span>  <span class="st">"PDOSE"</span>,            <span class="va">AVAL</span> <span class="op">&gt;=</span> <span class="fl">100</span>,           <span class="st">"&gt;= 100 mg"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">adex</span> <span class="op">&lt;-</span> <span class="va">adex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Add PARAMN and PARAM, AVALU</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">param_lookup</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive AVALCATx</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_cat.html">derive_vars_cat</a></span><span class="op">(</span></span>
<span>    definition <span class="op">=</span> <span class="va">avalcax_lookup</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ASEQ</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_obs_number.html">derive_var_obs_number</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ASEQ</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARCAT1</span>, <span class="va">ASTDT</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">EXSEQ</span>, <span class="va">PARAMN</span><span class="op">)</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"error"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Join all ADSL with EX</span></span>
<span><span class="va">adex</span> <span class="op">&lt;-</span> <span class="va">adex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Final Steps, Select final variables and Add labels</span></span>
<span><span class="co"># This process will be based on your metadata, no example given for this reason</span></span>
<span><span class="co"># ...</span></span>
<span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adex</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adex.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adlb.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADLB</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Lab Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: adsl, lb</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="va">lb</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/lb.html" class="external-link">lb</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">lb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look-up tables ----</span></span>
<span></span>
<span><span class="co"># Assign PARAMCD, PARAM, and PARAMN</span></span>
<span><span class="va">param_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">LBTESTCD</span>, <span class="op">~</span><span class="va">PARAMCD</span>,                                             <span class="op">~</span><span class="va">PARAM</span>, <span class="op">~</span><span class="va">PARAMN</span>,</span>
<span>  <span class="st">"ALB"</span>,        <span class="st">"ALB"</span>,                                    <span class="st">"Albumin (g/L)"</span>,       <span class="fl">1</span>,</span>
<span>  <span class="st">"ALP"</span>,      <span class="st">"ALKPH"</span>,                       <span class="st">"Alkaline Phosphatase (U/L)"</span>,       <span class="fl">2</span>,</span>
<span>  <span class="st">"ALT"</span>,        <span class="st">"ALT"</span>,                   <span class="st">"Alanine Aminotransferase (U/L)"</span>,       <span class="fl">3</span>,</span>
<span>  <span class="st">"ANISO"</span>,    <span class="st">"ANISO"</span>,                                       <span class="st">"Anisocytes"</span>,       <span class="fl">4</span>,</span>
<span>  <span class="st">"AST"</span>,        <span class="st">"AST"</span>,                 <span class="st">"Aspartate Aminotransferase (U/L)"</span>,       <span class="fl">5</span>,</span>
<span>  <span class="st">"BASO"</span>,      <span class="st">"BASO"</span>,                           <span class="st">"Basophils Abs (10^9/L)"</span>,       <span class="fl">6</span>,</span>
<span>  <span class="st">"BASOLE"</span>,  <span class="st">"BASOLE"</span>,                  <span class="st">"Basophils/Leukocytes (FRACTION)"</span>,       <span class="fl">7</span>,</span>
<span>  <span class="st">"BILI"</span>,      <span class="st">"BILI"</span>,                               <span class="st">"Bilirubin (umol/L)"</span>,       <span class="fl">8</span>,</span>
<span>  <span class="st">"BUN"</span>,        <span class="st">"BUN"</span>,                     <span class="st">"Blood Urea Nitrogen (mmol/L)"</span>,       <span class="fl">9</span>,</span>
<span>  <span class="st">"CA"</span>,          <span class="st">"CA"</span>,                                 <span class="st">"Calcium (mmol/L)"</span>,      <span class="fl">10</span>,</span>
<span>  <span class="st">"CHOL"</span>,    <span class="st">"CHOLES"</span>,                             <span class="st">"Cholesterol (mmol/L)"</span>,      <span class="fl">11</span>,</span>
<span>  <span class="st">"CK"</span>,          <span class="st">"CK"</span>,                          <span class="st">"Creatinine Kinase (U/L)"</span>,      <span class="fl">12</span>,</span>
<span>  <span class="st">"CL"</span>,          <span class="st">"CL"</span>,                                <span class="st">"Chloride (mmol/L)"</span>,      <span class="fl">13</span>,</span>
<span>  <span class="st">"COLOR"</span>,    <span class="st">"COLOR"</span>,                                            <span class="st">"Color"</span>,      <span class="fl">14</span>,</span>
<span>  <span class="st">"CREAT"</span>,    <span class="st">"CREAT"</span>,                              <span class="st">"Creatinine (umol/L)"</span>,      <span class="fl">15</span>,</span>
<span>  <span class="st">"EOS"</span>,        <span class="st">"EOS"</span>,                             <span class="st">"Eosinophils (10^9/L)"</span>,      <span class="fl">16</span>,</span>
<span>  <span class="st">"EOSLE"</span>,    <span class="st">"EOSLE"</span>,                <span class="st">"Eosinophils/Leukocytes (FRACTION)"</span>,      <span class="fl">17</span>,</span>
<span>  <span class="st">"GGT"</span>,        <span class="st">"GGT"</span>,                 <span class="st">"Gamma Glutamyl Transferase (U/L)"</span>,      <span class="fl">18</span>,</span>
<span>  <span class="st">"GLUC"</span>,      <span class="st">"GLUC"</span>,                                 <span class="st">"Glucose (mmol/L)"</span>,      <span class="fl">19</span>,</span>
<span>  <span class="st">"HBA1C"</span>,    <span class="st">"HBA1C"</span>,                               <span class="st">"Hemoglobin A1C (1)"</span>,      <span class="fl">20</span>,</span>
<span>  <span class="st">"HCT"</span>,        <span class="st">"HCT"</span>,                                   <span class="st">"Hematocrit (1)"</span>,      <span class="fl">21</span>,</span>
<span>  <span class="st">"HGB"</span>,        <span class="st">"HGB"</span>,                              <span class="st">"Hemoglobin (mmol/L)"</span>,      <span class="fl">22</span>,</span>
<span>  <span class="st">"K"</span>,        <span class="st">"POTAS"</span>,                               <span class="st">"Potassium (mmol/L)"</span>,      <span class="fl">23</span>,</span>
<span>  <span class="st">"KETONES"</span>,  <span class="st">"KETON"</span>,                                          <span class="st">"Ketones"</span>,      <span class="fl">24</span>,</span>
<span>  <span class="st">"LYM"</span>,      <span class="st">"LYMPH"</span>,                         <span class="st">"Lymphocytes Abs (10^9/L)"</span>,      <span class="fl">25</span>,</span>
<span>  <span class="st">"LYMLE"</span>,  <span class="st">"LYMPHLE"</span>,                <span class="st">"Lymphocytes/Leukocytes (FRACTION)"</span>,      <span class="fl">26</span>,</span>
<span>  <span class="st">"MACROCY"</span>, <span class="st">"MACROC"</span>,                                       <span class="st">"Macrocytes"</span>,      <span class="fl">27</span>,</span>
<span>  <span class="st">"MCH"</span>,        <span class="st">"MCH"</span>,      <span class="st">"Ery. Mean Corpuscular Hemoglobin (fmol(Fe))"</span>,      <span class="fl">28</span>,</span>
<span>  <span class="st">"MCHC"</span>,      <span class="st">"MCHC"</span>, <span class="st">"Ery. Mean Corpuscular HGB Concentration (mmol/L)"</span>,      <span class="fl">29</span>,</span>
<span>  <span class="st">"MCV"</span>,        <span class="st">"MCV"</span>,               <span class="st">"Ery. Mean Corpuscular Volume (f/L)"</span>,      <span class="fl">30</span>,</span>
<span>  <span class="st">"MICROCY"</span>, <span class="st">"MICROC"</span>,                                       <span class="st">"Microcytes"</span>,      <span class="fl">31</span>,</span>
<span>  <span class="st">"MONO"</span>,      <span class="st">"MONO"</span>,                               <span class="st">"Monocytes (10^9/L)"</span>,      <span class="fl">32</span>,</span>
<span>  <span class="st">"MONOLE"</span>,  <span class="st">"MONOLE"</span>,                  <span class="st">"Monocytes/Leukocytes (FRACTION)"</span>,      <span class="fl">33</span>,</span>
<span>  <span class="st">"PH"</span>,          <span class="st">"PH"</span>,                                               <span class="st">"pH"</span>,      <span class="fl">34</span>,</span>
<span>  <span class="st">"PHOS"</span>,      <span class="st">"PHOS"</span>,                               <span class="st">"Phosphate (mmol/L)"</span>,      <span class="fl">35</span>,</span>
<span>  <span class="st">"PLAT"</span>,      <span class="st">"PLAT"</span>,                                <span class="st">"Platelet (10^9/L)"</span>,      <span class="fl">36</span>,</span>
<span>  <span class="st">"POIKILO"</span>, <span class="st">"POIKIL"</span>,                                     <span class="st">"Poikilocytes"</span>,      <span class="fl">37</span>,</span>
<span>  <span class="st">"POLYCHR"</span>, <span class="st">"POLYCH"</span>,                                    <span class="st">"Polychromasia"</span>,      <span class="fl">38</span>,</span>
<span>  <span class="st">"PROT"</span>,      <span class="st">"PROT"</span>,                                    <span class="st">"Protein (g/L)"</span>,      <span class="fl">39</span>,</span>
<span>  <span class="st">"RBC"</span>,        <span class="st">"RBC"</span>,                              <span class="st">"Erythrocytes (TI/L)"</span>,      <span class="fl">40</span>,</span>
<span>  <span class="st">"SODIUM"</span>,  <span class="st">"SODIUM"</span>,                                  <span class="st">"Sodium (mmol/L)"</span>,      <span class="fl">41</span>,</span>
<span>  <span class="st">"SPGRAV"</span>,  <span class="st">"SPGRAV"</span>,                                 <span class="st">"Specific Gravity"</span>,      <span class="fl">42</span>,</span>
<span>  <span class="st">"TSH"</span>,        <span class="st">"TSH"</span>,                               <span class="st">"Thyrotropin (mU/L)"</span>,      <span class="fl">43</span>,</span>
<span>  <span class="st">"URATE"</span>,    <span class="st">"URATE"</span>,                                   <span class="st">"Urate (umol/L)"</span>,      <span class="fl">44</span>,</span>
<span>  <span class="st">"UROBIL"</span>,  <span class="st">"UROBIL"</span>,                                     <span class="st">"Urobilinogen"</span>,      <span class="fl">45</span>,</span>
<span>  <span class="st">"VITB12"</span>,  <span class="st">"VITB12"</span>,                             <span class="st">"Vitamin B12 (pmol/L)"</span>,      <span class="fl">46</span>,</span>
<span>  <span class="st">"WBC"</span>,        <span class="st">"WBC"</span>,                              <span class="st">"Leukocytes (10^9/L)"</span>,      <span class="fl">47</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">TRT01A</span>, <span class="va">TRT01P</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">lb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL with LB (need TRTSDT for ADY derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ADT, ADY ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">LBDTC</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="va">TRTSDT</span>, source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Add PARAMCD PARAM and PARAMN - from LOOK-UP table ----</span></span>
<span>  <span class="co"># Replace with PARAMCD lookup function</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged_lookup.html">derive_vars_merged_lookup</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">param_lookup</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="va">PARAM</span>, <span class="va">PARAMN</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">LBTESTCD</span><span class="op">)</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>    print_not_mapped <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate PARCAT1 AVAL AVALC ANRLO ANRHI ----</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARCAT1 <span class="op">=</span> <span class="va">LBCAT</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">LBSTRESN</span>,</span>
<span>    <span class="co"># Only populate AVALC if character value is non-redundant with AVAL</span></span>
<span>    AVALC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LBSTRESN</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">LBSTRESN</span><span class="op">)</span> <span class="op">!=</span> <span class="va">LBSTRESC</span>,</span>
<span>      <span class="va">LBSTRESC</span>,</span>
<span>      <span class="cn">NA</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ANRLO <span class="op">=</span> <span class="va">LBSTNRLO</span>,</span>
<span>    ANRHI <span class="op">=</span> <span class="va">LBSTNRHI</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive Absolute values from fractional Differentials using WBC</span></span>
<span><span class="co"># Only derive where absolute values do not already exist</span></span>
<span><span class="co"># Need to populate ANRLO and ANRHI for newly created records</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive absolute Basophils</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_wbc_abs.html">derive_param_wbc_abs</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">DOMAIN</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">ADT</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      PARAMCD <span class="op">=</span> <span class="st">"BASO"</span>,</span>
<span>      PARAM <span class="op">=</span> <span class="st">"Basophils Abs (10^9/L)"</span>,</span>
<span>      PARAMN <span class="op">=</span> <span class="fl">6</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"CALCULATION"</span>,</span>
<span>      PARCAT1 <span class="op">=</span> <span class="st">"HEMATOLOGY"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="fu"><a href="../reference/extract_unit.html">extract_unit</a></span><span class="op">(</span><span class="va">PARAM</span><span class="op">)</span>,</span>
<span>    diff_code <span class="op">=</span> <span class="st">"BASOLE"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive absolute Lymphocytes</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_wbc_abs.html">derive_param_wbc_abs</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">DOMAIN</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">ADT</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      PARAMCD <span class="op">=</span> <span class="st">"LYMPH"</span>,</span>
<span>      PARAM <span class="op">=</span> <span class="st">"Lymphocytes Abs (10^9/L)"</span>,</span>
<span>      PARAMN <span class="op">=</span> <span class="fl">25</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"CALCULATION"</span>,</span>
<span>      PARCAT1 <span class="op">=</span> <span class="st">"HEMATOLOGY"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="fu"><a href="../reference/extract_unit.html">extract_unit</a></span><span class="op">(</span><span class="va">PARAM</span><span class="op">)</span>,</span>
<span>    diff_code <span class="op">=</span> <span class="st">"LYMPHLE"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Get Visit Info ----</span></span>
<span><span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span><span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#visits)</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Timing</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AVISIT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">VISIT</span>, <span class="st">"SCREEN"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Baseline"</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html" class="external-link">str_to_title</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVISITN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AVISIT</span> <span class="op">==</span> <span class="st">"Baseline"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">VISITNUM</span><span class="op">)</span> <span class="op">~</span> <span class="va">VISITNUM</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ONTRTFL ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_ontrtfl.html">derive_var_ontrtfl</a></span><span class="op">(</span></span>
<span>    start_date <span class="op">=</span> <span class="va">ADT</span>,</span>
<span>    ref_start_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    ref_end_date <span class="op">=</span> <span class="va">TRTEDT</span>,</span>
<span>    filter_pre_timepoint <span class="op">=</span> <span class="va">AVISIT</span> <span class="op">==</span> <span class="st">"Baseline"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Calculate ANRIND : requires the reference ranges ANRLO, ANRHI ----</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_anrind.html">derive_var_anrind</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive baseline flags ----</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASETYPE</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    BASETYPE <span class="op">=</span> <span class="st">"LAST"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ABLFL</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">PARAMCD</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">VISITNUM</span>, <span class="va">LBSEQ</span><span class="op">)</span>,</span>
<span>      new_var <span class="op">=</span> <span class="va">ABLFL</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ADT</span> <span class="op">&lt;=</span> <span class="va">TRTSDT</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">BASETYPE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive baseline information ----</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASE</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASEC</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVALC</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASEC</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BNRIND</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">ANRIND</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BNRIND</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate CHG for post-baseline records</span></span>
<span>  <span class="co"># The decision on how to populate pre-baseline and baseline values of CHG is left to producer choice</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_chg</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">AVISITN</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate PCHG for post-baseline records</span></span>
<span>  <span class="co"># The decision on how to populate pre-baseline and baseline values of PCHG is left to producer choice</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_pchg</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">AVISITN</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Calculate lab grading ----</span></span>
<span></span>
<span><span class="co"># Assign ATOXDSCL and ATOXDSCH to hold lab grading terms</span></span>
<span><span class="co"># ATOXDSCL and ATOXDSCH hold terms defined by NCI-CTCAEv4.</span></span>
<span><span class="co"># See (https://pharmaverse.github.io/admiral/cran-release/articles/lab_grading.html#implement_ctcv4)</span></span>
<span><span class="va">grade_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PARAMCD</span>,                  <span class="op">~</span><span class="va">ATOXDSCL</span>,                              <span class="op">~</span><span class="va">ATOXDSCH</span>,</span>
<span>  <span class="st">"ALB"</span>,             <span class="st">"Hypoalbuminemia"</span>,                          <span class="cn">NA_character_</span>,</span>
<span>  <span class="st">"ALKPH"</span>,               <span class="cn">NA_character_</span>,       <span class="st">"Alkaline phosphatase increased"</span>,</span>
<span>  <span class="st">"ALT"</span>,                 <span class="cn">NA_character_</span>,   <span class="st">"Alanine aminotransferase increased"</span>,</span>
<span>  <span class="st">"AST"</span>,                 <span class="cn">NA_character_</span>, <span class="st">"Aspartate aminotransferase increased"</span>,</span>
<span>  <span class="st">"BILI"</span>,                <span class="cn">NA_character_</span>,            <span class="st">"Blood bilirubin increased"</span>,</span>
<span>  <span class="st">"CA"</span>,                 <span class="st">"Hypocalcemia"</span>,                        <span class="st">"Hypercalcemia"</span>,</span>
<span>  <span class="st">"CHOLES"</span>,              <span class="cn">NA_character_</span>,                     <span class="st">"Cholesterol high"</span>,</span>
<span>  <span class="st">"CK"</span>,                  <span class="cn">NA_character_</span>,                        <span class="st">"CPK increased"</span>,</span>
<span>  <span class="st">"CREAT"</span>,               <span class="cn">NA_character_</span>,                 <span class="st">"Creatinine increased"</span>,</span>
<span>  <span class="st">"GGT"</span>,                 <span class="cn">NA_character_</span>,                        <span class="st">"GGT increased"</span>,</span>
<span>  <span class="st">"GLUC"</span>,               <span class="st">"Hypoglycemia"</span>,                        <span class="st">"Hyperglycemia"</span>,</span>
<span>  <span class="st">"HGB"</span>,                      <span class="st">"Anemia"</span>,                 <span class="st">"Hemoglobin increased"</span>,</span>
<span>  <span class="st">"POTAS"</span>,               <span class="st">"Hypokalemia"</span>,                         <span class="st">"Hyperkalemia"</span>,</span>
<span>  <span class="st">"LYMPH"</span>, <span class="st">"CD4 lymphocytes decreased"</span>,                          <span class="cn">NA_character_</span>,</span>
<span>  <span class="st">"PHOS"</span>,           <span class="st">"Hypophosphatemia"</span>,                          <span class="cn">NA_character_</span>,</span>
<span>  <span class="st">"PLAT"</span>,   <span class="st">"Platelet count decreased"</span>,                          <span class="cn">NA_character_</span>,</span>
<span>  <span class="st">"SODIUM"</span>,             <span class="st">"Hyponatremia"</span>,                        <span class="st">"Hypernatremia"</span>,</span>
<span>  <span class="st">"WBC"</span>,  <span class="st">"White blood cell decreased"</span>,                         <span class="st">"Leukocytosis"</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign grade criteria</span></span>
<span><span class="co"># metadata atoxgr_criteria_ctcv4 used to implement NCI-CTCAEv4</span></span>
<span><span class="co"># user could change to atoxgr_criteria_ctcv5 to implement NCI-CTCAEv5</span></span>
<span><span class="co"># Note: Hyperglycemia and Hypophosphatemia not defined in NCI-CTCAEv5 so</span></span>
<span><span class="co"># user would need to amend look-up table grade_lookup</span></span>
<span><span class="co"># See (https://pharmaverse.github.io/admiral/cran-release/articles/lab_grading.html#implement_ctcv5)</span></span>
<span><span class="va">grade_crit</span> <span class="op">&lt;-</span> <span class="va">atoxgr_criteria_ctcv4</span></span>
<span></span>
<span></span>
<span><span class="co"># Add ATOXDSCL and ATOXDSCH</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">grade_lookup</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># if implementing NCI-CTCAEv5 or NCI-CTCAEv6 then arguments `high_indicator` and `low_indicator`</span></span>
<span>  <span class="co"># should be assigned in all calls to function `derive_var_atoxgr_dir` below</span></span>
<span>  <span class="co"># Derive toxicity grade for low values ATOXGRL</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_atoxgr_dir.html">derive_var_atoxgr_dir</a></span><span class="op">(</span></span>
<span>    meta_criteria <span class="op">=</span> <span class="va">grade_crit</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">ATOXGRL</span>,</span>
<span>    tox_description_var <span class="op">=</span> <span class="va">ATOXDSCL</span>,</span>
<span>    criteria_direction <span class="op">=</span> <span class="st">"L"</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="fu"><a href="../reference/extract_unit.html">extract_unit</a></span><span class="op">(</span><span class="va">PARAM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive toxicity grade for high values ATOXGRH</span></span>
<span>  <span class="co"># default metadata atoxgr_criteria_ctcv4 used</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_atoxgr_dir.html">derive_var_atoxgr_dir</a></span><span class="op">(</span></span>
<span>    meta_criteria <span class="op">=</span> <span class="va">grade_crit</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">ATOXGRH</span>,</span>
<span>    tox_description_var <span class="op">=</span> <span class="va">ATOXDSCH</span>,</span>
<span>    criteria_direction <span class="op">=</span> <span class="st">"H"</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="fu"><a href="../reference/extract_unit.html">extract_unit</a></span><span class="op">(</span><span class="va">PARAM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># (Optional) derive overall grade ATOXGR (combining ATOXGRL and ATOXGRH)</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_atoxgr.html">derive_var_atoxgr</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive baseline toxicity grade for low values BTOXGRL</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">ATOXGRL</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BTOXGRL</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive baseline toxicity grade for high values BTOXGRH</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">ATOXGRH</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BTOXGRH</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive baseline toxicity grade for for overall grade BTOXGR</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">ATOXGR</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BTOXGR</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Calculate R2BASE, R2ANRLO and R2ANRHI ----</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_analysis_ratio.html">derive_var_analysis_ratio</a></span><span class="op">(</span></span>
<span>    numer_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    denom_var <span class="op">=</span> <span class="va">BASE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_analysis_ratio.html">derive_var_analysis_ratio</a></span><span class="op">(</span></span>
<span>    numer_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    denom_var <span class="op">=</span> <span class="va">ANRLO</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_analysis_ratio.html">derive_var_analysis_ratio</a></span><span class="op">(</span></span>
<span>    numer_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    denom_var <span class="op">=</span> <span class="va">ANRHI</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## SHIFT derivation ----</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive shift from baseline for analysis indicator</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_shift.html">derive_var_shift</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">SHIFT1</span>,</span>
<span>    from_var <span class="op">=</span> <span class="va">BNRIND</span>,</span>
<span>    to_var <span class="op">=</span> <span class="va">ANRIND</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive shift from baseline for overall grade</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_shift</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      new_var <span class="op">=</span> <span class="va">SHIFT2</span>,</span>
<span>      from_var <span class="op">=</span> <span class="va">BTOXGR</span>,</span>
<span>      to_var <span class="op">=</span> <span class="va">ATOXGR</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ATOXDSCL</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ATOXDSCH</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Flag variables (ANL01FL, LVOTFL) ----</span></span>
<span><span class="co"># ANL01FL: Flag last result within an AVISIT for post-baseline records</span></span>
<span><span class="co"># LVOTFL: Flag last valid on-treatment record</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">AVISIT</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">AVAL</span><span class="op">)</span>,</span>
<span>      new_var <span class="op">=</span> <span class="va">ANL01FL</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVISITN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">PARAMCD</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">AVAL</span><span class="op">)</span>,</span>
<span>      new_var <span class="op">=</span> <span class="va">LVOTFL</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Get treatment information ----</span></span>
<span><span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span><span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#treatment_bds)</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Assign TRTA, TRTP</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    TRTP <span class="op">=</span> <span class="va">TRT01P</span>,</span>
<span>    TRTA <span class="op">=</span> <span class="va">TRT01A</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Get extreme values ----</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># get MINIMUM value</span></span>
<span>  <span class="fu"><a href="../reference/derive_extreme_records.html">derive_extreme_records</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adlb</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AVAL</span>, <span class="va">ADT</span>, <span class="va">AVISITN</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      AVISITN <span class="op">=</span> <span class="fl">9997</span>,</span>
<span>      AVISIT <span class="op">=</span> <span class="st">"POST-BASELINE MINIMUM"</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"MINIMUM"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># get MAXIMUM value</span></span>
<span>  <span class="fu"><a href="../reference/derive_extreme_records.html">derive_extreme_records</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adlb</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-desc.html">desc</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span>, <span class="va">ADT</span>, <span class="va">AVISITN</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      AVISITN <span class="op">=</span> <span class="fl">9998</span>,</span>
<span>      AVISIT <span class="op">=</span> <span class="st">"POST-BASELINE MAXIMUM"</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"MAXIMUM"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># get LOV value</span></span>
<span>  <span class="fu"><a href="../reference/derive_extreme_records.html">derive_extreme_records</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adlb</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">AVISITN</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      AVISITN <span class="op">=</span> <span class="fl">9999</span>,</span>
<span>      AVISIT <span class="op">=</span> <span class="st">"POST-BASELINE LAST"</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"LOV"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Get ASEQ ----</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ASEQ</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_obs_number.html">derive_var_obs_number</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ASEQ</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="va">ADT</span>, <span class="va">AVISITN</span>, <span class="va">VISITNUM</span><span class="op">)</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"error"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Add all ADSL variables</span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Final Steps, Select final variables and Add labels</span></span>
<span><span class="co"># This process will be based on your metadata, no example given for this reason</span></span>
<span><span class="co"># ...</span></span>
<span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adlb</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adlb.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adlbhy.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADLBHY</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Lab Analysis Dataset for Hy's Law</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: adlb</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span><span class="co"># Using use_ad_template("adlb") and assigning the end object as admiral_adlb</span></span>
<span><span class="co"># ADLBHY is a special dataset specifically used to check for potential drug induced liver injuries</span></span>
<span><span class="co"># Please see "Hy's Law Implementation Guide" on the admiral website for additional information</span></span>
<span></span>
<span><span class="va">adlb</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adlb.html">admiral_adlb</a></span></span>
<span></span>
<span><span class="va">adlb_annotated</span> <span class="op">&lt;-</span> <span class="va">adlb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AST"</span>, <span class="st">"ALT"</span>, <span class="st">"BILI"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DTYPE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Assign flags for contribution to potential Hy's Law event</span></span>
<span>  <span class="fu"><a href="../reference/slice_derivation.html">slice_derivation</a></span><span class="op">(</span></span>
<span>    <span class="va">derive_vars_crit_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      values_yn <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/derivation_slice.html">derivation_slice</a></span><span class="op">(</span></span>
<span>      filter <span class="op">=</span> <span class="va">PARAMCD</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AST"</span>, <span class="st">"ALT"</span><span class="op">)</span>,</span>
<span>      args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        condition <span class="op">=</span> <span class="va">AVAL</span> <span class="op">/</span> <span class="va">ANRHI</span> <span class="op">&gt;=</span> <span class="fl">3</span>,</span>
<span>        description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="st">"&gt;=3xULN"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/derivation_slice.html">derivation_slice</a></span><span class="op">(</span></span>
<span>      filter <span class="op">=</span> <span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"BILI"</span>,</span>
<span>      args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>        condition <span class="op">=</span> <span class="va">AVAL</span> <span class="op">/</span> <span class="va">ANRHI</span> <span class="op">&gt;=</span> <span class="fl">2</span>,</span>
<span>        description <span class="op">=</span> <span class="st">"BILI &gt;= 2xULN"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">TRT01A</span>, <span class="va">PARAMCD</span>, <span class="va">PARAM</span>, <span class="va">LBSEQ</span>, <span class="va">ADT</span>, <span class="va">AVISIT</span>, <span class="va">ADY</span>, <span class="va">AVAL</span>, <span class="va">ANRHI</span>, <span class="va">CRIT1</span>, <span class="va">CRIT1FL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subset Datasets</span></span>
<span><span class="va">altast_records</span> <span class="op">&lt;-</span> <span class="va">adlb_annotated</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AST"</span>, <span class="st">"ALT"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bili_records</span> <span class="op">&lt;-</span> <span class="va">adlb_annotated</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BILI"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Flag elevated AST/ALT values with a BILI elevation within 14 days</span></span>
<span><span class="va">hylaw_records</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>  dataset <span class="op">=</span> <span class="va">altast_records</span>,</span>
<span>  dataset_add <span class="op">=</span> <span class="va">bili_records</span>,</span>
<span>  by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>  order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADY</span><span class="op">)</span>,</span>
<span>  join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>  filter_join <span class="op">=</span> <span class="fl">0</span> <span class="op">&lt;=</span> <span class="va">ADT.join</span> <span class="op">-</span> <span class="va">ADT</span> <span class="op">&amp;</span> <span class="va">ADT.join</span> <span class="op">-</span> <span class="va">ADT</span> <span class="op">&lt;=</span> <span class="fl">14</span> <span class="op">&amp;</span> <span class="va">CRIT1FL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="va">CRIT1FL.join</span> <span class="op">==</span> <span class="st">"Y"</span>,</span>
<span>  new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>BILI_LBSEQ <span class="op">=</span> <span class="va">LBSEQ</span>, BILI_DT <span class="op">=</span> <span class="va">ADT</span>, BILI_CRITFL <span class="op">=</span> <span class="va">CRIT1FL</span><span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"first"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">hylaw_records_pts_visits</span> <span class="op">&lt;-</span> <span class="va">hylaw_records</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">TRT01A</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># add AVISIT, ADT for by visit</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hylaw_records_fls</span> <span class="op">&lt;-</span> <span class="va">hylaw_records</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">TRT01A</span>, <span class="va">CRIT1FL</span>, <span class="va">BILI_CRITFL</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># add AVISIT, ADT for by visit</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create new parameters based on records that present potential case</span></span>
<span><span class="va">hylaw_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/derive_param_exist_flag.html">derive_param_exist_flag</a></span><span class="op">(</span></span>
<span>  dataset_ref <span class="op">=</span> <span class="va">hylaw_records_pts_visits</span>,</span>
<span>  dataset_add <span class="op">=</span> <span class="va">hylaw_records_fls</span>,</span>
<span>  condition <span class="op">=</span> <span class="va">CRIT1FL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="va">BILI_CRITFL</span> <span class="op">==</span> <span class="st">"Y"</span>,</span>
<span>  false_value <span class="op">=</span> <span class="st">"N"</span>,</span>
<span>  missing_value <span class="op">=</span> <span class="st">"N"</span>,</span>
<span>  by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">TRT01A</span><span class="op">)</span>, <span class="co"># add AVISIT, ADT for by visit</span></span>
<span>  set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="st">"HYSLAW"</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="st">"ALT/AST &gt;= 3xULN and BILI &gt;= 2xULN"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Row bind back to relevant adlb-like dataset</span></span>
<span><span class="va">adlbhy</span> <span class="op">&lt;-</span> <span class="va">adlb_annotated</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">hylaw_params</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adlbhy</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adlbhy.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_admh.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADMH</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Medical History Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: mh, adsl</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="va">mh</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/mh.html" class="external-link">mh</a></span></span>
<span><span class="va">queries_mh</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/queries_mh.html">queries_mh</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">mh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">mh</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look-up tables ----</span></span>
<span></span>
<span><span class="co"># Creating a look-up table for assigning MHTERMN (for derivation of company specific variable)</span></span>
<span><span class="co"># (this is set to align with the order of pre-printed terms on the CRF)</span></span>
<span><span class="va">mhtermn_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">MHTERM</span>, <span class="op">~</span><span class="va">MHTERMN</span>,</span>
<span>  <span class="st">"ALZHEIMER'S DISEASE"</span>, <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">TRT01A</span>, <span class="va">TRT01P</span>, <span class="va">DTHDT</span>, <span class="va">EOSDT</span><span class="op">)</span></span>
<span></span>
<span><span class="va">admh</span> <span class="op">&lt;-</span> <span class="va">mh</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># join ADSL with MH</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive dates (ASTDT, AEDT, ...) ----</span></span>
<span>  <span class="co"># Derive analysis start date and flag</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">MHSTDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span>,</span>
<span>    date_imputation <span class="op">=</span> <span class="st">"first"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive analysis end date and flag</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">MHENDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AEN"</span>,</span>
<span>    date_imputation <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    max_dates <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">DTHDT</span>, <span class="va">EOSDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive analysis start relative day and analysis end relative day</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span></span>
<span>    reference_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDT</span>, <span class="va">AENDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive analysis date of medical history collection - ADT (company specific variable derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">MHDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive analysis relative day - ADY (company specific variable derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span></span>
<span>    reference_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive query variables ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_query.html">derive_vars_query</a></span><span class="op">(</span><span class="va">queries_mh</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Assign the AHIST (company specific variable derivation)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AHIST <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">MHENRF</span> <span class="op">==</span> <span class="st">"BEFORE"</span> <span class="op">~</span> <span class="st">"Past"</span>,</span>
<span>    <span class="va">MHENRF</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DURING"</span>, <span class="st">"AFTER"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Current"</span>,</span>
<span>    <span class="va">MHSTAT</span> <span class="op">==</span> <span class="st">"Not Done"</span> <span class="op">~</span> <span class="st">"Not Assessed"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive occurrence flags ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_extreme_flag.html">derive_var_extreme_flag</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDT</span>, <span class="va">MHSEQ</span><span class="op">)</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">AOCCFL</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_extreme_flag.html">derive_var_extreme_flag</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">MHBODSYS</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">MHBODSYS</span>, <span class="va">MHCAT</span>, <span class="va">MHDECOD</span>, <span class="va">MHTERM</span>, <span class="va">ASTDT</span>, <span class="va">MHSEQ</span><span class="op">)</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">AOCCSFL</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_extreme_flag.html">derive_var_extreme_flag</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">MHDECOD</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">MHBODSYS</span>, <span class="va">MHCAT</span>, <span class="va">MHDECOD</span>, <span class="va">MHTERM</span>, <span class="va">ASTDT</span>, <span class="va">MHSEQ</span><span class="op">)</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">AOCCPFL</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># (company specific occurrence flag variables derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_extreme_flag.html">derive_var_extreme_flag</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AHIST</span>, <span class="va">ASTDT</span>, <span class="va">MHSEQ</span><span class="op">)</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">AOCPFL</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_extreme_flag.html">derive_var_extreme_flag</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">MHBODSYS</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AHIST</span>, <span class="va">MHBODSYS</span>, <span class="va">MHCAT</span>, <span class="va">ASTDT</span>, <span class="va">MHSEQ</span><span class="op">)</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">AOCPSFL</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_extreme_flag.html">derive_var_extreme_flag</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">MHDECOD</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AHIST</span>, <span class="va">MHBODSYS</span>, <span class="va">MHCAT</span>, <span class="va">MHDECOD</span>, <span class="va">MHTERM</span>, <span class="va">ASTDT</span>, <span class="va">MHSEQ</span><span class="op">)</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">AOCPPFL</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive analysis flag (company specific variable derivation) ----</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ANL01FL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">MHOCCUR</span> <span class="op">!=</span> <span class="st">"N"</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Assign TRTA, TRTP (company specific variables derivation) ----</span></span>
<span>  <span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span>  <span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#treatment_bds)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    TRTP <span class="op">=</span> <span class="va">TRT01P</span>,</span>
<span>    TRTA <span class="op">=</span> <span class="va">TRT01A</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Assign APHASE and APHASEN Variable (company specific variable derivation) ----</span></span>
<span>  <span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span>  <span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#periods_bds)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    APHASE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADT</span> <span class="op">&lt;</span> <span class="va">TRTSDT</span> <span class="op">~</span> <span class="st">"Screening"</span>,</span>
<span>      <span class="va">ADT</span> <span class="op">&gt;</span> <span class="va">TRTEDT</span> <span class="op">~</span> <span class="st">"Post-Treatment"</span>,</span>
<span>      <span class="va">ADT</span> <span class="op">&lt;=</span> <span class="va">TRTSDT</span> <span class="op">&amp;</span> <span class="va">ADT</span> <span class="op">&gt;=</span> <span class="va">TRTEDT</span> <span class="op">~</span> <span class="st">"On-Treatment"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    APHASEN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ADT</span> <span class="op">&lt;</span> <span class="va">TRTSDT</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ADT</span> <span class="op">&gt;</span> <span class="va">TRTEDT</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="va">ADT</span> <span class="op">&lt;=</span> <span class="va">TRTSDT</span> <span class="op">&amp;</span> <span class="va">ADT</span> <span class="op">&gt;=</span> <span class="va">TRTEDT</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive MHTERMN (company specific variable derivation)</span></span>
<span><span class="va">admh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>  <span class="va">admh</span>,</span>
<span>  derivation <span class="op">=</span> <span class="va">derive_vars_merged</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">mhtermn_lookup</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">MHTERM</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">MHTERMN</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  filter <span class="op">=</span> <span class="op">(</span><span class="va">MHPRESP</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Add all ADSL variables ----</span></span>
<span><span class="va">admh</span> <span class="op">&lt;-</span> <span class="va">admh</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Final Steps, Select final variables and Add labels</span></span>
<span><span class="co"># This process will be based on your metadata, no example given for this reason</span></span>
<span><span class="co"># ...</span></span>
<span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">admh</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"admh.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adpc.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADPC</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Pharmacokinetics Concentrations Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Description: Based on simulated data, create ADPC analysis dataset</span></span>
<span><span class="co">#   The dataset format is also suitable for Non-compartmental analysis (ADNCA)</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: pc, ex, vs, adsl</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project or simulated</span></span>
<span></span>
<span><span class="co"># ---- Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="co"># Load PC, EX, VS and ADSL</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/pc.html" class="external-link">pc</a></span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ex.html" class="external-link">ex</a></span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/vs.html" class="external-link">vs</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">pc</span><span class="op">)</span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">vs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Lookup tables ----</span></span>
<span><span class="va">param_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PCTESTCD</span>, <span class="op">~</span><span class="va">PARAMCD</span>, <span class="op">~</span><span class="va">PARAM</span>, <span class="op">~</span><span class="va">PARAMN</span>,</span>
<span>  <span class="st">"XAN"</span>, <span class="st">"XAN"</span>, <span class="st">"Pharmacokinetic concentration of Xanomeline"</span>, <span class="fl">1</span>,</span>
<span>  <span class="st">"DOSE"</span>, <span class="st">"DOSE"</span>, <span class="st">"Xanomeline Patch Dose"</span>, <span class="fl">2</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTSDTM</span>, <span class="va">TRT01P</span>, <span class="va">TRT01A</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pc_dates</span> <span class="op">&lt;-</span> <span class="va">pc</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL with PC (need TRTSDT for ADY derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive analysis date/time</span></span>
<span>  <span class="co"># Impute missing time to 00:00:00</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">PCDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span>,</span>
<span>    ignore_seconds_flag <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates and times from date/times</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="va">TRTSDT</span>, source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive event ID and nominal relative time from first dose (NFRLT)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    EVID <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    DRUG <span class="op">=</span> <span class="va">PCTEST</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_nfrlt.html">derive_var_nfrlt</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">NFRLT</span>,</span>
<span>    new_var_unit <span class="op">=</span> <span class="va">FRLTU</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    tpt_var <span class="op">=</span> <span class="va">PCTPT</span>,</span>
<span>    visit_day <span class="op">=</span> <span class="va">VISITDY</span>,</span>
<span>    treatment_duration <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    range_method <span class="op">=</span> <span class="st">"midpoint"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Get dosing information ----</span></span>
<span></span>
<span><span class="va">ex_dates</span> <span class="op">&lt;-</span> <span class="va">ex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Keep records with nonzero dose</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Add time and set missing end date to start date</span></span>
<span>  <span class="co"># Impute missing time to 00:00:00</span></span>
<span>  <span class="co"># Note all times are missing for dosing records in this example data</span></span>
<span>  <span class="co"># Derive Analysis Start and End Dates</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">EXSTDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AEN"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">EXENDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive event ID and nominal relative time from first dose (NFRLT)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    EVID <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_nfrlt.html">derive_var_nfrlt</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">NFRLT</span>,</span>
<span>    new_var_unit <span class="op">=</span> <span class="va">FRLTU</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    visit_day <span class="op">=</span> <span class="va">VISITDY</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Set missing end dates to start date</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AENDTM <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AENDTM</span><span class="op">)</span> <span class="op">~</span> <span class="va">ASTDTM</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">AENDTM</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates from date/times</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AENDTM</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># ---- Expand dosing records between start and end dates ----</span></span>
<span><span class="co"># Updated function includes nominal_time parameter</span></span>
<span></span>
<span><span class="va">ex_exp</span> <span class="op">&lt;-</span> <span class="va">ex_dates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/create_single_dose_dataset.html">create_single_dose_dataset</a></span><span class="op">(</span></span>
<span>    dose_freq <span class="op">=</span> <span class="va">EXDOSFRQ</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">ASTDT</span>,</span>
<span>    start_datetime <span class="op">=</span> <span class="va">ASTDTM</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">AENDT</span>,</span>
<span>    end_datetime <span class="op">=</span> <span class="va">AENDTM</span>,</span>
<span>    nominal_time <span class="op">=</span> <span class="va">NFRLT</span>,</span>
<span>    lookup_table <span class="op">=</span> <span class="va">dose_freq_lookup</span>,</span>
<span>    lookup_column <span class="op">=</span> <span class="va">CDISC_VALUE</span>,</span>
<span>    keep_source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">EVID</span>, <span class="va">EXDOSFRQ</span>, <span class="va">EXDOSFRM</span>,</span>
<span>      <span class="va">NFRLT</span>, <span class="va">EXDOSE</span>, <span class="va">EXDOSU</span>, <span class="va">EXTRT</span>, <span class="va">ASTDT</span>, <span class="va">ASTDTM</span>, <span class="va">AENDT</span>, <span class="va">AENDTM</span>,</span>
<span>      <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">VISITDY</span>,</span>
<span>      <span class="va">TRT01A</span>, <span class="va">TRT01P</span>, <span class="va">DOMAIN</span>, <span class="va">EXSEQ</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive AVISIT based on nominal relative time</span></span>
<span>  <span class="co"># Derive AVISITN to nominal time in whole days using integer division</span></span>
<span>  <span class="co"># Define AVISIT based on nominal day</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AVISITN <span class="op">=</span> <span class="va">NFRLT</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">24</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>    AVISIT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Day"</span>, <span class="va">AVISITN</span><span class="op">)</span>,</span>
<span>    ADTM <span class="op">=</span> <span class="va">ASTDTM</span>,</span>
<span>    DRUG <span class="op">=</span> <span class="va">EXTRT</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates and times from datetimes</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AENDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="va">TRTSDT</span>, source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># ---- Find first dose per treatment per subject ----</span></span>
<span><span class="co"># ---- Join with ADPC data and keep only subjects with dosing ----</span></span>
<span></span>
<span><span class="va">adpc_first_dose</span> <span class="op">&lt;-</span> <span class="va">pc_dates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_exp</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>FANLDTM <span class="op">=</span> <span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span>, <span class="va">EXSEQ</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FANLDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive AVISIT based on nominal relative time</span></span>
<span>  <span class="co"># Derive AVISITN to nominal time in whole days using integer division</span></span>
<span>  <span class="co"># Define AVISIT based on nominal day</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AVISITN <span class="op">=</span> <span class="va">NFRLT</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">24</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>    AVISIT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Day"</span>, <span class="va">AVISITN</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># ---- Find previous dose  ----</span></span>
<span></span>
<span><span class="va">adpc_prev</span> <span class="op">&lt;-</span> <span class="va">adpc_first_dose</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_exp</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      ADTM_prev <span class="op">=</span> <span class="va">ADTM</span>, EXDOSE_prev <span class="op">=</span> <span class="va">EXDOSE</span>, AVISIT_prev <span class="op">=</span> <span class="va">AVISIT</span>,</span>
<span>      AENDTM_prev <span class="op">=</span> <span class="va">AENDTM</span></span>
<span>    <span class="op">)</span>,</span>
<span>    join_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    filter_join <span class="op">=</span> <span class="va">ADTM</span> <span class="op">&gt;</span> <span class="va">ADTM.join</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Find next dose  ----</span></span>
<span></span>
<span><span class="va">adpc_next</span> <span class="op">&lt;-</span> <span class="va">adpc_prev</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_exp</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      ADTM_next <span class="op">=</span> <span class="va">ADTM</span>, EXDOSE_next <span class="op">=</span> <span class="va">EXDOSE</span>, AVISIT_next <span class="op">=</span> <span class="va">AVISIT</span>,</span>
<span>      AENDTM_next <span class="op">=</span> <span class="va">AENDTM</span></span>
<span>    <span class="op">)</span>,</span>
<span>    join_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    filter_join <span class="op">=</span> <span class="va">ADTM</span> <span class="op">&lt;=</span> <span class="va">ADTM.join</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Find previous nominal time ----</span></span>
<span></span>
<span><span class="va">adpc_nom_prev</span> <span class="op">&lt;-</span> <span class="va">adpc_next</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_exp</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>NFRLT_prev <span class="op">=</span> <span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    join_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    filter_join <span class="op">=</span> <span class="va">NFRLT</span> <span class="op">&gt;</span> <span class="va">NFRLT.join</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Find next nominal time ----</span></span>
<span></span>
<span><span class="va">adpc_nom_next</span> <span class="op">&lt;-</span> <span class="va">adpc_nom_prev</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_exp</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>NFRLT_next <span class="op">=</span> <span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    join_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    filter_join <span class="op">=</span> <span class="va">NFRLT</span> <span class="op">&lt;=</span> <span class="va">NFRLT.join</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Combine ADPC and EX data ----</span></span>
<span><span class="co"># Derive Relative Time Variables</span></span>
<span></span>
<span><span class="va">adpc_arrlt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">adpc_nom_next</span>, <span class="va">ex_exp</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">DRUG</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    FANLDTM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">FANLDTM</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    min_NFRLT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">NFRLT_prev</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    maxdate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">[</span><span class="va">EVID</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .after <span class="op">=</span> <span class="va">USUBJID</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">ADTM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADT</span> <span class="op">&lt;=</span> <span class="va">maxdate</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Actual Relative Time from First Dose (AFRLT)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">AFRLT</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">FANLDTM</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">ADTM</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    floor_in <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Actual Relative Time from Reference Dose (ARRLT)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ARRLT</span>,</span>
<span>    new_var_unit <span class="op">=</span> <span class="va">RRLTU</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">ADTM_prev</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">ADTM</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    floor_in <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Actual Relative Time from Next Dose (AXRLT not kept)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">AXRLT</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">ADTM_next</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">ADTM</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    floor_in <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ARRLT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ARRLT</span><span class="op">)</span> <span class="op">~</span> <span class="va">AXRLT</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">ARRLT</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive Reference Dose Date</span></span>
<span>    PCRFTDTM <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">ADTM</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ADTM_prev</span><span class="op">)</span> <span class="op">~</span> <span class="va">ADTM_next</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">ADTM_prev</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates and times from datetimes</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">FANLDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">FANLDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PCRFTDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PCRFTDTM</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive Nominal Relative Time from Reference Dose (NRRLT)</span></span>
<span></span>
<span><span class="va">adpc_nrrlt</span> <span class="op">&lt;-</span> <span class="va">adpc_arrlt</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    NRRLT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">NFRLT_prev</span><span class="op">)</span> <span class="op">~</span> <span class="va">NFRLT</span> <span class="op">-</span> <span class="va">min_NFRLT</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">NFRLT</span> <span class="op">-</span> <span class="va">NFRLT_prev</span></span>
<span>    <span class="op">)</span>,</span>
<span>    NXRLT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">NFRLT</span> <span class="op">-</span> <span class="va">NFRLT_next</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Derive Analysis Variables ----</span></span>
<span><span class="co"># Derive ATPTN, ATPT, ATPTREF, ABLFL and BASETYPE</span></span>
<span><span class="co"># Derive planned dose DOSEP, actual dose DOSEA and units</span></span>
<span><span class="co"># Derive PARAMCD and relative time units</span></span>
<span><span class="co"># Derive AVAL, AVALU and AVALCAT1</span></span>
<span></span>
<span><span class="va">adpc_aval</span> <span class="op">&lt;-</span> <span class="va">adpc_nrrlt</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARCAT1 <span class="op">=</span> <span class="va">PCSPEC</span>,</span>
<span>    ATPTN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PCTPTNUM</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ATPT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Dose"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PCTPT</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ATPTREF <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">AVISIT</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVISIT_prev</span><span class="op">)</span> <span class="op">~</span> <span class="va">AVISIT_next</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">AVISIT_prev</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive BASETYPE</span></span>
<span>    BASETYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">ATPTREF</span>, <span class="st">"Baseline"</span><span class="op">)</span>,</span>
<span></span>
<span>    <span class="co"># Derive Actual Dose</span></span>
<span>    DOSEA <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">EXDOSE</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXDOSE_prev</span><span class="op">)</span> <span class="op">~</span> <span class="va">EXDOSE_next</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">EXDOSE_prev</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive Planned Dose</span></span>
<span>    DOSEP <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TRT01P</span> <span class="op">==</span> <span class="st">"Xanomeline High Dose"</span> <span class="op">~</span> <span class="fl">81</span>,</span>
<span>      <span class="va">TRT01P</span> <span class="op">==</span> <span class="st">"Xanomeline Low Dose"</span> <span class="op">~</span> <span class="fl">54</span></span>
<span>    <span class="op">)</span>,</span>
<span>    DOSEU <span class="op">=</span> <span class="st">"mg"</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive relative time units</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Derive PARAMCD</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">PCTESTCD</span>, <span class="st">"DOSE"</span><span class="op">)</span>,</span>
<span>    ALLOQ <span class="op">=</span> <span class="va">PCLLOQ</span>,</span>
<span>    <span class="co"># Derive AVAL</span></span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">EXDOSE</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PCSTRESN</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">EXDOSU</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PCSTRESU</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALCAT1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">PCSTRESC</span> <span class="op">==</span> <span class="st">"&lt;BLQ"</span>, <span class="va">PCSTRESC</span>, <span class="fu"><a href="https://rdrr.io/r/base/formatc.html" class="external-link">prettyNum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">AVAL</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Add SRCSEQ</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    SRCDOM <span class="op">=</span> <span class="va">DOMAIN</span>,</span>
<span>    SRCVAR <span class="op">=</span> <span class="st">"SEQ"</span>,</span>
<span>    SRCSEQ <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">PCSEQ</span>, <span class="va">EXSEQ</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Create DTYPE imputation</span></span>
<span></span>
<span><span class="va">adpc_lloq</span> <span class="op">&lt;-</span> <span class="va">adpc_aval</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_extreme_records.html">derive_extreme_records</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adpc_aval</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">PARCAT1</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ADTM</span>, <span class="va">PCSEQ</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span>, <span class="va">BASETYPE</span>, <span class="va">EVID</span>, <span class="va">ATPTN</span>, <span class="va">PARCAT1</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">PCSTRESC</span> <span class="op">==</span> <span class="st">"&lt;BLQ"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      AVAL <span class="op">=</span> <span class="va">ALLOQ</span> <span class="op">*</span> <span class="fl">.5</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"HALFLLOQ"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Create DTYPE copy records ----</span></span>
<span></span>
<span><span class="va">dtype</span> <span class="op">&lt;-</span> <span class="va">adpc_lloq</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">NFRLT</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">NXRLT</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">EVID</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVISIT_next</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">PCRFTDT</span>, <span class="op">-</span><span class="va">PCRFTTM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Re-derive variables in for DTYPE copy records</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ATPTREF <span class="op">=</span> <span class="va">AVISIT_next</span>,</span>
<span>    ARRLT <span class="op">=</span> <span class="va">AXRLT</span>,</span>
<span>    NRRLT <span class="op">=</span> <span class="va">NXRLT</span>,</span>
<span>    PCRFTDTM <span class="op">=</span> <span class="va">ADTM_next</span>,</span>
<span>    DOSEA <span class="op">=</span> <span class="va">EXDOSE_next</span>,</span>
<span>    BASETYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">AVISIT_next</span>, <span class="st">"Baseline"</span><span class="op">)</span>,</span>
<span>    ATPT <span class="op">=</span> <span class="st">"Pre-dose"</span>,</span>
<span>    ATPTN <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>,</span>
<span>    DTYPE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DTYPE</span><span class="op">)</span> <span class="op">~</span> <span class="st">"COPY"</span>,</span>
<span>      <span class="va">DTYPE</span> <span class="op">==</span> <span class="st">"HALFLLOQ"</span> <span class="op">~</span> <span class="st">"COPY/HALFLLOQ"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PCRFTDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PCRFTDTM</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Combine original records and DTYPE copy records ----</span></span>
<span></span>
<span><span class="va">adpc_dtype</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">adpc_lloq</span>, <span class="va">dtype</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">ADTM</span>, <span class="va">NFRLT</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Derive baseline flag for pre-dose records</span></span>
<span>    ABLFL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ATPT</span> <span class="op">==</span> <span class="st">"Pre-dose"</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive MRRLT, ANL01FL and ANL02FL</span></span>
<span>    MRRLT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">ARRLT</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">ARRLT</span><span class="op">)</span>,</span>
<span>    ANL01FL <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>    ANL02FL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DTYPE</span><span class="op">)</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Derive BASE and Calculate Change from Baseline ----</span></span>
<span></span>
<span><span class="va">adpc_base</span> <span class="op">&lt;-</span> <span class="va">adpc_dtype</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">PARCAT1</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASE</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">ABLFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate CHG for post-baseline records</span></span>
<span><span class="co"># The decision on how to populate pre-baseline and baseline values of CHG is left to producer choice</span></span>
<span><span class="va">adpc_chg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>  <span class="va">adpc_base</span>,</span>
<span>  derivation <span class="op">=</span> <span class="va">derive_var_chg</span>,</span>
<span>  filter <span class="op">=</span> <span class="va">AVISITN</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Add ASEQ ----</span></span>
<span></span>
<span><span class="va">adpc_aseq</span> <span class="op">&lt;-</span> <span class="va">adpc_chg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ASEQ</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_obs_number.html">derive_var_obs_number</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ASEQ</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span>, <span class="va">BASETYPE</span>, <span class="va">EVID</span>, <span class="va">AVISITN</span>, <span class="va">ATPTN</span>, <span class="va">PARCAT1</span>, <span class="va">DTYPE</span><span class="op">)</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"error"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Remove temporary variables</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="op">-</span><span class="va">DOMAIN</span>, <span class="op">-</span><span class="va">PCSEQ</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"min"</span><span class="op">)</span>,</span>
<span>    <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"max"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"EX"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"next"</span><span class="op">)</span>,</span>
<span>    <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"prev"</span><span class="op">)</span>, <span class="op">-</span><span class="va">DRUG</span>, <span class="op">-</span><span class="va">EVID</span>, <span class="op">-</span><span class="va">AXRLT</span>, <span class="op">-</span><span class="va">NXRLT</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive PARAM and PARAMN</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span>dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">param_lookup</span>, <span class="op">-</span><span class="va">PCTESTCD</span><span class="op">)</span>, by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#---- Derive additional baselines from VS ----</span></span>
<span></span>
<span><span class="va">adpc_baselines</span> <span class="op">&lt;-</span> <span class="va">adpc_aseq</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">vs</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">VSTESTCD</span> <span class="op">==</span> <span class="st">"HEIGHT"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>HTBL <span class="op">=</span> <span class="va">VSSTRESN</span>, HTBLU <span class="op">=</span> <span class="va">VSSTRESU</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">vs</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">VSTESTCD</span> <span class="op">==</span> <span class="st">"WEIGHT"</span> <span class="op">&amp;</span> <span class="va">VSBLFL</span> <span class="op">==</span> <span class="st">"Y"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>WTBL <span class="op">=</span> <span class="va">VSSTRESN</span>, WTBLU <span class="op">=</span> <span class="va">VSSTRESU</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    BMIBL <span class="op">=</span> <span class="fu"><a href="../reference/compute_bmi.html">compute_bmi</a></span><span class="op">(</span>height <span class="op">=</span> <span class="va">HTBL</span>, weight <span class="op">=</span> <span class="va">WTBL</span><span class="op">)</span>,</span>
<span>    BMIBLU <span class="op">=</span> <span class="st">"kg/m^2"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Add all ADSL variables ----</span></span>
<span></span>
<span><span class="co"># Add all ADSL variables</span></span>
<span><span class="va">adpc</span> <span class="op">&lt;-</span> <span class="va">adpc_baselines</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Final Steps, Select final variables and Add labels</span></span>
<span><span class="co"># This process will be based on your metadata, no example given for this reason</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co"># ---- Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adpc</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adpc.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adpp.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADPP</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Pharmacokinetics Parameters Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Description: Based on simulated data, create ADPP analysis dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: pp, adsl</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="co"># Load PP and Adsl</span></span>
<span><span class="va">pp</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/pp.html" class="external-link">pp</a></span></span>
<span><span class="va">admiral_adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">pp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lookup tables ----</span></span>
<span><span class="va">param_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PPTESTCD</span>,  <span class="op">~</span><span class="va">PARAMCD</span>,                                     <span class="op">~</span><span class="va">PARAM</span>, <span class="op">~</span><span class="va">PARAMN</span>,</span>
<span>  <span class="st">"AUCALL"</span>,   <span class="st">"AUCALL"</span>,                                  <span class="st">"AUC All"</span>,       <span class="fl">1</span>,</span>
<span>  <span class="st">"AUCIFO"</span>,   <span class="st">"AUCIFO"</span>,                         <span class="st">"AUC Infinity Obs"</span>,       <span class="fl">2</span>,</span>
<span>  <span class="st">"AUCIFOD"</span>, <span class="st">"AUCIFOD"</span>,            <span class="st">"AUC Infinity Obs Norm by Dose"</span>,       <span class="fl">3</span>,</span>
<span>  <span class="st">"AUCINT"</span>,   <span class="st">"AUCINT"</span>,                        <span class="st">"AUC from T1 to T2"</span>,       <span class="fl">4</span>,</span>
<span>  <span class="st">"AUCLST"</span>,   <span class="st">"AUCLST"</span>,                 <span class="st">"AUC to Last Nonzero Conc"</span>,       <span class="fl">5</span>,</span>
<span>  <span class="st">"AUCPEO"</span>,   <span class="st">"AUCPEO"</span>,                   <span class="st">"AUC %Extrapolation Obs"</span>,       <span class="fl">6</span>,</span>
<span>  <span class="st">"CEND"</span>,       <span class="st">"CEND"</span>, <span class="st">"Concentration at the end of the infusion"</span>,       <span class="fl">7</span>, <span class="co"># non Cdisc Term</span></span>
<span>  <span class="st">"CLO"</span>,         <span class="st">"CLO"</span>,                             <span class="st">"Total CL Obs"</span>,       <span class="fl">8</span>,</span>
<span>  <span class="st">"CLST"</span>,       <span class="st">"CLST"</span>,                        <span class="st">"Last Nonzero Conc"</span>,       <span class="fl">9</span>,</span>
<span>  <span class="st">"CMAX"</span>,       <span class="st">"CMAX"</span>,                                 <span class="st">"Max Conc"</span>,      <span class="fl">10</span>,</span>
<span>  <span class="st">"CMAXD"</span>,     <span class="st">"CMAXD"</span>,                    <span class="st">"Max Conc Norm by Dose"</span>,      <span class="fl">11</span>,</span>
<span>  <span class="st">"CSF"</span>,         <span class="st">"CSF"</span>,                      <span class="st">"CSF to Plasma Ratio"</span>,      <span class="fl">12</span>, <span class="co"># non Cdisc Term</span></span>
<span>  <span class="st">"LAMZ"</span>,       <span class="st">"LAMZ"</span>,                                 <span class="st">"Lambda z"</span>,      <span class="fl">13</span>,</span>
<span>  <span class="st">"LAMZHL"</span>,   <span class="st">"LAMZHL"</span>,                       <span class="st">"Half-Life Lambda z"</span>,      <span class="fl">14</span>,</span>
<span>  <span class="st">"LAMZNPT"</span>, <span class="st">"LAMZNPT"</span>,            <span class="st">"Number of Points for Lambda z"</span>,      <span class="fl">15</span>,</span>
<span>  <span class="st">"R2ADJ"</span>,     <span class="st">"R2ADJ"</span>,                       <span class="st">"R Squared Adjusted"</span>,      <span class="fl">16</span>,</span>
<span>  <span class="st">"TCEND"</span>,     <span class="st">"TCEND"</span>,                             <span class="st">"Time of CEND"</span>,      <span class="fl">17</span>, <span class="co"># non Cdisc Term</span></span>
<span>  <span class="st">"TLST"</span>,       <span class="st">"TLST"</span>,                <span class="st">"Time of Last Nonzero Conc"</span>,      <span class="fl">18</span>,</span>
<span>  <span class="st">"TMAX"</span>,       <span class="st">"TMAX"</span>,                             <span class="st">"Time of CMAX"</span>,      <span class="fl">19</span>,</span>
<span>  <span class="st">"VSSO"</span>,       <span class="st">"VSSO"</span>,                <span class="st">"Vol Dist Steady State Obs"</span>,      <span class="fl">20</span>,</span>
<span>  <span class="st">"RCAMINT"</span>, <span class="st">"RCAMINT"</span>,                                       <span class="st">"Ae"</span>,      <span class="fl">21</span>,</span>
<span>  <span class="st">"RENALCL"</span>, <span class="st">"RENALCL"</span>,                                      <span class="st">"CLR"</span>,      <span class="fl">22</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign AVALCATx</span></span>
<span><span class="va">avalcax_lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PARAMCD</span>, <span class="op">~</span><span class="va">condition</span>,       <span class="op">~</span><span class="va">AVALCAT1</span>, <span class="op">~</span><span class="va">AVALCA1N</span>,</span>
<span>  <span class="st">"AUCALL"</span>,  <span class="va">AVAL</span> <span class="op">&lt;</span> <span class="fl">19</span>,           <span class="st">"&lt;19"</span>,         <span class="fl">1</span>,</span>
<span>  <span class="st">"AUCALL"</span>, <span class="va">AVAL</span> <span class="op">&gt;=</span> <span class="fl">19</span>,          <span class="st">"&gt;=19"</span>,         <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">param_lookup</span><span class="op">$</span><span class="va">PPTESTCD</span>, <span class="st">"label"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Parameter Short Name"</span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">DTHDT</span>, <span class="va">EOSDT</span>, <span class="va">TRT01P</span>, <span class="va">TRT01A</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adpp_pp</span> <span class="op">&lt;-</span> <span class="va">pp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL with PP (need TRTSDT for ADY derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">admiral_adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ADT, ADY ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">PPRFDTC</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="va">TRTSDT</span>, source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adpp_aval</span> <span class="op">&lt;-</span> <span class="va">adpp_pp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Add PARAMCD only - add PARAM etc later ----</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">param_lookup</span>, <span class="va">PPTESTCD</span>, <span class="va">PARAMCD</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"PPTESTCD"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate PARCAT1, AVAL and AVALC ----</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARCAT1 <span class="op">=</span> <span class="va">PPCAT</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">PPSTRESN</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="va">PPSTRESU</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Remove variables</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">PPSTRESN</span>, <span class="op">-</span><span class="va">PPSTRESC</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Add ASEQ</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    SRCDOM <span class="op">=</span> <span class="va">DOMAIN</span>,</span>
<span>    SRCVAR <span class="op">=</span> <span class="st">"SEQ"</span>,</span>
<span>    SRCSEQ <span class="op">=</span> <span class="va">PPSEQ</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">DOMAIN</span>, <span class="op">-</span><span class="va">PPSEQ</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Get visit info ----</span></span>
<span><span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span><span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#visit_bds)</span></span>
<span><span class="va">adpp_avisit</span> <span class="op">&lt;-</span> <span class="va">adpp_aval</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Timing</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AVISITN <span class="op">=</span> <span class="va">ADY</span>,</span>
<span>    AVISIT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Day"</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    VISITNUM <span class="op">=</span> <span class="va">AVISITN</span>,</span>
<span>    VISIT <span class="op">=</span> <span class="va">AVISIT</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Assign TRTA, TRTP ----</span></span>
<span>  <span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span>  <span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#treatment_bds)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    TRTP <span class="op">=</span> <span class="va">TRT01P</span>,</span>
<span>    TRTA <span class="op">=</span> <span class="va">TRT01A</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive AVALCA1N and AVALCAT1 ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_cat.html">derive_vars_cat</a></span><span class="op">(</span></span>
<span>    definition <span class="op">=</span> <span class="va">avalcax_lookup</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># Add all ADSL variables</span></span>
<span><span class="va">adpp</span> <span class="op">&lt;-</span> <span class="va">adpp_avisit</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">admiral_adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Final Steps, Select final variables and Add labels</span></span>
<span><span class="co"># This process will be based on your metadata, no example given for this reason</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adpp</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adpp.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adppk.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADPPK</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Population PK Analysis Data</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Description: Based on simulated data, create ADPPK analysis dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: pc, ex, vs, lb, adsl</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project or simulated</span></span>
<span></span>
<span><span class="co"># ---- Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="co"># Load PC, EX, VS, LB and ADSL</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/pc.html" class="external-link">pc</a></span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ex.html" class="external-link">ex</a></span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/vs.html" class="external-link">vs</a></span></span>
<span><span class="va">lb</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/lb.html" class="external-link">lb</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">pc</span><span class="op">)</span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">vs</span><span class="op">)</span></span>
<span><span class="va">lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">lb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Lookup tables ----</span></span>
<span><span class="va">param_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PCTESTCD</span>, <span class="op">~</span><span class="va">PARAMCD</span>, <span class="op">~</span><span class="va">PARAM</span>, <span class="op">~</span><span class="va">PARAMN</span>,</span>
<span>  <span class="st">"XAN"</span>, <span class="st">"XAN"</span>, <span class="st">"Pharmacokinetic concentration of Xanomeline"</span>, <span class="fl">1</span>,</span>
<span>  <span class="st">"DOSE"</span>, <span class="st">"DOSE"</span>, <span class="st">"Xanomeline Patch Dose"</span>, <span class="fl">2</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTSDTM</span>, <span class="va">TRT01P</span>, <span class="va">TRT01A</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pc_dates</span> <span class="op">&lt;-</span> <span class="va">pc</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL with PC (need TRTSDT for ADY derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive analysis date/time</span></span>
<span>  <span class="co"># Impute missing time to 00:00:00</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">PCDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span>,</span>
<span>    ignore_seconds_flag <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates and times from date/times</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive event ID and nominal relative time from first dose (NFRLT)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    EVID <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    DRUG <span class="op">=</span> <span class="va">PCTEST</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_nfrlt.html">derive_var_nfrlt</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">NFRLT</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    tpt_var <span class="op">=</span> <span class="va">PCTPT</span>,</span>
<span>    visit_day <span class="op">=</span> <span class="va">VISITDY</span>,</span>
<span>    treatment_duration <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    range_method <span class="op">=</span> <span class="st">"midpoint"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Get dosing information ----</span></span>
<span></span>
<span><span class="va">ex_dates</span> <span class="op">&lt;-</span> <span class="va">ex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Keep records with nonzero dose</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Add time and set missing end date to start date</span></span>
<span>  <span class="co"># Impute missing time to 00:00:00</span></span>
<span>  <span class="co"># Note all times are missing for dosing records in this example data</span></span>
<span>  <span class="co"># Derive Analysis Start and End Dates</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">EXSTDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AEN"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">EXENDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive event ID and nominal relative time from first dose (NFRLT)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    EVID <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_nfrlt.html">derive_var_nfrlt</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">NFRLT</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    visit_day <span class="op">=</span> <span class="va">VISITDY</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Set missing end dates to start date</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AENDTM <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AENDTM</span><span class="op">)</span> <span class="op">~</span> <span class="va">ASTDTM</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">AENDTM</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates from date/times</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AENDTM</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># ---- Expand dosing records between start and end dates ----</span></span>
<span><span class="co"># Updated function includes nominal_time parameter</span></span>
<span></span>
<span><span class="va">ex_exp</span> <span class="op">&lt;-</span> <span class="va">ex_dates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/create_single_dose_dataset.html">create_single_dose_dataset</a></span><span class="op">(</span></span>
<span>    dose_freq <span class="op">=</span> <span class="va">EXDOSFRQ</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">ASTDT</span>,</span>
<span>    start_datetime <span class="op">=</span> <span class="va">ASTDTM</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">AENDT</span>,</span>
<span>    end_datetime <span class="op">=</span> <span class="va">AENDTM</span>,</span>
<span>    nominal_time <span class="op">=</span> <span class="va">NFRLT</span>,</span>
<span>    lookup_table <span class="op">=</span> <span class="va">dose_freq_lookup</span>,</span>
<span>    lookup_column <span class="op">=</span> <span class="va">CDISC_VALUE</span>,</span>
<span>    keep_source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      <span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">EVID</span>, <span class="va">EXDOSFRQ</span>, <span class="va">EXDOSFRM</span>,</span>
<span>      <span class="va">NFRLT</span>, <span class="va">EXDOSE</span>, <span class="va">EXDOSU</span>, <span class="va">EXTRT</span>, <span class="va">ASTDT</span>, <span class="va">ASTDTM</span>, <span class="va">AENDT</span>, <span class="va">AENDTM</span>,</span>
<span>      <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">VISITDY</span>,</span>
<span>      <span class="va">TRT01A</span>, <span class="va">TRT01P</span>, <span class="va">DOMAIN</span>, <span class="va">EXSEQ</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive AVISIT based on nominal relative time</span></span>
<span>  <span class="co"># Derive AVISITN to nominal time in whole days using integer division</span></span>
<span>  <span class="co"># Define AVISIT based on nominal day</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AVISITN <span class="op">=</span> <span class="va">NFRLT</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">24</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>    AVISIT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Day"</span>, <span class="va">AVISITN</span><span class="op">)</span>,</span>
<span>    ADTM <span class="op">=</span> <span class="va">ASTDTM</span>,</span>
<span>    DRUG <span class="op">=</span> <span class="va">EXTRT</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive dates and times from datetimes</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AENDTM</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># ---- Find first dose per treatment per subject ----</span></span>
<span><span class="co"># ---- Join with ADPPK data and keep only subjects with dosing ----</span></span>
<span></span>
<span><span class="va">adppk_first_dose</span> <span class="op">&lt;-</span> <span class="va">pc_dates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_exp</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>FANLDTM <span class="op">=</span> <span class="va">ADTM</span>, EXDOSE_first <span class="op">=</span> <span class="va">EXDOSE</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span>, <span class="va">EXSEQ</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">DRUG</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">FANLDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive AVISIT based on nominal relative time</span></span>
<span>  <span class="co"># Derive AVISITN to nominal time in whole days using integer division</span></span>
<span>  <span class="co"># Define AVISIT based on nominal day</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AVISITN <span class="op">=</span> <span class="va">NFRLT</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">24</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>    AVISIT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Day"</span>, <span class="va">AVISITN</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># ---- Find previous dose  ----</span></span>
<span></span>
<span><span class="va">adppk_prev</span> <span class="op">&lt;-</span> <span class="va">adppk_first_dose</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_exp</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      ADTM_prev <span class="op">=</span> <span class="va">ADTM</span>, EXDOSE_prev <span class="op">=</span> <span class="va">EXDOSE</span>, AVISIT_prev <span class="op">=</span> <span class="va">AVISIT</span>,</span>
<span>      AENDTM_prev <span class="op">=</span> <span class="va">AENDTM</span></span>
<span>    <span class="op">)</span>,</span>
<span>    join_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    filter_join <span class="op">=</span> <span class="va">ADTM</span> <span class="op">&gt;</span> <span class="va">ADTM.join</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Find previous nominal dose ----</span></span>
<span></span>
<span><span class="va">adppk_nom_prev</span> <span class="op">&lt;-</span> <span class="va">adppk_prev</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_joined.html">derive_vars_joined</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_exp</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>NFRLT_prev <span class="op">=</span> <span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    join_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">NFRLT</span><span class="op">)</span>,</span>
<span>    join_type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    filter_join <span class="op">=</span> <span class="va">NFRLT</span> <span class="op">&gt;</span> <span class="va">NFRLT.join</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Combine ADPPK and EX data ----</span></span>
<span><span class="co"># Derive Relative Time Variables</span></span>
<span></span>
<span><span class="va">adppk_aprlt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">adppk_nom_prev</span>, <span class="va">ex_exp</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">DRUG</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    FANLDTM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">FANLDTM</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    min_NFRLT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">NFRLT</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    maxdate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">[</span><span class="va">EVID</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .after <span class="op">=</span> <span class="va">USUBJID</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">ADTM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ADT</span> <span class="op">&lt;=</span> <span class="va">maxdate</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Actual Relative Time from First Dose (AFRLT)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">AFRLT</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">FANLDTM</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">ADTM</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    floor_in <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Actual Relative Time from Reference Dose (APRLT)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">APRLT</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">ADTM_prev</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">ADTM</span>,</span>
<span>    out_unit <span class="op">=</span> <span class="st">"HOURS"</span>,</span>
<span>    floor_in <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive APRLT</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    APRLT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">APRLT</span><span class="op">)</span> <span class="op">~</span> <span class="va">AFRLT</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">APRLT</span></span>
<span>    <span class="op">)</span>,</span>
<span>    NPRLT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">NFRLT_prev</span><span class="op">)</span> <span class="op">~</span> <span class="va">NFRLT</span> <span class="op">-</span> <span class="va">min_NFRLT</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">NFRLT</span> <span class="op">-</span> <span class="va">NFRLT_prev</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Derive Analysis Variables ----</span></span>
<span><span class="co"># Derive actual dose DOSEA and planned dose DOSEP,</span></span>
<span><span class="co"># Derive AVAL and DV</span></span>
<span></span>
<span><span class="va">adppk_aval</span> <span class="op">&lt;-</span> <span class="va">adppk_aprlt</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Derive Actual Dose</span></span>
<span>    DOSEA <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">EXDOSE</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXDOSE_prev</span><span class="op">)</span> <span class="op">~</span> <span class="va">EXDOSE_first</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">EXDOSE_prev</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive Planned Dose</span></span>
<span>    DOSEP <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">TRT01P</span> <span class="op">==</span> <span class="st">"Xanomeline High Dose"</span> <span class="op">~</span> <span class="fl">81</span>,</span>
<span>      <span class="va">TRT01P</span> <span class="op">==</span> <span class="st">"Xanomeline Low Dose"</span> <span class="op">~</span> <span class="fl">54</span>,</span>
<span>      <span class="va">TRT01P</span> <span class="op">==</span> <span class="st">"Placebo"</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive PARAMCD</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"DOSE"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PCTESTCD</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ALLOQ <span class="op">=</span> <span class="va">PCLLOQ</span>,</span>
<span>    <span class="co"># Derive CMT</span></span>
<span>    CMT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">PCSPEC</span> <span class="op">==</span> <span class="st">"PLASMA"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive BLQFL/BLQFN</span></span>
<span>    BLQFL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PCSTRESC</span> <span class="op">==</span> <span class="st">"&lt;BLQ"</span> <span class="op">~</span> <span class="st">"Y"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"N"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    BLQFN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PCSTRESC</span> <span class="op">==</span> <span class="st">"&lt;BLQ"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AMT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">EXDOSE</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive DV and AVAL</span></span>
<span>    DV <span class="op">=</span> <span class="va">PCSTRESN</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="va">DV</span>,</span>
<span>    DVL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">DV</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">DV</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Derive MDV</span></span>
<span>    MDV <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DV</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVALU <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="cn">NA_character_</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PCSTRESU</span></span>
<span>    <span class="op">)</span>,</span>
<span>    UDTC <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/format_ISO8601.html" class="external-link">format_ISO8601</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span>,</span>
<span>    II <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    SS <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- Add ASEQ ----</span></span>
<span></span>
<span><span class="va">adppk_aseq</span> <span class="op">&lt;-</span> <span class="va">adppk_aval</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ASEQ</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_obs_number.html">derive_var_obs_number</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ASEQ</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AFRLT</span>, <span class="va">EVID</span>, <span class="va">CMT</span><span class="op">)</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"error"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive PARAM and PARAMN</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span>dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">param_lookup</span>, <span class="op">-</span><span class="va">PCTESTCD</span><span class="op">)</span>, by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PROJID <span class="op">=</span> <span class="va">DRUG</span>,</span>
<span>    PROJIDN <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Remove temporary variables</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="op">-</span><span class="va">DOMAIN</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"min"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"max"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"EX"</span><span class="op">)</span>,</span>
<span>    <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"PC"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"first"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"prev"</span><span class="op">)</span>,</span>
<span>    <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"DTM"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"DT"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"TM"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"VISIT"</span><span class="op">)</span>,</span>
<span>    <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"AVISIT"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"TMF"</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"TRT"</span><span class="op">)</span>,</span>
<span>    <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"ATPT"</span><span class="op">)</span>, <span class="op">-</span><span class="va">DRUG</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#---- Derive Covariates ----</span></span>
<span><span class="co"># Include numeric values for STUDYIDN, USUBJIDN, SEXN, RACEN etc.</span></span>
<span></span>
<span><span class="va">covar</span> <span class="op">&lt;-</span> <span class="va">adsl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">country_code_lookup</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>COUNTRYN <span class="op">=</span> <span class="va">country_number</span>, COUNTRYL <span class="op">=</span> <span class="va">country_name</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>COUNTRY <span class="op">=</span> <span class="va">country_code</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    STUDYIDN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/word.html" class="external-link">word</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="fl">1</span>, sep <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/modifiers.html" class="external-link">fixed</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    SITEIDN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/word.html" class="external-link">word</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="fl">2</span>, sep <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/modifiers.html" class="external-link">fixed</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    USUBJIDN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/word.html" class="external-link">word</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="fl">3</span>, sep <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/modifiers.html" class="external-link">fixed</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    SUBJIDN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">SUBJID</span><span class="op">)</span>,</span>
<span>    SEXN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">SEX</span> <span class="op">==</span> <span class="st">"M"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">SEX</span> <span class="op">==</span> <span class="st">"F"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    RACEN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">RACE</span> <span class="op">==</span> <span class="st">"AMERICAN INDIAN OR ALASKA NATIVE"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">RACE</span> <span class="op">==</span> <span class="st">"ASIAN"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="va">RACE</span> <span class="op">==</span> <span class="st">"BLACK OR AFRICAN AMERICAN"</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>      <span class="va">RACE</span> <span class="op">==</span> <span class="st">"NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER"</span> <span class="op">~</span> <span class="fl">4</span>,</span>
<span>      <span class="va">RACE</span> <span class="op">==</span> <span class="st">"WHITE"</span> <span class="op">~</span> <span class="fl">5</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">6</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ETHNICN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ETHNIC</span> <span class="op">==</span> <span class="st">"HISPANIC OR LATINO"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ETHNIC</span> <span class="op">==</span> <span class="st">"NOT HISPANIC OR LATINO"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ARMN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ARM</span> <span class="op">==</span> <span class="st">"Placebo"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="va">ARM</span> <span class="op">==</span> <span class="st">"Xanomeline Low Dose"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ARM</span> <span class="op">==</span> <span class="st">"Xanomeline High Dose"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ACTARMN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ACTARM</span> <span class="op">==</span> <span class="st">"Placebo"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="va">ACTARM</span> <span class="op">==</span> <span class="st">"Xanomeline Low Dose"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">ACTARM</span> <span class="op">==</span> <span class="st">"Xanomeline High Dose"</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    COHORT <span class="op">=</span> <span class="va">ARMN</span>,</span>
<span>    COHORTC <span class="op">=</span> <span class="va">ARM</span>,</span>
<span>    ROUTE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ex</span><span class="op">$</span><span class="va">EXROUTE</span><span class="op">)</span>,</span>
<span>    ROUTEN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">ROUTE</span> <span class="op">==</span> <span class="st">"TRANSDERMAL"</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    FORM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ex</span><span class="op">$</span><span class="va">EXDOSFRM</span><span class="op">)</span>,</span>
<span>    FORMN <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">FORM</span> <span class="op">==</span> <span class="st">"PATCH"</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">4</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">STUDYID</span>, <span class="va">STUDYIDN</span>, <span class="va">SITEID</span>, <span class="va">SITEIDN</span>, <span class="va">USUBJID</span>, <span class="va">USUBJIDN</span>,</span>
<span>    <span class="va">SUBJID</span>, <span class="va">SUBJIDN</span>, <span class="va">AGE</span>, <span class="va">SEX</span>, <span class="va">SEXN</span>, <span class="va">COHORT</span>, <span class="va">COHORTC</span>, <span class="va">ROUTE</span>, <span class="va">ROUTEN</span>,</span>
<span>    <span class="va">RACE</span>, <span class="va">RACEN</span>, <span class="va">ETHNIC</span>, <span class="va">ETHNICN</span>, <span class="va">FORM</span>, <span class="va">FORMN</span>, <span class="va">COUNTRY</span>, <span class="va">COUNTRYN</span>, <span class="va">COUNTRYL</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#---- Derive additional baselines from VS and LB ----</span></span>
<span></span>
<span><span class="va">labsbl</span> <span class="op">&lt;-</span> <span class="va">lb</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">LBBLFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="va">LBTESTCD</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CREAT"</span>, <span class="st">"ALT"</span>, <span class="st">"AST"</span>, <span class="st">"BILI"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>LBTESTCDB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">LBTESTCD</span>, <span class="st">"BL"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">LBTESTCDB</span>, <span class="va">LBSTRESN</span><span class="op">)</span></span>
<span></span>
<span><span class="va">covar_vslb</span> <span class="op">&lt;-</span> <span class="va">covar</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">vs</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">VSTESTCD</span> <span class="op">==</span> <span class="st">"HEIGHT"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>HTBL <span class="op">=</span> <span class="va">VSSTRESN</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">vs</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">VSTESTCD</span> <span class="op">==</span> <span class="st">"WEIGHT"</span> <span class="op">&amp;</span> <span class="va">VSBLFL</span> <span class="op">==</span> <span class="st">"Y"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>WTBL <span class="op">=</span> <span class="va">VSSTRESN</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_transposed.html">derive_vars_transposed</a></span><span class="op">(</span></span>
<span>    dataset_merge <span class="op">=</span> <span class="va">labsbl</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    key_var <span class="op">=</span> <span class="va">LBTESTCDB</span>,</span>
<span>    value_var <span class="op">=</span> <span class="va">LBSTRESN</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    BMIBL <span class="op">=</span> <span class="fu"><a href="../reference/compute_bmi.html">compute_bmi</a></span><span class="op">(</span>height <span class="op">=</span> <span class="va">HTBL</span>, weight <span class="op">=</span> <span class="va">WTBL</span><span class="op">)</span>,</span>
<span>    BSABL <span class="op">=</span> <span class="fu"><a href="../reference/compute_bsa.html">compute_bsa</a></span><span class="op">(</span></span>
<span>      height <span class="op">=</span> <span class="va">HTBL</span>,</span>
<span>      weight <span class="op">=</span> <span class="va">WTBL</span>,</span>
<span>      method <span class="op">=</span> <span class="st">"Mosteller"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    CRCLBL <span class="op">=</span> <span class="fu"><a href="../reference/compute_egfr.html">compute_egfr</a></span><span class="op">(</span></span>
<span>      creat <span class="op">=</span> <span class="va">CREATBL</span>, creatu <span class="op">=</span> <span class="st">"SI"</span>, age <span class="op">=</span> <span class="va">AGE</span>, weight <span class="op">=</span> <span class="va">WTBL</span>, sex <span class="op">=</span> <span class="va">SEX</span>,</span>
<span>      method <span class="op">=</span> <span class="st">"CRCL"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    EGFRBL <span class="op">=</span> <span class="fu"><a href="../reference/compute_egfr.html">compute_egfr</a></span><span class="op">(</span></span>
<span>      creat <span class="op">=</span> <span class="va">CREATBL</span>, creatu <span class="op">=</span> <span class="st">"SI"</span>, age <span class="op">=</span> <span class="va">AGE</span>, weight <span class="op">=</span> <span class="va">WTBL</span>, sex <span class="op">=</span> <span class="va">SEX</span>,</span>
<span>      method <span class="op">=</span> <span class="st">"CKD-EPI"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>TBILBL <span class="op">=</span> <span class="va">BILIBL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine covariates with APPPK data</span></span>
<span></span>
<span><span class="va">adppk</span> <span class="op">&lt;-</span> <span class="va">adppk_aseq</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">covar_vslb</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">STUDYIDN</span>, <span class="va">USUBJIDN</span>, <span class="va">AFRLT</span>, <span class="va">EVID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>RECSEQ <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Final Steps, Select final variables and Add labels</span></span>
<span><span class="co"># This process will be based on your metadata, no example given for this reason</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co"># ---- Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adppk</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adppk.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_adsl.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADSL</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Subject Level Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: dm, ds, ex, ae, lb</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. haven::read_sas to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data.</span></span>
<span></span>
<span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/dm.html" class="external-link">dm</a></span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ds.html" class="external-link">ds</a></span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ex.html" class="external-link">ex</a></span></span>
<span><span class="va">ae</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ae.html" class="external-link">ae</a></span></span>
<span><span class="va">lb</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/lb.html" class="external-link">lb</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span></span>
<span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">dm</span><span class="op">)</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ds</span><span class="op">)</span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">ae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">ae</span><span class="op">)</span></span>
<span><span class="va">lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">lb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># User defined functions ----</span></span>
<span></span>
<span><span class="co"># Here are some examples of how you can create your own functions that</span></span>
<span><span class="co">#  operates on vectors, which can be used in `mutate`.</span></span>
<span></span>
<span><span class="co"># Grouping</span></span>
<span><span class="va">format_racegr1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">x</span> <span class="op">==</span> <span class="st">"WHITE"</span> <span class="op">~</span> <span class="st">"White"</span>,</span>
<span>    <span class="va">x</span> <span class="op">!=</span> <span class="st">"WHITE"</span> <span class="op">~</span> <span class="st">"Non-white"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Missing"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">format_agegr1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;</span> <span class="fl">18</span> <span class="op">~</span> <span class="st">"&lt;18"</span>,</span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">18</span>, <span class="fl">64</span><span class="op">)</span> <span class="op">~</span> <span class="st">"18-64"</span>,</span>
<span>    <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">64</span> <span class="op">~</span> <span class="st">"&gt;64"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Missing"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">format_region1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CAN"</span>, <span class="st">"USA"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"NA"</span>,</span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">~</span> <span class="st">"RoW"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Missing"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">format_lddthgr1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;=</span> <span class="fl">30</span> <span class="op">~</span> <span class="st">"&lt;= 30"</span>,</span>
<span>    <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">30</span> <span class="op">~</span> <span class="st">"&gt; 30"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># EOSSTT mapping</span></span>
<span><span class="va">format_eosstt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"COMPLETED"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"COMPLETED"</span>,</span>
<span>    <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SCREEN FAILURE"</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA_character_</span>,</span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">~</span> <span class="st">"DISCONTINUED"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"ONGOING"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span><span class="co"># impute start and end time of exposure to first and last respectively, do not impute date</span></span>
<span><span class="va">ex_ext</span> <span class="op">&lt;-</span> <span class="va">ex</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">EXSTDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"EXST"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">EXENDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"EXEN"</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"last"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="va">dm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## derive treatment variables (TRT01P, TRT01A) ----</span></span>
<span>  <span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span>  <span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#treatment_adsl)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>TRT01P <span class="op">=</span> <span class="va">ARM</span>, TRT01A <span class="op">=</span> <span class="va">ACTARM</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## derive treatment start date (TRTSDTM) ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_ext</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span></span>
<span>      <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span></span>
<span>        <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">EXTRT</span>, <span class="st">"PLACEBO"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXSTDTM</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>TRTSDTM <span class="op">=</span> <span class="va">EXSTDTM</span>, TRTSTMF <span class="op">=</span> <span class="va">EXSTTMF</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">EXSTDTM</span>, <span class="va">EXSEQ</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## derive treatment end date (TRTEDTM) ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_ext</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span></span>
<span>      <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span></span>
<span>        <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">EXTRT</span>, <span class="st">"PLACEBO"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXENDTM</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>TRTEDTM <span class="op">=</span> <span class="va">EXENDTM</span>, TRTETMF <span class="op">=</span> <span class="va">EXENTMF</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">EXENDTM</span>, <span class="va">EXSEQ</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive treatment end/start date TRTSDT/TRTEDT ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span>source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDTM</span>, <span class="va">TRTEDTM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## derive treatment duration (TRTDURD) ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_trtdurd.html">derive_var_trtdurd</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Disposition dates, status ----</span></span>
<span><span class="co"># convert character date to numeric date without imputation</span></span>
<span><span class="va">ds_ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>  <span class="va">ds</span>,</span>
<span>  dtc <span class="op">=</span> <span class="va">DSSTDTC</span>,</span>
<span>  new_vars_prefix <span class="op">=</span> <span class="st">"DSST"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Screen fail date</span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="va">adsl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ds_ext</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>SCRFDT <span class="op">=</span> <span class="va">DSSTDT</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">DSCAT</span> <span class="op">==</span> <span class="st">"DISPOSITION EVENT"</span> <span class="op">&amp;</span> <span class="va">DSDECOD</span> <span class="op">==</span> <span class="st">"SCREEN FAILURE"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ds_ext</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>EOSDT <span class="op">=</span> <span class="va">DSSTDT</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">DSCAT</span> <span class="op">==</span> <span class="st">"DISPOSITION EVENT"</span> <span class="op">&amp;</span> <span class="va">DSDECOD</span> <span class="op">!=</span> <span class="st">"SCREEN FAILURE"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># EOS status</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ds_ext</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">DSCAT</span> <span class="op">==</span> <span class="st">"DISPOSITION EVENT"</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>EOSSTT <span class="op">=</span> <span class="fu">format_eosstt</span><span class="op">(</span><span class="va">DSDECOD</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    missing_values <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>EOSSTT <span class="op">=</span> <span class="st">"ONGOING"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Last retrieval date</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ds_ext</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>FRVDT <span class="op">=</span> <span class="va">DSSTDT</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">DSCAT</span> <span class="op">==</span> <span class="st">"OTHER EVENT"</span> <span class="op">&amp;</span> <span class="va">DSDECOD</span> <span class="op">==</span> <span class="st">"FINAL RETRIEVAL VISIT"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Randomization Date</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ds_ext</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">DSDECOD</span> <span class="op">==</span> <span class="st">"RANDOMIZED"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>RANDDT <span class="op">=</span> <span class="va">DSSTDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Death date - impute partial date to first day/month</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"DTH"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">DTHDTC</span>,</span>
<span>    highest_imputation <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>    date_imputation <span class="op">=</span> <span class="st">"first"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Relative Day of Death</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">DTHADY</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">DTHDT</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Elapsed Days from Last Dose to Death</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_duration.html">derive_vars_duration</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">LDDTHELD</span>,</span>
<span>    start_date <span class="op">=</span> <span class="va">TRTEDT</span>,</span>
<span>    end_date <span class="op">=</span> <span class="va">DTHDT</span>,</span>
<span>    add_one <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Cause of Death and Traceability Variables</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_extreme_event.html">derive_vars_extreme_event</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span></span>
<span>        dataset_name <span class="op">=</span> <span class="st">"ae"</span>,</span>
<span>        condition <span class="op">=</span> <span class="va">AEOUT</span> <span class="op">==</span> <span class="st">"FATAL"</span>,</span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>DTHCAUS <span class="op">=</span> <span class="va">AEDECOD</span>, DTHDOM <span class="op">=</span> <span class="va">DOMAIN</span><span class="op">)</span>,</span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span></span>
<span>        dataset_name <span class="op">=</span> <span class="st">"ds"</span>,</span>
<span>        condition <span class="op">=</span> <span class="va">DSDECOD</span> <span class="op">==</span> <span class="st">"DEATH"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"DEATH DUE TO"</span>, <span class="va">DSTERM</span><span class="op">)</span>,</span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>DTHCAUS <span class="op">=</span> <span class="va">DSTERM</span>, DTHDOM <span class="op">=</span> <span class="va">DOMAIN</span><span class="op">)</span>,</span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    source_datasets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ae <span class="op">=</span> <span class="va">ae</span>, ds <span class="op">=</span> <span class="va">ds</span><span class="op">)</span>,</span>
<span>    tmp_event_nr_var <span class="op">=</span> <span class="va">event_nr</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">event_nr</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>DTHCAUS <span class="op">=</span> <span class="va">DTHCAUS</span>, DTHDOM <span class="op">=</span> <span class="va">DTHDOM</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Death Cause Category</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>DTHCGR1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DTHDOM</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA_character_</span>,</span>
<span>    <span class="va">DTHDOM</span> <span class="op">==</span> <span class="st">"AE"</span> <span class="op">~</span> <span class="st">"ADVERSE EVENT"</span>,</span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">DTHCAUS</span>, <span class="st">"(PROGRESSIVE DISEASE|DISEASE RELAPSE)"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"PROGRESSIVE DISEASE"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"OTHER"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Last known alive date ----</span></span>
<span><span class="co">## DTC variables are converted to numeric dates imputing missing day and month</span></span>
<span><span class="co">## to the first</span></span>
<span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="va">adsl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_extreme_event.html">derive_vars_extreme_event</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span></span>
<span>        dataset_name <span class="op">=</span> <span class="st">"ae"</span>,</span>
<span>        order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AESTDTC</span>, <span class="va">AESEQ</span><span class="op">)</span>,</span>
<span>        condition <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AESTDTC</span><span class="op">)</span>,</span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          LSTALVDT <span class="op">=</span> <span class="fu"><a href="../reference/convert_dtc_to_dt.html">convert_dtc_to_dt</a></span><span class="op">(</span><span class="va">AESTDTC</span>, highest_imputation <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span>,</span>
<span>          seq <span class="op">=</span> <span class="va">AESEQ</span></span>
<span>        <span class="op">)</span>,</span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span></span>
<span>        dataset_name <span class="op">=</span> <span class="st">"ae"</span>,</span>
<span>        order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">AEENDTC</span>, <span class="va">AESEQ</span><span class="op">)</span>,</span>
<span>        condition <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AEENDTC</span><span class="op">)</span>,</span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          LSTALVDT <span class="op">=</span> <span class="fu"><a href="../reference/convert_dtc_to_dt.html">convert_dtc_to_dt</a></span><span class="op">(</span><span class="va">AEENDTC</span>, highest_imputation <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span>,</span>
<span>          seq <span class="op">=</span> <span class="va">AESEQ</span></span>
<span>        <span class="op">)</span>,</span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span></span>
<span>        dataset_name <span class="op">=</span> <span class="st">"lb"</span>,</span>
<span>        order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">LBDTC</span>, <span class="va">LBSEQ</span><span class="op">)</span>,</span>
<span>        condition <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LBDTC</span><span class="op">)</span>,</span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>          LSTALVDT <span class="op">=</span> <span class="fu"><a href="../reference/convert_dtc_to_dt.html">convert_dtc_to_dt</a></span><span class="op">(</span><span class="va">LBDTC</span>, highest_imputation <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span>,</span>
<span>          seq <span class="op">=</span> <span class="va">LBSEQ</span></span>
<span>        <span class="op">)</span>,</span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span></span>
<span>        dataset_name <span class="op">=</span> <span class="st">"adsl"</span>,</span>
<span>        condition <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">TRTEDT</span><span class="op">)</span>,</span>
<span>        set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>LSTALVDT <span class="op">=</span> <span class="va">TRTEDT</span>, seq <span class="op">=</span> <span class="cn">NA_integer_</span><span class="op">)</span>,</span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    source_datasets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ae <span class="op">=</span> <span class="va">ae</span>, lb <span class="op">=</span> <span class="va">lb</span>, adsl <span class="op">=</span> <span class="va">adsl</span><span class="op">)</span>,</span>
<span>    tmp_event_nr_var <span class="op">=</span> <span class="va">event_nr</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">LSTALVDT</span>, <span class="va">seq</span>, <span class="va">event_nr</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">LSTALVDT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_var_merged_exist_flag.html">derive_var_merged_exist_flag</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">SAFFL</span>,</span>
<span>    false_value <span class="op">=</span> <span class="st">"N"</span>,</span>
<span>    missing_value <span class="op">=</span> <span class="st">"N"</span>,</span>
<span>    condition <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">EXTRT</span>, <span class="st">"PLACEBO"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Groupings and others variables ----</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    RACEGR1 <span class="op">=</span> <span class="fu">format_racegr1</span><span class="op">(</span><span class="va">RACE</span><span class="op">)</span>,</span>
<span>    AGEGR1 <span class="op">=</span> <span class="fu">format_agegr1</span><span class="op">(</span><span class="va">AGE</span><span class="op">)</span>,</span>
<span>    REGION1 <span class="op">=</span> <span class="fu">format_region1</span><span class="op">(</span><span class="va">COUNTRY</span><span class="op">)</span>,</span>
<span>    LDDTHGR1 <span class="op">=</span> <span class="fu">format_lddthgr1</span><span class="op">(</span><span class="va">LDDTHELD</span><span class="op">)</span>,</span>
<span>    DTH30FL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">LDDTHGR1</span> <span class="op">==</span> <span class="st">"&lt;= 30"</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span>,</span>
<span>    DTHA30FL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">LDDTHGR1</span> <span class="op">==</span> <span class="st">"&gt; 30"</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span>,</span>
<span>    DTHB30FL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">DTHDT</span> <span class="op">&lt;=</span> <span class="va">TRTSDT</span> <span class="op">+</span> <span class="fl">30</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span>,</span>
<span>    DOMAIN <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">adsl</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"adsl.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details><details style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 5px;"><summary style="cursor: pointer; font-weight: bold;">
ad_advs.R
</summary><pre style="max-height: 90vh"><code><span><span class="co"># Name: ADVS</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Label: Vital Signs Analysis Dataset</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Input: adsl, vs</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span> <span class="co"># Contains example datasets from the CDISC pilot project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load source datasets ----</span></span>
<span></span>
<span><span class="co"># Use e.g. `haven::read_sas()` to read in .sas7bdat, or other suitable functions</span></span>
<span><span class="co"># as needed and assign to the variables below.</span></span>
<span><span class="co"># For illustration purposes read in admiral test data</span></span>
<span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/vs.html" class="external-link">vs</a></span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">admiral</span><span class="fu">::</span><span class="va"><a href="../reference/admiral_adsl.html">admiral_adsl</a></span></span>
<span></span>
<span><span class="co"># When SAS datasets are imported into R using haven::read_sas(), missing</span></span>
<span><span class="co"># character values from SAS appear as "" characters in R, instead of appearing</span></span>
<span><span class="co"># as NA values. Further details can be obtained via the following link:</span></span>
<span><span class="co"># https://pharmaverse.github.io/admiral/cran-release/articles/admiral.html#handling-of-missing-values # nolint</span></span>
<span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="va">vs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lookup tables ----</span></span>
<span></span>
<span><span class="co"># Assign PARAMCD, PARAM, and PARAMN</span></span>
<span><span class="va">param_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">VSTESTCD</span>, <span class="op">~</span><span class="va">PARAMCD</span>,                            <span class="op">~</span><span class="va">PARAM</span>, <span class="op">~</span><span class="va">PARAMN</span>,</span>
<span>  <span class="st">"SYSBP"</span>,    <span class="st">"SYSBP"</span>,  <span class="st">"Systolic Blood Pressure (mmHg)"</span>,       <span class="fl">1</span>,</span>
<span>  <span class="st">"DIABP"</span>,    <span class="st">"DIABP"</span>, <span class="st">"Diastolic Blood Pressure (mmHg)"</span>,       <span class="fl">2</span>,</span>
<span>  <span class="st">"PULSE"</span>,    <span class="st">"PULSE"</span>,          <span class="st">"Pulse Rate (beats/min)"</span>,       <span class="fl">3</span>,</span>
<span>  <span class="st">"WEIGHT"</span>,  <span class="st">"WEIGHT"</span>,                     <span class="st">"Weight (kg)"</span>,       <span class="fl">4</span>,</span>
<span>  <span class="st">"HEIGHT"</span>,  <span class="st">"HEIGHT"</span>,                     <span class="st">"Height (cm)"</span>,       <span class="fl">5</span>,</span>
<span>  <span class="st">"TEMP"</span>,      <span class="st">"TEMP"</span>,                 <span class="st">"Temperature (C)"</span>,       <span class="fl">6</span>,</span>
<span>  <span class="st">"MAP"</span>,        <span class="st">"MAP"</span>,   <span class="st">"Mean Arterial Pressure (mmHg)"</span>,       <span class="fl">7</span>,</span>
<span>  <span class="st">"BMI"</span>,        <span class="st">"BMI"</span>,         <span class="st">"Body Mass Index(kg/m^2)"</span>,       <span class="fl">8</span>,</span>
<span>  <span class="st">"BSA"</span>,        <span class="st">"BSA"</span>,          <span class="st">"Body Surface Area(m^2)"</span>,       <span class="fl">9</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">param_lookup</span><span class="op">$</span><span class="va">VSTESTCD</span>, <span class="st">"label"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Vital Signs Test Short Name"</span></span>
<span></span>
<span></span>
<span><span class="co"># Assign ANRLO/HI, A1LO/HI</span></span>
<span><span class="va">range_lookup</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PARAMCD</span>, <span class="op">~</span><span class="va">ANRLO</span>, <span class="op">~</span><span class="va">ANRHI</span>, <span class="op">~</span><span class="va">A1LO</span>, <span class="op">~</span><span class="va">A1HI</span>,</span>
<span>  <span class="st">"SYSBP"</span>,      <span class="fl">90</span>,    <span class="fl">130</span>,    <span class="fl">70</span>,   <span class="fl">140</span>,</span>
<span>  <span class="st">"DIABP"</span>,      <span class="fl">60</span>,     <span class="fl">80</span>,    <span class="fl">40</span>,    <span class="fl">90</span>,</span>
<span>  <span class="st">"PULSE"</span>,      <span class="fl">60</span>,    <span class="fl">100</span>,    <span class="fl">40</span>,   <span class="fl">110</span>,</span>
<span>  <span class="st">"TEMP"</span>,     <span class="fl">36.5</span>,   <span class="fl">37.5</span>,    <span class="fl">35</span>,    <span class="fl">38</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign AVALCATx</span></span>
<span><span class="va">avalcax_lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">PARAMCD</span>,  <span class="op">~</span><span class="va">condition</span>,  <span class="op">~</span><span class="va">AVALCAT1</span>, <span class="op">~</span><span class="va">AVALCA1N</span>,</span>
<span>  <span class="st">"HEIGHT"</span>,  <span class="va">AVAL</span> <span class="op">&gt;</span> <span class="fl">100</span>,  <span class="st">"&gt;100 cm"</span>,         <span class="fl">1</span>,</span>
<span>  <span class="st">"HEIGHT"</span>, <span class="va">AVAL</span> <span class="op">&lt;=</span> <span class="fl">100</span>, <span class="st">"&lt;=100 cm"</span>,         <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derivations ----</span></span>
<span></span>
<span><span class="co"># Get list of ADSL vars required for derivations</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">TRT01A</span>, <span class="va">TRT01P</span><span class="op">)</span></span>
<span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">vs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join ADSL with VS (need TRTSDT for ADY derivation)</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ADT, ADY ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">VSDTC</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="va">TRTSDT</span>, source_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Add PARAMCD only - add PARAM etc later ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged_lookup.html">derive_vars_merged_lookup</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">param_lookup</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">VSTESTCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate AVAL and AVALC ----</span></span>
<span>  <span class="co"># AVALC should only be mapped if it contains non-redundant information.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># AVALC = VSSTRESC,</span></span>
<span>    AVAL <span class="op">=</span> <span class="va">VSSTRESN</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Derive new parameters based on existing records ----</span></span>
<span>  <span class="co"># Note that, for the following three `derive_param_*()` functions, only the</span></span>
<span>  <span class="co"># variables specified in `by_vars` will be populated in the newly created</span></span>
<span>  <span class="co"># records.</span></span>
<span></span>
<span>  <span class="co"># Derive Mean Arterial Pressure</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_map.html">derive_param_map</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">ADT</span>, <span class="va">ADY</span>, <span class="va">VSTPT</span>, <span class="va">VSTPTNUM</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"MAP"</span><span class="op">)</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="va">VSSTRESU</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">VSSTAT</span> <span class="op">!=</span> <span class="st">"NOT DONE"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">VSSTAT</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Body Surface Area</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_bsa.html">derive_param_bsa</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">ADT</span>, <span class="va">ADY</span>, <span class="va">VSTPT</span>, <span class="va">VSTPTNUM</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"Mosteller"</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"BSA"</span><span class="op">)</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="va">VSSTRESU</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">VSSTAT</span> <span class="op">!=</span> <span class="st">"NOT DONE"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">VSSTAT</span><span class="op">)</span>,</span>
<span>    constant_by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Body Mass Index</span></span>
<span>  <span class="fu"><a href="../reference/derive_param_bmi.html">derive_param_bmi</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">VISIT</span>, <span class="va">VISITNUM</span>, <span class="va">ADT</span>, <span class="va">ADY</span>, <span class="va">VSTPT</span>, <span class="va">VSTPTNUM</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span>PARAMCD <span class="op">=</span> <span class="st">"BMI"</span><span class="op">)</span>,</span>
<span>    get_unit_expr <span class="op">=</span> <span class="va">VSSTRESU</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">VSSTAT</span> <span class="op">!=</span> <span class="st">"NOT DONE"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">VSSTAT</span><span class="op">)</span>,</span>
<span>    constant_by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Get visit info ----</span></span>
<span><span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span><span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#visits)</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive Timing</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ATPTN <span class="op">=</span> <span class="va">VSTPTNUM</span>,</span>
<span>    ATPT <span class="op">=</span> <span class="va">VSTPT</span>,</span>
<span>    AVISIT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">VISIT</span>, <span class="st">"SCREEN|UNSCHED|RETRIEVAL|AMBUL"</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA_character_</span>,</span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html" class="external-link">str_to_title</a></span><span class="op">(</span><span class="va">VISIT</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AVISITN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">VISIT</span> <span class="op">==</span> <span class="st">"BASELINE"</span> <span class="op">~</span> <span class="st">"0"</span>,</span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">VISIT</span>, <span class="st">"WEEK"</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_trim</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace</a></span><span class="op">(</span><span class="va">VISIT</span>, <span class="st">"WEEK"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive a new record as a summary record (e.g. mean of the triplicates at each time point) ----</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_summary_records.html">derive_summary_records</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">advs</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">adsl_vars</span>, <span class="va">PARAMCD</span>, <span class="va">AVISITN</span>, <span class="va">AVISIT</span>, <span class="va">ADT</span>, <span class="va">ADY</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      AVAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"AVERAGE"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Calculate ONTRTFL ----</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_ontrtfl.html">derive_var_ontrtfl</a></span><span class="op">(</span></span>
<span>    start_date <span class="op">=</span> <span class="va">ADT</span>,</span>
<span>    ref_start_date <span class="op">=</span> <span class="va">TRTSDT</span>,</span>
<span>    ref_end_date <span class="op">=</span> <span class="va">TRTEDT</span>,</span>
<span>    filter_pre_timepoint <span class="op">=</span> <span class="va">AVISIT</span> <span class="op">==</span> <span class="st">"Baseline"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Calculate ANRIND : requires the reference ranges ANRLO, ANRHI ----</span></span>
<span><span class="co"># Also accommodates the ranges A1LO, A1HI</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span>dataset_add <span class="op">=</span> <span class="va">range_lookup</span>, by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ANRIND</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_anrind.html">derive_var_anrind</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive baseline flags ----</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASETYPE</span></span>
<span>  <span class="fu"><a href="../reference/derive_basetype_records.html">derive_basetype_records</a></span><span class="op">(</span></span>
<span>    basetypes <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      <span class="st">"LAST: AFTER LYING DOWN FOR 5 MINUTES"</span> <span class="op">=</span> <span class="va">ATPTN</span> <span class="op">==</span> <span class="fl">815</span>,</span>
<span>      <span class="st">"LAST: AFTER STANDING FOR 1 MINUTE"</span> <span class="op">=</span> <span class="va">ATPTN</span> <span class="op">==</span> <span class="fl">816</span>,</span>
<span>      <span class="st">"LAST: AFTER STANDING FOR 3 MINUTES"</span> <span class="op">=</span> <span class="va">ATPTN</span> <span class="op">==</span> <span class="fl">817</span>,</span>
<span>      <span class="st">"LAST"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ATPTN</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ABLFL</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">BASETYPE</span>, <span class="va">PARAMCD</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">VISITNUM</span>, <span class="va">VSSEQ</span><span class="op">)</span>,</span>
<span>      new_var <span class="op">=</span> <span class="va">ABLFL</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVAL</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>      <span class="va">ADT</span> <span class="op">&lt;=</span> <span class="va">TRTSDT</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">BASETYPE</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DTYPE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Derive baseline information ----</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASE</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">AVAL</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BASE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate BASEC</span></span>
<span>  <span class="co"># only if AVALC is mapped</span></span>
<span>  <span class="co"># derive_var_base(</span></span>
<span>  <span class="co">#   by_vars = exprs(STUDYID, USUBJID, PARAMCD, BASETYPE),</span></span>
<span>  <span class="co">#   source_var = AVALC,</span></span>
<span>  <span class="co">#   new_var = BASEC</span></span>
<span>  <span class="co"># ) %&gt;%</span></span>
<span>  <span class="co"># Calculate BNRIND</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_base.html">derive_var_base</a></span><span class="op">(</span></span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">BASETYPE</span><span class="op">)</span>,</span>
<span>    source_var <span class="op">=</span> <span class="va">ANRIND</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">BNRIND</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate CHG for post-baseline records</span></span>
<span>  <span class="co"># The decision on how to populate pre-baseline and baseline values of CHG is left to producer choice</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_chg</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">AVISITN</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate PCHG for post-baseline records</span></span>
<span>  <span class="co"># The decision on how to populate pre-baseline and baseline values of PCHG is left to producer choice</span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_pchg</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">AVISITN</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## ANL01FL: Flag last result within an AVISIT and ATPT for post-baseline records ----</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/restrict_derivation.html">restrict_derivation</a></span><span class="op">(</span></span>
<span>    derivation <span class="op">=</span> <span class="va">derive_var_extreme_flag</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="../reference/params.html">params</a></span><span class="op">(</span></span>
<span>      new_var <span class="op">=</span> <span class="va">ANL01FL</span>,</span>
<span>      by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">AVISIT</span>, <span class="va">ATPT</span>, <span class="va">DTYPE</span><span class="op">)</span>,</span>
<span>      order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">AVAL</span><span class="op">)</span>,</span>
<span>      mode <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AVISITN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ONTRTFL</span> <span class="op">==</span> <span class="st">"Y"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Get treatment information ----</span></span>
<span><span class="co"># See also the "Visit and Period Variables" vignette</span></span>
<span><span class="co"># (https://pharmaverse.github.io/admiral/cran-release/articles/visits_periods.html#treatment_bds)</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Assign TRTA, TRTP</span></span>
<span>  <span class="co"># Create End of Treatment Record</span></span>
<span>  <span class="fu"><a href="../reference/derive_extreme_records.html">derive_extreme_records</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">advs</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">PARAMCD</span>, <span class="va">ATPTN</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">ADT</span>, <span class="va">AVISITN</span>, <span class="va">AVAL</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="fl">4</span> <span class="op">&lt;</span> <span class="va">AVISITN</span> <span class="op">&amp;</span> <span class="va">AVISITN</span> <span class="op">&lt;=</span> <span class="fl">13</span> <span class="op">&amp;</span> <span class="va">ANL01FL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DTYPE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    set_values_to <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span></span>
<span>      AVISIT <span class="op">=</span> <span class="st">"End of Treatment"</span>,</span>
<span>      AVISITN <span class="op">=</span> <span class="fl">99</span>,</span>
<span>      DTYPE <span class="op">=</span> <span class="st">"LOV"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    TRTP <span class="op">=</span> <span class="va">TRT01P</span>,</span>
<span>    TRTA <span class="op">=</span> <span class="va">TRT01A</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Get ASEQ and AVALCATx and add PARAM/PARAMN ----</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Calculate ASEQ</span></span>
<span>  <span class="fu"><a href="../reference/derive_var_obs_number.html">derive_var_obs_number</a></span><span class="op">(</span></span>
<span>    new_var <span class="op">=</span> <span class="va">ASEQ</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span>, <span class="va">ADT</span>, <span class="va">AVISITN</span>, <span class="va">VISITNUM</span>, <span class="va">ATPTN</span>, <span class="va">DTYPE</span><span class="op">)</span>,</span>
<span>    check_type <span class="op">=</span> <span class="st">"error"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Define condition and categories using derive_vars_cat</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_cat.html">derive_vars_cat</a></span><span class="op">(</span></span>
<span>    definition <span class="op">=</span> <span class="va">avalcax_lookup</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Derive PARAM and PARAMN</span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span>dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">param_lookup</span>, <span class="op">-</span><span class="va">VSTESTCD</span><span class="op">)</span>, by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Add all ADSL variables</span></span>
<span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">advs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/negate_vars.html">negate_vars</a></span><span class="op">(</span><span class="va">adsl_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="../reference/reexport-exprs.html">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Final Steps, Select final variables and Add labels</span></span>
<span><span class="co"># This process will be based on your metadata, no example given for this reason</span></span>
<span><span class="co"># ...</span></span>
<span></span>
<span><span class="co"># Save output ----</span></span>
<span></span>
<span><span class="co"># Change to whichever directory you want to save the dataset in</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"admiral_templates_data"</span>, which <span class="op">=</span> <span class="st">"cache"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create the folder</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">advs</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"advs.rda"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"bzip2"</span><span class="op">)</span></span></code></pre>
</details>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by F. Hoffmann-La Roche AG, GlaxoSmithKline LLC, Ben Straub, Stefan Bundfuss, Matt Bearham, Arianna Cascone, Kristin Dahnert, Jeffrey Dickinson, Ross Farrugia, Fanny Gautier, Edoardo Mancini, Gordon Miller, Lina Patil, Jim Rothstein.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
